<!DOCTYPE html>
<html lang="en-US">

<!-- Mirrored from www.twilio.com/blog/2016/06/real-time-rails-4-using-server-sent-events-with-authy-onetouch.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 22:10:06 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<script type="text/javascript">
(function() {
    var projectId = 3524915770;
    var protocol = ('https:' == document.location.protocol ?
    'https://' : 'http://');
    var scriptTag = document.createElement('script');
    scriptTag.type = 'text/javascript';
    scriptTag.async = true;
    scriptTag.src = protocol + 'cdn.optimizely.com/js/' +
    projectId + '.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(scriptTag, s);
})();
function optimizelyTimeout() {
    window.optimizely = window.optimizely|| [];
    if (!window.optimizely.data) {
    window.optimizely.push("timeout");
    }
}
setTimeout(optimizelyTimeout, 1000);
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="profile" href="http://gmpg.org/xfn/11">
<link rel="pingback" href="https://www.twilio.com/blog/xmlrpc.php">
<script type="text/javascript">
var _elqQ = _elqQ || [];
_elqQ.push(['elqSetSiteId', '815114181']);
_elqQ.push(['elqTrackPageView']);
_elqQ.push(['elqUseFirstPartyCookie', 'www.twilio.com']);
(function () {
  function async_load()
  {
    var s = document.createElement('script'); s.type = 'text/javascript'; s.async = true;
    s.src = 'http://img03.en25.com/i/elqCfg.min.js';
    var x = document.getElementsByTagName('script')[0]; x.parentNode.insertBefore(s, x);
  }
  if (window.addEventListener) window.addEventListener('DOMContentLoaded', async_load, false);
  else if (window.attachEvent) window.attachEvent('onload', async_load);
})();
</script>
<!-- Facebook Pixel Code -->
<script>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
document,'script','http://connect.facebook.net/en_US/fbevents.js');

fbq('init', '467131150158811');
fbq('track', "PageView");</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=467131150158811&amp;ev=PageView&amp;noscript=1"
/></noscript>
<!-- End Facebook Pixel Code -->

<style>
@media screen and (max-width: 600px) {
  #signal-header { display: none; }
}
</style>

<link type="text/css" media="all" href="https://www.twilio.com/blog/wp-content/cache/autoptimize/css/autoptimize_7a2cc50131d932d32297f43c61de37cd.css" rel="stylesheet" /><link type="text/css" media="screen" href="https://www.twilio.com/blog/wp-content/cache/autoptimize/css/autoptimize_97ca666341cd9b69002e26c8f2ca5299.css" rel="stylesheet" /><title>Real Time Rails 4: Using Server-Sent Events with Authy OneTouch &#8211; Twilio Cloud Communications Blog</title>

<!-- This site is optimized with the Yoast WordPress SEO plugin v1.4.13 - http://yoast.com/wordpress/seo/ -->
<link rel="canonical" href="https://www.twilio.com/blog/2016/06/real-time-rails-4-using-server-sent-events-with-authy-onetouch.html" />
<!-- / Yoast WordPress SEO plugin. -->

<link rel='dns-prefetch' href='https://www.twilio.com/blog//s0.wp.com' />
<link rel='dns-prefetch' href='https://www.twilio.com/blog//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="Twilio Cloud Communications Blog &raquo; Feed" href="https://www.twilio.com/blog/feed" />
<link rel="alternate" type="application/rss+xml" title="Twilio Cloud Communications Blog &raquo; Comments Feed" href="https://www.twilio.com/blog/comments/feed" />
<link rel="alternate" type="application/rss+xml" title="Twilio Cloud Communications Blog &raquo; Real Time Rails 4: Using Server-Sent Events with Authy OneTouch Comments Feed" href="https://www.twilio.com/blog/2016/06/real-time-rails-4-using-server-sent-events-with-authy-onetouch.html/feed" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/twilioinc.wpengine.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.6.2"}};
			!function(a,b,c){function d(a){var c,d,e,f,g,h=b.createElement("canvas"),i=h.getContext&&h.getContext("2d"),j=String.fromCharCode;if(!i||!i.fillText)return!1;switch(i.textBaseline="top",i.font="600 32px Arial",a){case"flag":return i.fillText(j(55356,56806,55356,56826),0,0),!(h.toDataURL().length<3e3)&&(i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,65039,8205,55356,57096),0,0),c=h.toDataURL(),i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,55356,57096),0,0),d=h.toDataURL(),c!==d);case"diversity":return i.fillText(j(55356,57221),0,0),e=i.getImageData(16,16,1,1).data,f=e[0]+","+e[1]+","+e[2]+","+e[3],i.fillText(j(55356,57221,55356,57343),0,0),e=i.getImageData(16,16,1,1).data,g=e[0]+","+e[1]+","+e[2]+","+e[3],f!==g;case"simple":return i.fillText(j(55357,56835),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode8":return i.fillText(j(55356,57135),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode9":return i.fillText(j(55358,56631),0,0),0!==i.getImageData(16,16,1,1).data[0]}return!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i;for(i=Array("simple","flag","unicode8","diversity","unicode9"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>










<!-- This site uses the Google Analytics by Yoast plugin v5.4.7 - Universal enabled - https://yoast.com/wordpress/plugins/google-analytics/ -->
<script type="text/javascript">
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','http://www.google-analytics.com/analytics.js','__gaTracker');

	__gaTracker('create', 'UA-2900316-1', 'auto');
	__gaTracker('set', 'forceSSL', true);
	 window.optimizely = window.optimizely || [];
 window.optimizely.push("activateUniversalAnalytics");
	__gaTracker('set', 'dimension4', 'Phil Nash');
	__gaTracker('set', 'dimension5', 'post');
	__gaTracker('set', 'dimension6', 'all-things-code');
	__gaTracker('set', 'dimension7', '2FA,Authy,Authy OneTouch,OneTouch,rails,Rails 4,real-time,Ruby,Ruby on Rails,two factor authentication');
	__gaTracker('set', 'dimension8', '2016-06-13T09:49:58+00:00');
	__gaTracker('send','pageview');

</script>
<!-- / Google Analytics by Yoast -->


<script type='text/javascript'>
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"2.4.3","is_admin":"0","ajaxurl":"https:\/\/twilioinc.wpengine.com\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>

<script type='text/javascript'>
/* <![CDATA[ */
var swiftypeParams = {"engineKey":"UpGyyJZzgUMXHM65YENj"};
/* ]]> */
</script>

<link rel='https://api.w.org/' href='https://www.twilio.com/blog/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://www.twilio.com/blog/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://www.twilio.com/blog/wp-includes/wlwmanifest.xml" /> 
<link rel='shortlink' href='https://www.twilio.com/blog/?p=18082' />
<link rel="alternate" type="application/json+oembed" href="https://www.twilio.com/blog/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fwww.twilio.com%2Fblog%2F2016%2F06%2Freal-time-rails-4-using-server-sent-events-with-authy-onetouch.html" />
<link rel="alternate" type="text/xml+oembed" href="https://www.twilio.com/blog/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fwww.twilio.com%2Fblog%2F2016%2F06%2Freal-time-rails-4-using-server-sent-events-with-authy-onetouch.html&amp;format=xml" />
<link rel="icon" href="https://www.twilio.com/blog/wp-content/uploads/2015/09/cropped-favicon_1141-32x32.png" sizes="32x32" />
<link rel="icon" href="https://www.twilio.com/blog/wp-content/uploads/2015/09/cropped-favicon_1141-192x192.png" sizes="192x192" />
<link rel="apple-touch-icon-precomposed" href="https://www.twilio.com/blog/wp-content/uploads/2015/09/cropped-favicon_1141-180x180.png" />
<meta name="msapplication-TileImage" content="https://www.twilio.com/blog/wp-content/uploads/2015/09/cropped-favicon_1141-270x270.png" />
</head>

<body class="single single-post postid-18082 single-format-standard group-blog">
<!-- Google Tag Manager -->
<noscript><iframe src="https://www.twilio.com/blog//www.googletagmanager.com/ns.html?id=GTM-W4RVXH"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'http://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-W4RVXH');</script>
<!-- End Google Tag Manager -->

<div id="fb-root"></div>
<script>(function(d, s, id) {
		var js, fjs = d.getElementsByTagName(s)[0];
		if (d.getElementById(id)) return;
		js = d.createElement(s); js.id = id;
		js.src = "http://connect.facebook.net/en_US/sdk.js#xfbml=1&appId=414254592083321&version=v2.0";
		fjs.parentNode.insertBefore(js, fjs);
	}(document, 'script', 'facebook-jssdk'));
window.fbAsyncInit = function() {
  FB.Event.subscribe('edge.create', function(targetUrl) {
    __gaTracker('send', 'social', 'facebook', 'like', targetUrl);
  });
};
window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));

function trackTwitter(intent_event) {
  if (intent_event) {
    var opt_pagePath;
    if (intent_event.target && intent_event.target.nodeName == 'IFRAME') {
          opt_target = extractParamFromUri(intent_event.target.src, 'url');
    }
    __gaTracker('send', 'social', 'twitter', 'tweet', opt_pagePath);
  }
}

function extractParamFromUri(uri, paramName) {
  if (!uri) {
    return;
  }
  var regex = new RegExp('[\\?&#]' + paramName + '=([^&#]*)');
  var params = regex.exec(uri);
  if (params != null) {
    return unescape(params[1]);
  }
  return;
}

//Wrap event bindings - Wait for async js to load
twttr.ready(function (twttr) {
  //event bindings
  twttr.events.bind('tweet', trackTwitter);
});
</script>
<script type="text/javascript">
  window.heap=window.heap||[],heap.load=function(e,t){window.heap.appid=e,window.heap.config=t=t||{};var n=t.forceSSL||"https:"===document.location.protocol,a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=(n?"https:":"http:")+"//cdn.heapanalytics.com/js/heap-"+e+".js";var o=document.getElementsByTagName("script")[0];o.parentNode.insertBefore(a,o);for(var r=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},p=["clearEventProperties","identify","setEventProperties","track","unsetEventProperty"],c=0;c<p.length;c++)heap[p[c]]=r(p[c])};
  heap.load("1541905715");
</script>
<div id="page" class="hfeed site">
	<a class="skip-link screen-reader-text" href="#content">Skip to content</a>

	<nav class="navbar navbar-default" role="navigation">
		<div class="container">
			<!-- Brand and toggle get grouped for better mobile display -->
			<div class="navbar-header">
				<button type="button" class="navbar-toggle hidden-xs" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="https://www.twilio.com/blog/">
					<img src="https://s3.amazonaws.com/ahoy-assets.twilio.com/global/images/wordmark.svg" width="200"> <span class="logo-blog">blog</span>
				</a>
			</div>

			<div class="hidden-xs"><ul id="menu-site-navigation" class="nav navbar-nav pull-right"><li id="menu-item-12202" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12202"><a href="http://www.twilio.com/" onclick="__gaTracker('send', 'event', 'outbound-widget', 'http://www.twilio.com/', 'Home');" title="Home">Home</a></li>
<li id="menu-item-12205" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12205"><a href="http://www.twilio.com/blog" onclick="__gaTracker('send', 'event', 'outbound-widget', 'http://www.twilio.com/blog', 'Blog');" title="Blog">Blog</a></li>
<li id="menu-item-12204" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12204"><a href="https://www.twilio.com/docs/howto" onclick="__gaTracker('send', 'event', 'outbound-widget', 'https://www.twilio.com/docs/howto', 'Tutorials');" title="Tutorials">Tutorials</a></li>
<li id="menu-item-12206" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12206"><a href="https://www.twilio.com/docs/api" onclick="__gaTracker('send', 'event', 'outbound-widget', 'https://www.twilio.com/docs/api', 'Docs');" title="Docs">Docs</a></li>
<li id="menu-item-12207" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12207"><a href="http://www.twilio.com/help" onclick="__gaTracker('send', 'event', 'outbound-widget', 'http://www.twilio.com/help', 'Help');" title="Help">Help</a></li>
<li id="menu-item-12208" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12208"><a href="https://www.twilio.com/login" onclick="__gaTracker('send', 'event', 'outbound-widget', 'https://www.twilio.com/login', 'Login');" title="Login">Login</a></li>
<li id="menu-item-12209" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12209"><a href="https://www.twilio.com/try-twilio" onclick="__gaTracker('send', 'event', 'outbound-widget', 'https://www.twilio.com/try-twilio', 'Signup');" title="Signup">Signup</a></li>
</ul></div>		</div>
	</nav>

	<div id="content" class="site-content container">
		<div class="row">

	<div id="primary" class="content-area col-md-9">
		<main id="main" class="site-main" role="main">

		
			
<article id="post-18082" class="row post-18082 post type-post status-publish format-standard has-post-thumbnail hentry category-all-things-code tag-2fa tag-authy tag-authy-onetouch tag-onetouch tag-rails tag-rails-4 tag-real-time tag-ruby tag-ruby-on-rails tag-two-factor-authentication">
	<header class="entry-header col-md-12">
		<h2 class="entry-title">Real Time Rails 4: Using Server-Sent Events with Authy OneTouch</h2>
						<div class="entry-image col-md-12">
        <img width="640" height="260" src="https://www.twilio.com/blog/wp-content/uploads/2016/06/header.png" class="img-responsive wp-post-image" alt="" srcset="https://www.twilio.com/blog/wp-content/uploads/2016/06/header.png 640w, https://www.twilio.com/blog/wp-content/uploads/2016/06/header-300x122.png 300w, https://www.twilio.com/blog/wp-content/uploads/2016/06/header-200x81.png 200w" sizes="(max-width: 640px) 100vw, 640px" />			</div>
      <div class="clear"></div>
			
		<footer class="entry-footer">
			<div class="entry-meta">
					<div class="row">
	<div class="col-md-6">
	<span class="byline"> by <span class="author vcard"><a class="url fn n" href="https://www.twilio.com/blog/author/phil">Phil Nash</a></span></span> on <span class="posted-on"><a href="https://www.twilio.com/blog/2016/06/real-time-rails-4-using-server-sent-events-with-authy-onetouch.html" rel="bookmark"><time class="entry-date published" datetime="2016-06-13T09:49:58+00:00">June 13, 2016</time><time class="updated" datetime="2016-06-17T20:16:55+00:00">June 17, 2016</time></a></span>	</div>
	<div class="col-md-6">
		<div class="social-buttons">
			<div class="fb-like" data-href="https://www.twilio.com/blog/2016/06/real-time-rails-4-using-server-sent-events-with-authy-onetouch.html" data-layout="button" data-action="like" data-show-faces="false" data-share="false"></div>
			<a href="https://twitter.com/share" class="twitter-share-button" data-via="twilio" data-count="none" data-url="https://www.twilio.com/blog/2016/06/real-time-rails-4-using-server-sent-events-with-authy-onetouch.html" data-text="Real Time Rails 4: Using Server-Sent Events with Authy OneTouch ">Tweet</a>
      <a href="https://twitter.com/twilio" class="twitter-follow-button" data-show-count="false">Follow @twilio</a>
		</div>
	</div>
	</div>
			</div><!-- .entry-meta -->
		</footer><!-- .entry-footer -->
	</header><!-- .entry-header -->

	<div class="entry-content col-md-12">
		<div class="row">
			<div class="col-md-12">
				<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events', 'Server-Sent Events');">Server-Sent Events</a> (SSE) are real-time events sent from a server and received by a browser, perfect for updating the front end when a server receives a webhook. We&#8217;re going to look at how to use SSE to implement <a href="https://www.authy.com/product/options/#onetouch" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://www.authy.com/product/options/#onetouch', 'Authy OneTouch');">Authy OneTouch</a> using Rails 4. </p>
<p>Our end result should look a bit like this:</p>
<p><img alt="When logging in the site pops up a modal window that says it is waiting for OneTouch approval. The phone receives a push notification which opens up the approval. Selecting approve then causes the login screen to complete and the user to be logged in." src="https://www.twilio.com/blog/wp-content/uploads/2016/06/hBJ07CTnXjWD7nmmUbLwfV03cgRkIz1lzhXku6qihi-itKTlhIWFr7PnPJAURR27wjz8gIAZ7p-W_H4a6SrsmTS5nAm6mZEdubVW7MyM-3RRudASKtKjak7PJqqs_y3EZeQ8Krs.png" class="aligncenter"></p>
<h3 id="h.2gzopm3pde1z">Authy OneTouch</h3>
<p>Two factor authentication usually means copying a bunch of numbers from your phone to the place you&#8217;re trying to log in. <a href="https://www.authy.com/product/options/#onetouch" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://www.authy.com/product/options/#onetouch', 'Authy OneTouch');">Authy OneTouch</a> is a more user friendly version of two factor authentication. As you can see above, the user just needs to accept the authentication attempt and they are logged in.</p>
<p>On the back end Authy sends a webhook to the application with the result of the authentication request. The application can then log the user in and choose how it updates the front end. Check out our <a href="https://www.twilio.com/docs/tutorials/walkthrough/two-factor-authentication/ruby/rails" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://www.twilio.com/docs/tutorials/walkthrough/two-factor-authentication/ruby/rails', 'tutorial on how to get started with Authy OneTouch and Rails');">tutorial on how to get started with Authy OneTouch and Rails</a> for more detail on how it all works.</p>
<h3 id="h.z60aq8bzkiyo">Real-Time Rails 4?</h3>
<p>You might be thinking that Rails 5 is <em>finally</em> bringing real-time action to the Ruby world with <a href="https://github.com/rails/rails/tree/master/actioncable" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://github.com/rails/rails/tree/master/actioncable', 'Action Cable');">Action Cable</a>. If you are then you probably missed that Rails 4 included <code>ActionController::Live</code>, a means of streaming data from a Rails in real-time. Connect this up to the <code>EventSource</code> API in browsers and we have a full implementation of Server-Sent Events that we can use to send data from the server to the browser in real-time.</p>
<p>The tutorial for Authy that I mentioned earlier actually implements the OneTouch flow by polling the server for updates. As polling can be inefficient and result in many unnecessary requests to our server let&#8217;s replace it with SSE.</p>
<h3 id="h.f7dfm6equl5u">Tools</h3>
<p>To follow this post and implement SSE in Rails you&#8217;re going to need a few things:</p>
<ul>
<li>
<a href="https://www.ruby-lang.org/en/" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://www.ruby-lang.org/en/', 'Ruby');">Ruby</a> and <a href="http://bundler.io/" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://bundler.io/', 'Bundler');">Bundler</a> installed
</li>
<li>
<a href="https://www.postgresql.org/" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://www.postgresql.org/', 'PostgreSQL');">PostgreSQL</a>, we&#8217;re going to be using the publish-subscribe feature to trigger events
</li>
<li>
<a href="https://ngrok.com/" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://ngrok.com/', 'ngrok');">ngrok</a>, to help us <a href="https://www.twilio.com/blog/2015/09/6-awesome-reasons-to-use-ngrok-when-testing-webhooks.html" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://www.twilio.com/blog/2015/09/6-awesome-reasons-to-use-ngrok-when-testing-webhooks.html', 'test webhooks to our locally running application');">test webhooks to our locally running application</a>
</li>
<li>
A Twilio account so that you can get an Authy API key, <a href="https://www.twilio.com/try-twilio" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://www.twilio.com/try-twilio', 'sign up for free here');">sign up for free here</a>
</li>
<li>
A smartphone with the Authy app so that you can use OneTouch, you can download it for <a href="https://itunes.apple.com/en/app/authy/id494168017?mt=8" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://itunes.apple.com/en/app/authy/id494168017?mt=8', 'iOS');">iOS</a> or <a href="https://play.google.com/store/apps/details?id=com.authy.authy&amp;hl=en" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://play.google.com/store/apps/details?id=com.authy.authy&amp;hl=en', 'Android');">Android</a>
</li>
<li>
A browser other than Internet Explorer/Edge, which doesn&#8217;t yet support SSE but <a href="https://github.com/remy/polyfills/blob/master/EventSource.js" onclick="__gaTracker('send', 'event', 'download', 'https://github.com/remy/polyfills/blob/master/EventSource.js');">can be polyfilled</a>
</li>
</ul>
<p>Once you&#8217;ve got all that we&#8217;ll get the tutorial application set up.</p>
<h3 id="h.7s0q0xtyyev0">Getting started</h3>
<p>The best instructions for running the tutorial are available in the <a href="https://github.com/TwilioDevEd/authy2fa-rails/blob/master/README.md" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://github.com/TwilioDevEd/authy2fa-rails/blob/master/README.md', 'project README');">project README</a>. Follow the instructions all the way through until the application is running locally, you have enabled OneTouch on your Authy application and set the webhook endpoint to your ngrok URL.</p>
<p>Once you&#8217;ve followed the instructions you should be able to visit your application at <a href="http://localhost:3000/" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://localhost:3000/', 'http://localhost:3000/');">http://localhost:3000</a> and sign up as a new user. Logout and log back in again and you will be presented with the following two factor authentication flow.</p>
<p><img alt="When logging in the site pops up a modal window that says it is waiting for OneTouch approval. The phone receives a push notification which opens up the approval. Selecting approve then causes the login screen to complete and the user to be logged in." src="https://www.twilio.com/blog/wp-content/uploads/2016/06/hBJ07CTnXjWD7nmmUbLwfV03cgRkIz1lzhXku6qihi-itKTlhIWFr7PnPJAURR27wjz8gIAZ7p-W_H4a6SrsmTS5nAm6mZEdubVW7MyM-3RRudASKtKjak7PJqqs_y3EZeQ8Krs.png" class="aligncenter"></p>
<p>You can see in the console that the JavaScript is constantly polling our backend to see if the user is authenticated yet.</p>
<p><img alt="While the application waits for the user to approve the authentication request it polls the server once every 2 seconds which we see in the logs." src="https://www.twilio.com/blog/wp-content/uploads/2016/06/tpjInmeYCTveqZR0rA3aUIQzoshDlnETspq8RaU22OOu9AlsY_DYly6cviOoKhb-spvvLyCcR62flnel97jhkUGGEBeJfdUYvCwM6maGnhT5iXzGnHg-mBYYwd67zS9OUQbzztk.png" class="aligncenter"></p>
<p>Let&#8217;s replace that polling mechanism with Server-Sent Events.</p>
<h3 id="h.nw53g23scrp3">Adding Server-Sent Events</h3>
<p>In order to run real-time features like SSE (and Action Cable when Rails 5 is released) it is recommended to use a threaded server, like <a href="http://puma.io/" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://puma.io/', 'Puma');">Puma</a>. The project currently uses <a href="https://unicorn.bogomips.org/" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://unicorn.bogomips.org/', 'Unicorn');">Unicorn</a> so we need to update that.</p>
<p>Open up the <code>Gemfile</code> and change</p>
<p></p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794ffe2eb9e491570215" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">Ruby</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
gem 'unicorn'</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794ffe2eb9e491570215-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794ffe2eb9e491570215-1"><span class="crayon-i">gem</span><span class="crayon-h"> </span><span class="crayon-s">'unicorn'</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0015 seconds] -->
<p></p>
<p>to </p>
<p></p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794ffe2ebb3864984732" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">Ruby</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
gem 'puma'</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794ffe2ebb3864984732-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794ffe2ebb3864984732-1"><span class="crayon-i">gem</span><span class="crayon-h"> </span><span class="crayon-s">'puma'</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->
<p></p>
<p>Stop your server and install the new dependency.</p>
<p></p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794ffe2ebc1155196241" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
$ bundle install</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794ffe2ebc1155196241-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794ffe2ebc1155196241-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">bundle </span><span class="crayon-i">install</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->
<p></p>
<p>We also need to make one change to <code>config/environments/development.rb</code>. At the bottom of the <code>configure</code> block, add:</p>
<p></p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794ffe2ebd4348570516" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">Ruby</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
  config.allow_concurrency = true</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794ffe2ebd4348570516-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794ffe2ebd4348570516-1"> <span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">allow_concurrency</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">true</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->
<p></p>
<p>This allows concurrency in the development environment so that we can run our streaming endpoint and still respond to other incoming requests.</p>
<p>Start the server up again and you will see it is now running on Puma and has access to a number of threads. You can configure the minimum and maximum available threads if you want to, but for the purposes of this project, the default will do.</p>
<p><img alt="Now when you start the server it boots Puma and records the current thread configuration." src="https://www.twilio.com/blog/wp-content/uploads/2016/06/llCRqeCgIh63-nbICTqFGPK8PsdPlBadix2biNoOFi_wmq79WlKoKHu2w9pI133syirCGoLOw1CCXiZWGNZEzH642egCYfQdzBE0uxOROUDtcINDFciWeOWSVrkITclzW0MxYJ4.png" class="aligncenter"></p>
<h4 id="h.e8yl3b7mgff">Updating the controller</h4>
<p>Next, we need to set up a streaming endpoint on our Rails server. Enable streaming capabilities for the existing controller by opening <code>app/controllers/authy_controller.rb</code> and including the <code>ActionController::Live</code> module.</p>
<p></p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794ffe2ebe6672700437" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">Ruby</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
# app/controllers/authy_controller.rb

class AuthyController &lt; ApplicationController
  include ActionController::Live

  # the rest of the controller
end</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794ffe2ebe6672700437-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ebe6672700437-2">2</div><div class="crayon-num" data-line="crayon-58794ffe2ebe6672700437-3">3</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom crayon-striped-num" data-line="crayon-58794ffe2ebe6672700437-4">4</div><div class="crayon-num" data-line="crayon-58794ffe2ebe6672700437-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ebe6672700437-6">6</div><div class="crayon-num" data-line="crayon-58794ffe2ebe6672700437-7">7</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794ffe2ebe6672700437-1"><span class="crayon-c"># app/controllers/authy_controller.rb</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ebe6672700437-2">&nbsp;</div><div class="crayon-line" id="crayon-58794ffe2ebe6672700437-3"><span class="crayon-r">class</span><span class="crayon-h"> </span><span class="crayon-i">AuthyController</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-i">ApplicationController</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom crayon-striped-line" id="crayon-58794ffe2ebe6672700437-4"> <span class="crayon-h"> </span><span class="crayon-i">include</span><span class="crayon-h"> </span><span class="crayon-i">ActionController</span><span class="crayon-o">::</span><span class="crayon-i">Live</span></div><div class="crayon-line" id="crayon-58794ffe2ebe6672700437-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ebe6672700437-6"> <span class="crayon-h"> </span><span class="crayon-c"># the rest of the controller</span></div><div class="crayon-line" id="crayon-58794ffe2ebe6672700437-7"><span class="crayon-st">end</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0016 seconds] -->
<p></p>
<p>Now let&#8217;s create a test endpoint to see how it works.</p>
<p>Under the <code>one_touch_status</code> action, create a <code>one_touch_status_live</code> action:</p>
<p></p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794ffe2ebf7704323811" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">Ruby</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
# app/controllers/authy_controller.rb

class AuthyController &lt; ApplicationController
  def one_touch_status_live
    response.headers['Content-Type'] = 'text/event-stream'
    sse = SSE.new(response.stream, event: 'time')
    # stream stuff here
  end
end</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794ffe2ebf7704323811-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ebf7704323811-2">2</div><div class="crayon-num" data-line="crayon-58794ffe2ebf7704323811-3">3</div><div class="crayon-num crayon-marked-num crayon-top crayon-striped-num" data-line="crayon-58794ffe2ebf7704323811-4">4</div><div class="crayon-num crayon-marked-num" data-line="crayon-58794ffe2ebf7704323811-5">5</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-58794ffe2ebf7704323811-6">6</div><div class="crayon-num crayon-marked-num" data-line="crayon-58794ffe2ebf7704323811-7">7</div><div class="crayon-num crayon-marked-num crayon-bottom crayon-striped-num" data-line="crayon-58794ffe2ebf7704323811-8">8</div><div class="crayon-num" data-line="crayon-58794ffe2ebf7704323811-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794ffe2ebf7704323811-1"><span class="crayon-c"># app/controllers/authy_controller.rb</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ebf7704323811-2">&nbsp;</div><div class="crayon-line" id="crayon-58794ffe2ebf7704323811-3"><span class="crayon-r">class</span><span class="crayon-h"> </span><span class="crayon-i">AuthyController</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-i">ApplicationController</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-striped-line" id="crayon-58794ffe2ebf7704323811-4"> <span class="crayon-h"> </span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-i">one_touch_status_live</span></div><div class="crayon-line crayon-marked-line" id="crayon-58794ffe2ebf7704323811-5"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-v">headers</span><span class="crayon-sy">[</span><span class="crayon-s">'Content-Type'</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'text/event-stream'</span></div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-58794ffe2ebf7704323811-6"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">sse</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">SSE</span><span class="crayon-sy">.</span><span class="crayon-e">new</span><span class="crayon-sy">(</span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-i">stream</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">event</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">'time'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-marked-line" id="crayon-58794ffe2ebf7704323811-7"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-c"># stream stuff here</span></div><div class="crayon-line crayon-marked-line crayon-bottom crayon-striped-line" id="crayon-58794ffe2ebf7704323811-8"> <span class="crayon-h"> </span><span class="crayon-st">end</span></div><div class="crayon-line" id="crayon-58794ffe2ebf7704323811-9"><span class="crayon-st">end</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0035 seconds] -->
<p></p>
<p>We start by setting the <code>Content-Type</code> header to <code>text/event-stream</code>. Then we use the <code><a href="http://api.rubyonrails.org/classes/ActionController/Live/SSE.html" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://api.rubyonrails.org/classes/ActionController/Live/SSE.html', 'ActionController::Live::SSE');">ActionController::Live::SSE</a></code> class to wrap the response stream to make it easy to write events to.</p>
<p>For our test endpoint let&#8217;s loop and emit the current time once a second.</p>
<p></p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794ffe2ec08717809000" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">Ruby</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
# app/controllers/authy_controller.rb

class AuthyController &lt; ApplicationController
  def one_touch_status_live
    response.headers['Content-Type'] = 'text/event-stream'
    sse = SSE.new(response.stream, event: 'time')
    loop do
      sse.write({ :time =&gt; Time.now })
      sleep 1
    end
  end
end</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794ffe2ec08717809000-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec08717809000-2">2</div><div class="crayon-num" data-line="crayon-58794ffe2ec08717809000-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec08717809000-4">4</div><div class="crayon-num" data-line="crayon-58794ffe2ec08717809000-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec08717809000-6">6</div><div class="crayon-num crayon-marked-num crayon-top" data-line="crayon-58794ffe2ec08717809000-7">7</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-58794ffe2ec08717809000-8">8</div><div class="crayon-num crayon-marked-num" data-line="crayon-58794ffe2ec08717809000-9">9</div><div class="crayon-num crayon-marked-num crayon-bottom crayon-striped-num" data-line="crayon-58794ffe2ec08717809000-10">10</div><div class="crayon-num" data-line="crayon-58794ffe2ec08717809000-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec08717809000-12">12</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794ffe2ec08717809000-1"><span class="crayon-c"># app/controllers/authy_controller.rb</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec08717809000-2">&nbsp;</div><div class="crayon-line" id="crayon-58794ffe2ec08717809000-3"><span class="crayon-r">class</span><span class="crayon-h"> </span><span class="crayon-i">AuthyController</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-i">ApplicationController</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec08717809000-4"> <span class="crayon-h"> </span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-i">one_touch_status_live</span></div><div class="crayon-line" id="crayon-58794ffe2ec08717809000-5"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-v">headers</span><span class="crayon-sy">[</span><span class="crayon-s">'Content-Type'</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'text/event-stream'</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec08717809000-6"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">sse</span><span class="crayon-h"> </span><span class="crayon-o">=</span> <span class="crayon-v">SSE</span><span class="crayon-sy">.</span><span class="crayon-e">new</span><span class="crayon-sy">(</span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-i">stream</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">event</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">'time'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-marked-line crayon-top" id="crayon-58794ffe2ec08717809000-7"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">loop</span><span class="crayon-h"> </span><span class="crayon-st">do</span></div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-58794ffe2ec08717809000-8"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">sse</span><span class="crayon-sy">.</span><span class="crayon-e">write</span><span class="crayon-sy">(</span><span class="crayon-k ">{</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-t">time</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-t">Time</span><span class="crayon-sy">.</span><span class="crayon-i">now</span><span class="crayon-h"> </span><span class="crayon-k ">}</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-marked-line" id="crayon-58794ffe2ec08717809000-9"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-i">sleep</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-marked-line crayon-bottom crayon-striped-line" id="crayon-58794ffe2ec08717809000-10"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">end</span></div><div class="crayon-line" id="crayon-58794ffe2ec08717809000-11"> <span class="crayon-h"> </span><span class="crayon-st">end</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec08717809000-12"><span class="crayon-st">end</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0054 seconds] -->
<p></p>
<p>When the client disconnects the action will continue to try to send data to the client resulting in a <code>ActionController::Live::ClientDisconnected</code> error. We should catch that and close the stream in order to keep the error from being raised and prevent connections from leaking. We&#8217;ll put this inside an ensure block to make sure that whatever happens we close the stream.</p>
<p></p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794ffe2ec18510362349" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">Ruby</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
# app/controllers/authy_controller.rb

class AuthyController &lt; ApplicationController
  def one_touch_status_live
    response.headers['Content-Type'] = 'text/event-stream'
    sse = SSE.new(response.stream, event: 'time')
    begin
      loop do
        sse.write({ :time =&gt; Time.now })
        sleep 1
      end
    rescue ClientDisconnected
    ensure
      sse.close
    end
  end
end</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794ffe2ec18510362349-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec18510362349-2">2</div><div class="crayon-num" data-line="crayon-58794ffe2ec18510362349-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec18510362349-4">4</div><div class="crayon-num" data-line="crayon-58794ffe2ec18510362349-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec18510362349-6">6</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom" data-line="crayon-58794ffe2ec18510362349-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec18510362349-8">8</div><div class="crayon-num" data-line="crayon-58794ffe2ec18510362349-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec18510362349-10">10</div><div class="crayon-num" data-line="crayon-58794ffe2ec18510362349-11">11</div><div class="crayon-num crayon-marked-num crayon-top crayon-striped-num" data-line="crayon-58794ffe2ec18510362349-12">12</div><div class="crayon-num crayon-marked-num" data-line="crayon-58794ffe2ec18510362349-13">13</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-58794ffe2ec18510362349-14">14</div><div class="crayon-num crayon-marked-num crayon-bottom" data-line="crayon-58794ffe2ec18510362349-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec18510362349-16">16</div><div class="crayon-num" data-line="crayon-58794ffe2ec18510362349-17">17</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794ffe2ec18510362349-1"><span class="crayon-c"># app/controllers/authy_controller.rb</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec18510362349-2">&nbsp;</div><div class="crayon-line" id="crayon-58794ffe2ec18510362349-3"><span class="crayon-r">class</span><span class="crayon-h"> </span><span class="crayon-i">AuthyController</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-i">ApplicationController</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec18510362349-4"> <span class="crayon-h"> </span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-i">one_touch_status_live</span></div><div class="crayon-line" id="crayon-58794ffe2ec18510362349-5"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-v">headers</span><span class="crayon-sy">[</span><span class="crayon-s">'Content-Type'</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'text/event-stream'</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec18510362349-6"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">sse</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">SSE</span><span class="crayon-sy">.</span><span class="crayon-e">new</span><span class="crayon-sy">(</span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-i">stream</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">event</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">'time'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom" id="crayon-58794ffe2ec18510362349-7"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">begin</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec18510362349-8"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">loop</span><span class="crayon-h"> </span><span class="crayon-st">do</span></div><div class="crayon-line" id="crayon-58794ffe2ec18510362349-9"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">sse</span><span class="crayon-sy">.</span><span class="crayon-e">write</span><span class="crayon-sy">(</span><span class="crayon-k ">{</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-t">time</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-t">Time</span><span class="crayon-sy">.</span><span class="crayon-i">now</span><span class="crayon-h"> </span><span class="crayon-k ">}</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec18510362349-10"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-i">sleep</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line" id="crayon-58794ffe2ec18510362349-11"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">end</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-striped-line" id="crayon-58794ffe2ec18510362349-12"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">rescue</span><span class="crayon-h"> </span><span class="crayon-i">ClientDisconnected</span></div><div class="crayon-line crayon-marked-line" id="crayon-58794ffe2ec18510362349-13"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">ensure</span></div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-58794ffe2ec18510362349-14"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">sse</span><span class="crayon-sy">.</span><span class="crayon-i">close</span></div><div class="crayon-line crayon-marked-line crayon-bottom" id="crayon-58794ffe2ec18510362349-15"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">end</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec18510362349-16"> <span class="crayon-h"> </span><span class="crayon-st">end</span></div><div class="crayon-line" id="crayon-58794ffe2ec18510362349-17"><span class="crayon-st">end</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0068 seconds] -->
<p></p>
<p>Let&#8217;s add a route for this endpoint. Open up <code>config/routes.rb</code> and add the following route:</p>
<p></p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794ffe2ec26882834564" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">Ruby</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
# config/routes.rb

Rails.application.routes.draw do
  # other routes

  get "authy/status" =&gt; 'authy#one_touch_status'
  get "authy/live_status" =&gt; 'authy#one_touch_status_live'
  post "authy/send_token"

  # other routes
end</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794ffe2ec26882834564-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec26882834564-2">2</div><div class="crayon-num" data-line="crayon-58794ffe2ec26882834564-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec26882834564-4">4</div><div class="crayon-num" data-line="crayon-58794ffe2ec26882834564-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec26882834564-6">6</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom" data-line="crayon-58794ffe2ec26882834564-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec26882834564-8">8</div><div class="crayon-num" data-line="crayon-58794ffe2ec26882834564-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec26882834564-10">10</div><div class="crayon-num" data-line="crayon-58794ffe2ec26882834564-11">11</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794ffe2ec26882834564-1"><span class="crayon-c"># config/routes.rb</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec26882834564-2">&nbsp;</div><div class="crayon-line" id="crayon-58794ffe2ec26882834564-3"><span class="crayon-v">Rails</span><span class="crayon-sy">.</span><span class="crayon-v">application</span><span class="crayon-sy">.</span><span class="crayon-v">routes</span><span class="crayon-sy">.</span><span class="crayon-i">draw</span><span class="crayon-h"> </span><span class="crayon-st">do</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec26882834564-4"> <span class="crayon-h"> </span><span class="crayon-c"># other routes</span></div><div class="crayon-line" id="crayon-58794ffe2ec26882834564-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec26882834564-6"> <span class="crayon-h"> </span><span class="crayon-i">get</span><span class="crayon-h"> </span><span class="crayon-s">"authy/status"</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-s">'authy#one_touch_status'</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom" id="crayon-58794ffe2ec26882834564-7"> <span class="crayon-h"> </span><span class="crayon-i">get</span><span class="crayon-h"> </span><span class="crayon-s">"authy/live_status"</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-s">'authy#one_touch_status_live'</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec26882834564-8"> <span class="crayon-h"> </span><span class="crayon-i">post</span><span class="crayon-h"> </span><span class="crayon-s">"authy/send_token"</span></div><div class="crayon-line" id="crayon-58794ffe2ec26882834564-9">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec26882834564-10"> <span class="crayon-h"> </span><span class="crayon-c"># other routes</span></div><div class="crayon-line" id="crayon-58794ffe2ec26882834564-11"><span class="crayon-st">end</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0027 seconds] -->
<p></p>
<p>Head back to the application at <a href="http://localhost:3000/" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://localhost:3000/', 'http://localhost:3000/');">http://localhost:3000</a>, open up the dev tools console in your browser and paste in the following:</p>
<p></p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794ffe2ec35130159268" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
var source = new EventSource('/authy/live_status');
source.addEventListener('time', function(event) {
  console.log(event.data);
});</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794ffe2ec35130159268-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec35130159268-2">2</div><div class="crayon-num" data-line="crayon-58794ffe2ec35130159268-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec35130159268-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794ffe2ec35130159268-1"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">source</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">EventSource</span><span class="crayon-sy">(</span><span class="crayon-s">'/authy/live_status'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec35130159268-2"><span class="crayon-v">source</span><span class="crayon-sy">.</span><span class="crayon-e">addEventListener</span><span class="crayon-sy">(</span><span class="crayon-s">'time'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">event</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794ffe2ec35130159268-3"> <span class="crayon-h"> </span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-v">event</span><span class="crayon-sy">.</span><span class="crayon-i">data</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec35130159268-4"><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0028 seconds] -->
<p></p>
<p>You will start to see JSON objects printed to the console once per second. Stop the stream by closing it in the console with:</p>
<p></p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794ffe2ec44049833532" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
source.close();</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794ffe2ec44049833532-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794ffe2ec44049833532-1"><span class="crayon-v">source</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->
<p></p>
<p><img alt="When you run the JavaScript in the dev tools console you see time objects printing out once per second." src="https://www.twilio.com/blog/wp-content/uploads/2016/06/ydPRSM2N77oSAVeXP5DGEx5y4ICfi8edM2PYFlu4WidhEPiCJEc5rL4E-7kSZN0w_uNtkhQ0vGpDWQ6SVG8e-PGJunxSZP4QjIkknX4PWTt_Q-dwfoRTNun4swg5NBwj27bwbv0.png" class="aligncenter"></p>
<p>Let&#8217;s update this now to push real data from the server to the front end.</p>
<h4 id="h.eq3gdags1v94">Pushing real data with PostgreSQL pub-sub</h4>
<p>In the tutorial application when a user approves or denies the authentication request, the Authy webhook hits the <code>/authy/callback</code> endpoint which runs the <code>callback</code> action in the <code>AuthyController</code>. This then updates the user with the status from the parameter of the webhook. </p>
<p>In order to push that status to the client we&#8217;d like to listen for that update whilst we have a live connection open to our streaming endpoint. Because we are using PostgreSQL in this example we can use its publish-subscribe feature. If you are using a different database without pub-sub you could achieve the same result by using something else like Redis to fill the gap.</p>
<p>PostgreSQL uses the keywords <code><a href="https://www.postgresql.org/docs/9.1/static/sql-notify.html" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://www.postgresql.org/docs/9.1/static/sql-notify.html', 'NOTIFY');">NOTIFY</a></code> and <code><a href="https://www.postgresql.org/docs/9.1/static/sql-listen.html" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://www.postgresql.org/docs/9.1/static/sql-listen.html', 'LISTEN');">LISTEN</a></code> to publish and subscribe to events respectively. Active Record doesn&#8217;t directly support these keywords, but we can execute them using the database connection anyway.</p>
<p>We&#8217;ll add the notification code to the <code>User</code> model so open up <code>app/models/user.rb</code>. First, we want to send a notification when the user is saved and their <code>authy_status</code> has changed.</p>
<p></p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794ffe2ec54611977520" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">Ruby</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
# app/models/user.rb

class User &lt; ActiveRecord::Base
  def notify_authy_status_change
    if authy_status_changed?
      ActiveRecord::Base.connection_pool.with_connection do |connection|
        execute_query(connection, ["NOTIFY user_?, ?", id, authy_status])
      end
    end
  end
end</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794ffe2ec54611977520-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec54611977520-2">2</div><div class="crayon-num" data-line="crayon-58794ffe2ec54611977520-3">3</div><div class="crayon-num crayon-marked-num crayon-top crayon-striped-num" data-line="crayon-58794ffe2ec54611977520-4">4</div><div class="crayon-num crayon-marked-num" data-line="crayon-58794ffe2ec54611977520-5">5</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-58794ffe2ec54611977520-6">6</div><div class="crayon-num crayon-marked-num" data-line="crayon-58794ffe2ec54611977520-7">7</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-58794ffe2ec54611977520-8">8</div><div class="crayon-num crayon-marked-num" data-line="crayon-58794ffe2ec54611977520-9">9</div><div class="crayon-num crayon-marked-num crayon-bottom crayon-striped-num" data-line="crayon-58794ffe2ec54611977520-10">10</div><div class="crayon-num" data-line="crayon-58794ffe2ec54611977520-11">11</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794ffe2ec54611977520-1"><span class="crayon-c"># app/models/user.rb</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec54611977520-2">&nbsp;</div><div class="crayon-line" id="crayon-58794ffe2ec54611977520-3"><span class="crayon-r">class</span><span class="crayon-h"> </span><span class="crayon-i">User</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-i">ActiveRecord</span><span class="crayon-o">::</span><span class="crayon-i">Base</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-striped-line" id="crayon-58794ffe2ec54611977520-4"> <span class="crayon-h"> </span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-i">notify_authy_status_change</span></div><div class="crayon-line crayon-marked-line" id="crayon-58794ffe2ec54611977520-5"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-i">authy_status_changed</span><span class="crayon-sy">?</span></div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-58794ffe2ec54611977520-6"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-i">ActiveRecord</span><span class="crayon-o">::</span><span class="crayon-v">Base</span><span class="crayon-sy">.</span><span class="crayon-v">connection_pool</span><span class="crayon-sy">.</span><span class="crayon-i">with_connection</span><span class="crayon-h"> </span><span class="crayon-st">do</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-i">connection</span><span class="crayon-o">|</span></div><div class="crayon-line crayon-marked-line" id="crayon-58794ffe2ec54611977520-7"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-e">execute_query</span><span class="crayon-sy">(</span><span class="crayon-i">connection</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">"NOTIFY user_?, ?"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">authy_status</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-58794ffe2ec54611977520-8"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">end</span></div><div class="crayon-line crayon-marked-line" id="crayon-58794ffe2ec54611977520-9"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">end</span></div><div class="crayon-line crayon-marked-line crayon-bottom crayon-striped-line" id="crayon-58794ffe2ec54611977520-10"> <span class="crayon-h"> </span><span class="crayon-st">end</span></div><div class="crayon-line" id="crayon-58794ffe2ec54611977520-11"><span class="crayon-st">end</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0044 seconds] -->
<p></p>
<p><code>NOTIFY</code> takes two arguments, a channel to notify and some text to send to that channel. We use the user id in the channel name to only send the notification to listeners subscribed to this particular user. We then send the updated status, which will come through as either &#8220;approved&#8221; or &#8220;denied&#8221;.</p>
<p>Because we&#8217;re using a raw connection to the database and executing SQL, I&#8217;ve actually added a couple of methods to sanitise and execute the SQL. Active Record has a <code>santize_sql</code> method, however it is a protected class method. I&#8217;ve made that available to instances via the <code>clean_sql</code> method. The private method <code>execute_query</code> handles sanitising and executing the SQL to reduce repetition.</p>
<p></p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794ffe2ec64274514908" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">Ruby</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
# app/models/user.rb

class User &lt; ActiveRecord::Base
  def self.clean_sql(query)
    sanitize_sql(query)
  end

  private

  def execute_query(connection, query)
    sql = self.class.clean_sql(query)
    connection.execute(sql)
  end
end</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794ffe2ec64274514908-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec64274514908-2">2</div><div class="crayon-num" data-line="crayon-58794ffe2ec64274514908-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec64274514908-4">4</div><div class="crayon-num" data-line="crayon-58794ffe2ec64274514908-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec64274514908-6">6</div><div class="crayon-num" data-line="crayon-58794ffe2ec64274514908-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec64274514908-8">8</div><div class="crayon-num" data-line="crayon-58794ffe2ec64274514908-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec64274514908-10">10</div><div class="crayon-num" data-line="crayon-58794ffe2ec64274514908-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec64274514908-12">12</div><div class="crayon-num" data-line="crayon-58794ffe2ec64274514908-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec64274514908-14">14</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794ffe2ec64274514908-1"><span class="crayon-c"># app/models/user.rb</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec64274514908-2">&nbsp;</div><div class="crayon-line" id="crayon-58794ffe2ec64274514908-3"><span class="crayon-r">class</span><span class="crayon-h"> </span><span class="crayon-i">User</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-i">ActiveRecord</span><span class="crayon-o">::</span><span class="crayon-i">Base</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec64274514908-4"> <span class="crayon-h"> </span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">clean_sql</span><span class="crayon-sy">(</span><span class="crayon-i">query</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-58794ffe2ec64274514908-5"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-e">sanitize_sql</span><span class="crayon-sy">(</span><span class="crayon-i">query</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec64274514908-6"> <span class="crayon-h"> </span><span class="crayon-st">end</span></div><div class="crayon-line" id="crayon-58794ffe2ec64274514908-7">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec64274514908-8"> <span class="crayon-h"> </span><span class="crayon-m">private</span></div><div class="crayon-line" id="crayon-58794ffe2ec64274514908-9">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec64274514908-10"> <span class="crayon-h"> </span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">execute_query</span><span class="crayon-sy">(</span><span class="crayon-i">connection</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">query</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-58794ffe2ec64274514908-11"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">sql</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-r">class</span><span class="crayon-sy">.</span><span class="crayon-e">clean_sql</span><span class="crayon-sy">(</span><span class="crayon-i">query</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec64274514908-12"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">connection</span><span class="crayon-sy">.</span><span class="crayon-e">execute</span><span class="crayon-sy">(</span><span class="crayon-i">sql</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-58794ffe2ec64274514908-13"> <span class="crayon-h"> </span><span class="crayon-st">end</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec64274514908-14"><span class="crayon-st">end</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0044 seconds] -->
<p></p>
<p>We can run the notification method every time the user model is saved using an Active Record callback.</p>
<p></p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794ffe2ec74106071694" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">Ruby</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
# app/models/user.rb

class User &lt; ActiveRecord::Base
  after_save :notify_authy_status_change
end</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794ffe2ec74106071694-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec74106071694-2">2</div><div class="crayon-num" data-line="crayon-58794ffe2ec74106071694-3">3</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom crayon-striped-num" data-line="crayon-58794ffe2ec74106071694-4">4</div><div class="crayon-num" data-line="crayon-58794ffe2ec74106071694-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794ffe2ec74106071694-1"><span class="crayon-c"># app/models/user.rb</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec74106071694-2">&nbsp;</div><div class="crayon-line" id="crayon-58794ffe2ec74106071694-3"><span class="crayon-r">class</span><span class="crayon-h"> </span><span class="crayon-i">User</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-i">ActiveRecord</span><span class="crayon-o">::</span><span class="crayon-i">Base</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom crayon-striped-line" id="crayon-58794ffe2ec74106071694-4"> <span class="crayon-h"> </span><span class="crayon-i">after_save</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-i">notify_authy_status_change</span></div><div class="crayon-line" id="crayon-58794ffe2ec74106071694-5"><span class="crayon-st">end</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0015 seconds] -->
<p></p>
<p>Now we need a method to subscribe to the user channel and listen for these notifications.</p>
<p></p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794ffe2ec82764755354" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">Ruby</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
# app/models/user.rb

class User &lt; ActiveRecord::Base
  def on_authy_status_change
    ActiveRecord::Base.connection_pool.with_connection do |connection|
      begin
        execute_query(connection, ["LISTEN user_?", id])
        connection.raw_connection.wait_for_notify do |event, pid, status|
          yield status
        end
      ensure
        execute_query(connection, ["UNLISTEN user_?", id])
      end
    end
  end
end</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794ffe2ec82764755354-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec82764755354-2">2</div><div class="crayon-num" data-line="crayon-58794ffe2ec82764755354-3">3</div><div class="crayon-num crayon-marked-num crayon-top crayon-striped-num" data-line="crayon-58794ffe2ec82764755354-4">4</div><div class="crayon-num crayon-marked-num" data-line="crayon-58794ffe2ec82764755354-5">5</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-58794ffe2ec82764755354-6">6</div><div class="crayon-num crayon-marked-num" data-line="crayon-58794ffe2ec82764755354-7">7</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-58794ffe2ec82764755354-8">8</div><div class="crayon-num crayon-marked-num" data-line="crayon-58794ffe2ec82764755354-9">9</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-58794ffe2ec82764755354-10">10</div><div class="crayon-num crayon-marked-num" data-line="crayon-58794ffe2ec82764755354-11">11</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-58794ffe2ec82764755354-12">12</div><div class="crayon-num crayon-marked-num" data-line="crayon-58794ffe2ec82764755354-13">13</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-58794ffe2ec82764755354-14">14</div><div class="crayon-num crayon-marked-num crayon-bottom" data-line="crayon-58794ffe2ec82764755354-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec82764755354-16">16</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794ffe2ec82764755354-1"><span class="crayon-c"># app/models/user.rb</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec82764755354-2">&nbsp;</div><div class="crayon-line" id="crayon-58794ffe2ec82764755354-3"><span class="crayon-r">class</span><span class="crayon-h"> </span><span class="crayon-i">User</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-i">ActiveRecord</span><span class="crayon-o">::</span><span class="crayon-i">Base</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-striped-line" id="crayon-58794ffe2ec82764755354-4"> <span class="crayon-h"> </span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-i">on_authy_status_change</span></div><div class="crayon-line crayon-marked-line" id="crayon-58794ffe2ec82764755354-5"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-i">ActiveRecord</span><span class="crayon-o">::</span><span class="crayon-v">Base</span><span class="crayon-sy">.</span><span class="crayon-v">connection_pool</span><span class="crayon-sy">.</span><span class="crayon-i">with_connection</span><span class="crayon-h"> </span><span class="crayon-st">do</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-i">connection</span><span class="crayon-o">|</span></div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-58794ffe2ec82764755354-6"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">begin</span></div><div class="crayon-line crayon-marked-line" id="crayon-58794ffe2ec82764755354-7"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-e">execute_query</span><span class="crayon-sy">(</span><span class="crayon-i">connection</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">"LISTEN user_?"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">id</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-58794ffe2ec82764755354-8"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">connection</span><span class="crayon-sy">.</span><span class="crayon-v">raw_connection</span><span class="crayon-sy">.</span><span class="crayon-i">wait_for_notify</span><span class="crayon-h"> </span><span class="crayon-st">do</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-i">event</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">pid</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">status</span><span class="crayon-o">|</span></div><div class="crayon-line crayon-marked-line" id="crayon-58794ffe2ec82764755354-9"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-r">yield</span><span class="crayon-h"> </span><span class="crayon-i">status</span></div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-58794ffe2ec82764755354-10"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">end</span></div><div class="crayon-line crayon-marked-line" id="crayon-58794ffe2ec82764755354-11"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">ensure</span></div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-58794ffe2ec82764755354-12"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-e">execute_query</span><span class="crayon-sy">(</span><span class="crayon-i">connection</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">"UNLISTEN user_?"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">id</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-marked-line" id="crayon-58794ffe2ec82764755354-13"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">end</span></div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-58794ffe2ec82764755354-14"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">end</span></div><div class="crayon-line crayon-marked-line crayon-bottom" id="crayon-58794ffe2ec82764755354-15"> <span class="crayon-h"> </span><span class="crayon-st">end</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec82764755354-16"><span class="crayon-st">end</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0103 seconds] -->
<p></p>
<p>In this case, <code>LISTEN</code> only takes one argument, the channel name. We execute the SQL and then wait for the notification to arrive. When it does we yield the status. You&#8217;ll see how this works in the updated controller action below. We also ensure that we stop listening for the notification once it has arrived. Let&#8217;s see what the updated <code>AuthyController</code> looks like now:</p>
<p></p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794ffe2ec92396694912" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">Ruby</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
# app/controllers/authy_controller.rb

class AuthyController &lt; ApplicationController
  def one_touch_status_live
    response.headers['Content-Type'] = 'text/event-stream'
    @user = User.find(session[:pre_2fa_auth_user_id])
    sse = SSE.new(response.stream, event: "authy_status")
    begin
      @user.on_authy_status_change do |status|
        if status == "approved"
          session[:user_id] = @user.id
          session[:pre_2fa_auth_user_id] = nil
        end
        sse.write({status: status})
      end
    rescue ClientDisconnected
    ensure
      sse.close
    end
  end
end</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794ffe2ec92396694912-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec92396694912-2">2</div><div class="crayon-num" data-line="crayon-58794ffe2ec92396694912-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec92396694912-4">4</div><div class="crayon-num" data-line="crayon-58794ffe2ec92396694912-5">5</div><div class="crayon-num crayon-marked-num crayon-top crayon-striped-num" data-line="crayon-58794ffe2ec92396694912-6">6</div><div class="crayon-num crayon-marked-num crayon-bottom" data-line="crayon-58794ffe2ec92396694912-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec92396694912-8">8</div><div class="crayon-num crayon-marked-num crayon-top" data-line="crayon-58794ffe2ec92396694912-9">9</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-58794ffe2ec92396694912-10">10</div><div class="crayon-num crayon-marked-num" data-line="crayon-58794ffe2ec92396694912-11">11</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-58794ffe2ec92396694912-12">12</div><div class="crayon-num crayon-marked-num" data-line="crayon-58794ffe2ec92396694912-13">13</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-58794ffe2ec92396694912-14">14</div><div class="crayon-num crayon-marked-num crayon-bottom" data-line="crayon-58794ffe2ec92396694912-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec92396694912-16">16</div><div class="crayon-num" data-line="crayon-58794ffe2ec92396694912-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec92396694912-18">18</div><div class="crayon-num" data-line="crayon-58794ffe2ec92396694912-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2ec92396694912-20">20</div><div class="crayon-num" data-line="crayon-58794ffe2ec92396694912-21">21</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794ffe2ec92396694912-1"><span class="crayon-c"># app/controllers/authy_controller.rb</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec92396694912-2">&nbsp;</div><div class="crayon-line" id="crayon-58794ffe2ec92396694912-3"><span class="crayon-r">class</span><span class="crayon-h"> </span><span class="crayon-i">AuthyController</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-i">ApplicationController</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec92396694912-4"> <span class="crayon-h"> </span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-i">one_touch_status_live</span></div><div class="crayon-line" id="crayon-58794ffe2ec92396694912-5"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-v">headers</span><span class="crayon-sy">[</span><span class="crayon-s">'Content-Type'</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'text/event-stream'</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-striped-line" id="crayon-58794ffe2ec92396694912-6"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">@user</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">User</span><span class="crayon-sy">.</span><span class="crayon-e">find</span><span class="crayon-sy">(</span><span class="crayon-v">session</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-i">pre_2fa_auth_user_id</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-marked-line crayon-bottom" id="crayon-58794ffe2ec92396694912-7"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">sse</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">SSE</span><span class="crayon-sy">.</span><span class="crayon-e">new</span><span class="crayon-sy">(</span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-i">stream</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">event</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"authy_status"</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec92396694912-8"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">begin</span></div><div class="crayon-line crayon-marked-line crayon-top" id="crayon-58794ffe2ec92396694912-9"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">@user</span><span class="crayon-sy">.</span><span class="crayon-i">on_authy_status_change</span><span class="crayon-h"> </span><span class="crayon-st">do</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-i">status</span><span class="crayon-o">|</span></div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-58794ffe2ec92396694912-10"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">status</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"approved"</span></div><div class="crayon-line crayon-marked-line" id="crayon-58794ffe2ec92396694912-11"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">session</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-i">user_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">@user</span><span class="crayon-sy">.</span><span class="crayon-i">id</span></div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-58794ffe2ec92396694912-12"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">session</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-i">pre_2fa_auth_user_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">nil</span></div><div class="crayon-line crayon-marked-line" id="crayon-58794ffe2ec92396694912-13"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">end</span></div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-58794ffe2ec92396694912-14"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">sse</span><span class="crayon-sy">.</span><span class="crayon-e">write</span><span class="crayon-sy">(</span><span class="crayon-k ">{</span><span class="crayon-i">status</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-i">status</span><span class="crayon-k ">}</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-marked-line crayon-bottom" id="crayon-58794ffe2ec92396694912-15"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">end</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec92396694912-16"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">rescue</span><span class="crayon-h"> </span><span class="crayon-i">ClientDisconnected</span></div><div class="crayon-line" id="crayon-58794ffe2ec92396694912-17"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">ensure</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec92396694912-18"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">sse</span><span class="crayon-sy">.</span><span class="crayon-i">close</span></div><div class="crayon-line" id="crayon-58794ffe2ec92396694912-19"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">end</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2ec92396694912-20"> <span class="crayon-h"> </span><span class="crayon-st">end</span></div><div class="crayon-line" id="crayon-58794ffe2ec92396694912-21"><span class="crayon-st">end</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0104 seconds] -->
<p></p>
<p>This time, we select the user using the temporary session store of their ID. We then subscribe to changes to their <code>authy_status</code> and when we receive a change, push it to the front end. If the status is &#8220;approved&#8221; we also log the user in finally. As you can see here, we use a block with <code>on_authy_status_change</code> and when the status is <code>yield</code>ed in the user method, it is passed into the block.</p>
<p>All we need to do now is update our JavaScript to stop polling and start listening for updates.</p>
<h4 id="h.1dqbo3qrjh3z">Updating the JavaScript</h4>
<p>Open up <code>app/assets/javascripts/sessions.js</code> and replace the code within the <code>checkForOneTouch</code> function with the following:</p>
<p></p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794ffe2eca3963921132" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
// app/assets/javascripts/sessions.js

  var checkForOneTouch = function() {
    var source = new EventSource("/authy/live_status")
    source.addEventListener("authy_status", function(event) {
      var data = JSON.parse(event.data);
      if (data.status === "approved") {
        source.close();
        window.location.href = "/account";
      } else if (data.status === "denied") {
        showTokenForm();
        triggerSMSToken();
      }
    })
  };</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794ffe2eca3963921132-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2eca3963921132-2">2</div><div class="crayon-num" data-line="crayon-58794ffe2eca3963921132-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2eca3963921132-4">4</div><div class="crayon-num" data-line="crayon-58794ffe2eca3963921132-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2eca3963921132-6">6</div><div class="crayon-num" data-line="crayon-58794ffe2eca3963921132-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2eca3963921132-8">8</div><div class="crayon-num" data-line="crayon-58794ffe2eca3963921132-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2eca3963921132-10">10</div><div class="crayon-num" data-line="crayon-58794ffe2eca3963921132-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2eca3963921132-12">12</div><div class="crayon-num" data-line="crayon-58794ffe2eca3963921132-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794ffe2eca3963921132-14">14</div><div class="crayon-num" data-line="crayon-58794ffe2eca3963921132-15">15</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794ffe2eca3963921132-1"><span class="crayon-c">// app/assets/javascripts/sessions.js</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2eca3963921132-2">&nbsp;</div><div class="crayon-line" id="crayon-58794ffe2eca3963921132-3"> <span class="crayon-h"> </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">checkForOneTouch</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2eca3963921132-4"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">source</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">EventSource</span><span class="crayon-sy">(</span><span class="crayon-s">"/authy/live_status"</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-58794ffe2eca3963921132-5"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">source</span><span class="crayon-sy">.</span><span class="crayon-e">addEventListener</span><span class="crayon-sy">(</span><span class="crayon-s">"authy_status"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">event</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2eca3963921132-6"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">JSON</span><span class="crayon-sy">.</span><span class="crayon-e">parse</span><span class="crayon-sy">(</span><span class="crayon-v">event</span><span class="crayon-sy">.</span><span class="crayon-i">data</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794ffe2eca3963921132-7"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">status</span><span class="crayon-h"> </span><span class="crayon-o">===</span><span class="crayon-h"> </span><span class="crayon-s">"approved"</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2eca3963921132-8"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">source</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794ffe2eca3963921132-9"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-v">window</span><span class="crayon-sy">.</span><span class="crayon-v">location</span><span class="crayon-sy">.</span><span class="crayon-e ">href</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"/account"</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2eca3963921132-10"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">.</span><span class="crayon-v">status</span><span class="crayon-h"> </span><span class="crayon-o">===</span><span class="crayon-h"> </span><span class="crayon-s">"denied"</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794ffe2eca3963921132-11"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-e">showTokenForm</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2eca3963921132-12"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-e">triggerSMSToken</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794ffe2eca3963921132-13"> <span class="crayon-h"> </span> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794ffe2eca3963921132-14"> <span class="crayon-h"> </span> <span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-58794ffe2eca3963921132-15"> <span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0089 seconds] -->
<p>
<p>
We&#8217;re listening to our SSE for the &#8220;authy_status&#8221; event. When it arrives we parse the JSON and if the event is approved we close the stream and redirect the user to their account page. Otherwise we use the existing behaviour, show the token form and trigger an SMS.</p>
<p>Restart the server and go through the login process again (make sure ngrok is still running otherwise you won&#8217;t get your webhook).</p>
<p><img alt="We run the same authentication flow as before, however this time we see that there are no polling events in the log. We have successfully implemented Server-Sent Events." src="https://www.twilio.com/blog/wp-content/uploads/2016/06/8V6GG-piZZ8trlundlUCpbfwaxMyGh9Qf2xP6fpNpCUg9zqFNhtFeEoH4urBnM1AygchUd5836g6KSQfkWt2jiyfP_Wg9UFJTslq8h0Cm8SO9Yeqt01zoTgPy_AhUcw4uZpBQrw.png" class="aligncenter"></p>
<p>Hooray! Real-time updates to the front end, no polling required. Check out <a href="https://github.com/philnash/authy2fa-rails/tree/server-sent-events" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://github.com/philnash/authy2fa-rails/tree/server-sent-events', 'my fork');">my fork</a><a href="https://github.com/philnash/authy2fa-rails/tree/server-sent-events" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://github.com/philnash/authy2fa-rails/tree/server-sent-events', ' of the original tutorial');"> of the original tutorial</a> to see the <a href="https://github.com/TwilioDevEd/authy2fa-rails/compare/master...philnash:server-sent-events?expand=1" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://github.com/TwilioDevEd/authy2fa-rails/compare/master...philnash:server-sent-events?expand=1', 'complete changes');">complete changes</a>.</p>
<h3 id="h.9ltq00yvjk8a">Rails 4 does Real-Time</h3>
<p>Rails 5 and Action Cable might not be released just yet, but Rails 4 can still perform some pretty sweet real-time manoeuvres. This works really well for server based updates as we&#8217;ve seen with Authy OneTouch. It would also work for <a href="https://www.twilio.com/blog/2015/11/reactjs-tutorial-call-monitoring-with-react-express-and-socket-io.html" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://www.twilio.com/blog/2015/11/reactjs-tutorial-call-monitoring-with-react-express-and-socket-io.html', 'live updating call statuses on a dashboard like Sam showed using Socket.io and React');">live updating call statuses on a dashboard like Sam showed using Socket.io and React</a> or <a href="https://www.twilio.com/blog/2016/05/conference-call-monitoring-twilio.html" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://www.twilio.com/blog/2016/05/conference-call-monitoring-twilio.html', 'creating a dashboard for conference events like Dominik did using Socket.io and Angular');">creating a dashboard for conference events like Dominik did using Socket.io and Angular</a>.</p>
<p>Server-Sent Events just provide one-way real-time events though. Action Cable will bring two-way real-time streams to Rails for more complicated interactions, like a chat room. Of course, you don&#8217;t have to build all that complexity yourself if you use <a href="https://www.twilio.com/docs/api/ip-messaging" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://www.twilio.com/docs/api/ip-messaging', 'IP Messaging');">IP Messaging</a> ;)</p>
<p>Do you like the look of SSE in Rails or are you going to be holding out for Action Cable? Let me know in the comments below, give me a shout on Twitter at <a href="https://twitter.com/philnash" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://twitter.com/philnash', '@philnash');">@philnash</a> or drop me an email at <a href="mailto:philnash@twilio.com">philnash@twilio.com</a>.</p>
			</div>
					</div>
	</div><!-- .entry-content -->

	<footer class="entry-footer col-md-12">
		<div class="entry-meta">
					<div class="social-buttons">
			<div class="fb-like" data-href="https://www.twilio.com/blog/2016/06/real-time-rails-4-using-server-sent-events-with-authy-onetouch.html" data-layout="button" data-action="like" data-show-faces="false" data-share="false"></div>
			<a href="https://twitter.com/share" class="twitter-share-button" data-via="twilio" data-count="none" data-url="https://www.twilio.com/blog/2016/06/real-time-rails-4-using-server-sent-events-with-authy-onetouch.html" data-text="Real Time Rails 4: Using Server-Sent Events with Authy OneTouch ">Tweet</a>
      <a href="https://twitter.com/twilio" class="twitter-follow-button" data-show-count="false">Follow @twilio</a>
		</div>
<span class="author-avatar"><img alt='' src='https://secure.gravatar.com/avatar/79fac5826d02217e841fd2354db2ae37?s=20&amp;d=mm&amp;r=g' srcset='https://secure.gravatar.com/avatar/79fac5826d02217e841fd2354db2ae37?s=40&amp;d=mm&amp;r=g 2x' class='avatar avatar-20 photo' height='20' width='20' /></span><span class="byline"> by <span class="author vcard"><a class="url fn n" href="https://www.twilio.com/blog/author/phil">Phil Nash</a></span></span> <span class="author-meta author-email"><a href="mailto:pnash@twilio.com">pnash@twilio.com</a></span><span class="author-meta author-twitter"><a href="http://twitter.com/philnash">@philnash<a/></span>		</div>
	</footer><!-- .entry-footer -->

   <div class="build-more"><h3>Build More With Ruby</h3>        <a href="https://www.twilio.com/docs/tutorials/walkthrough/server-notifications/ruby/rails" onclick="__gaTracker('send', 'event', 'buildmore-widget', 'https://www.twilio.com/docs/tutorials/walkthrough/server-notifications/ruby/rails', '');">
          <h5>SMS and MMS Notifications with Ruby</h5>
        </a>
              <a href="https://www.twilio.com/blog/2015/01/twilio-on-rails-part-3-adding-contextual-voip-using-webrtc-to-your-rails-4-app.html" rel="bookmark" title="Permanent Link to Twilio on Rails Part 3 &#8211; Adding Contextual VOIP Using WebRTC to Your Rails 4 App" onclick="__gaTracker('send', 'event', 'buildmore-widget', 'https://www.twilio.com/blog/2015/01/twilio-on-rails-part-3-adding-contextual-voip-using-webrtc-to-your-rails-4-app.html', '');">
          <h5>Twilio on Rails Part 3 &#8211; Adding Contextual VOIP Using WebRTC to Your Rails 4 App<h4>
        </a>
                <a href="https://www.twilio.com/blog/2015/02/managing-development-environment-variables-across-multiple-ruby-applications.html" rel="bookmark" title="Permanent Link to Managing Development Environment Variables Across Multiple Ruby Applications" onclick="__gaTracker('send', 'event', 'buildmore-widget', 'https://www.twilio.com/blog/2015/02/managing-development-environment-variables-across-multiple-ruby-applications.html', '');">
          <h5>Managing Development Environment Variables Across Multiple Ruby Applications<h4>
        </a>
                <a href="https://www.twilio.com/blog/2015/02/note-taking-on-the-go-with-evernote-and-twilio-part-one.html" rel="bookmark" title="Permanent Link to Note Taking On the Go With Evernote and Twilio &#8211; Part One" onclick="__gaTracker('send', 'event', 'buildmore-widget', 'https://www.twilio.com/blog/2015/02/note-taking-on-the-go-with-evernote-and-twilio-part-one.html', '');">
          <h5>Note Taking On the Go With Evernote and Twilio &#8211; Part One<h4>
        </a>
        </div>
</article><!-- #post-## -->

			
<div id="disqus_thread">
    </div>

<script type="text/javascript">
/* <![CDATA[ */
    var disqus_url = 'https://www.twilio.com/blog/2016/06/real-time-rails-4-using-server-sent-events-with-authy-onetouch.html';
    var disqus_identifier = 'https://www.twilio.com/blog/2016/06/18082 https://www.twilio.com/blog/?p=18082';
    var disqus_container_id = 'disqus_thread';
    var disqus_domain = 'disqus.com';
    var disqus_shortname = 'twilioblog';
    var disqus_title = "Real Time Rails 4: Using Server-Sent Events with Authy OneTouch";
        var disqus_config = function () {
        var config = this; // Access to the config object
        config.language = '';

        /*
           All currently supported events:
            * preData — fires just before we request for initial data
            * preInit - fires after we get initial data but before we load any dependencies
            * onInit  - fires when all dependencies are resolved but before dtpl template is rendered
            * afterRender - fires when template is rendered but before we show it
            * onReady - everything is done
         */

        config.callbacks.preData.push(function() {
            // clear out the container (its filled for SEO/legacy purposes)
            document.getElementById(disqus_container_id).innerHTML = '';
        });
                config.callbacks.onReady.push(function() {
            // sync comments in the background so we don't block the page
            var script = document.createElement('script');
            script.async = true;
            script.src = 'https://www.twilio.com/blog/2016/06/real-time-rails-4-using-server-sent-events-with-authy-onetouch.html?cf_action=sync_comments&amp;post_id=18082';

            var firstScript = document.getElementsByTagName( "script" )[0];
            firstScript.parentNode.insertBefore(script, firstScript);
        });
                    };
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
    var DsqLocal = {
        'trackbacks': [
        ],
        'trackback_url': "https:\/\/www.twilio.com\/blog\/2016\/06\/real-time-rails-4-using-server-sent-events-with-authy-onetouch.html\/trackback"    };
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.' + 'disqus.com' + '/embed.js?pname=wordpress&pver=2.74';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
/* ]]> */
</script>

		
		</main><!-- #main -->
	</div><!-- #primary -->


<div id="secondary" class="widget-area col-md-3 hide-xs" role="complementary">
	<aside id="search-2" class="widget widget_search"><form role="search" method="get" class="search-form" action="https://www.twilio.com/blog/">
				<label>
					<span class="screen-reader-text">Search for:</span>
					<input type="search" class="search-field" placeholder="Search &hellip;" value="" name="s" />
				</label>
				<input type="submit" class="search-submit" value="Search" />
			</form></aside><aside id="text-2" class="widget widget_text">			<div class="textwidget"><p>Power modern communications. Build the next generation of voice and SMS applications.</p>

 <a href="http://twilio.com/try-twilio" onclick="__gaTracker('send', 'event', 'outbound-widget', 'http://twilio.com/try-twilio', 'Start Building For Free');" class="btn">Start Building For Free</a></div>
		</aside><style scoped type="text/css">.utcw-8ngloje {word-wrap:break-word}.utcw-8ngloje span,.utcw-8ngloje a{border-style:solid;border-width:1px}.utcw-8ngloje span:hover,.utcw-8ngloje a:hover{border-style:solid;border-width:1px}</style><aside id="utcw-2" class="widget widget_utcw widget_tag_cloud"><h1 class="widget-title">Posts By Stack</h1><div class="utcw-8ngloje tagcloud"><a class="tag-link-22 utcw-tag utcw-tag-net" href="https://www.twilio.com/blog/tag/net" style="font-size:16px" title="40 topics">.NET</a> <a class="tag-link-98 utcw-tag utcw-tag-arduino" href="https://www.twilio.com/blog/tag/arduino" style="font-size:16px" title="21 topics">Arduino</a> <a class="tag-link-598 utcw-tag utcw-tag-java" href="https://www.twilio.com/blog/tag/java" style="font-size:16px" title="14 topics">Java</a> <a class="tag-link-600 utcw-tag utcw-tag-javascript" href="https://www.twilio.com/blog/tag/javascript" style="font-size:16px" title="86 topics">JavaScript</a> <a class="tag-link-847 utcw-tag utcw-tag-php" href="https://www.twilio.com/blog/tag/php" style="font-size:16px" title="57 topics">PHP</a> <a class="tag-link-891 utcw-tag utcw-tag-python" href="https://www.twilio.com/blog/tag/python" style="font-size:16px" title="72 topics">Python</a> <a class="tag-link-969 utcw-tag utcw-tag-ruby" href="https://www.twilio.com/blog/tag/ruby" style="font-size:16px" title="69 topics">Ruby</a> <a class="tag-link-2856 utcw-tag utcw-tag-swift" href="https://www.twilio.com/blog/tag/swift" style="font-size:16px" title="22 topics">Swift</a></div></aside><style scoped type="text/css">.utcw-5dkhj5o {word-wrap:break-word}.utcw-5dkhj5o span,.utcw-5dkhj5o a{border-style:solid;border-width:1px}.utcw-5dkhj5o span:hover,.utcw-5dkhj5o a:hover{border-style:solid;border-width:1px}</style><aside id="utcw-3" class="widget widget_utcw widget_tag_cloud"><h1 class="widget-title">Posts By Product</h1><div class="utcw-5dkhj5o tagcloud"><a class="tag-link-2043 utcw-tag utcw-tag-mms" href="https://www.twilio.com/blog/tag/mms" style="font-size:16px" title="50 topics">MMS</a> <a class="tag-link-3513 utcw-tag utcw-tag-programmable-chat" href="https://www.twilio.com/blog/tag/programmable-chat" style="font-size:16px" title="9 topics">Programmable Chat</a> <a class="tag-link-1537 utcw-tag utcw-tag-sip" href="https://www.twilio.com/blog/tag/sip" style="font-size:16px" title="15 topics">SIP</a> <a class="tag-link-1031 utcw-tag utcw-tag-sms" href="https://www.twilio.com/blog/tag/sms" style="font-size:16px" title="372 topics">SMS</a> <a class="tag-link-2871 utcw-tag utcw-tag-taskrouter" href="https://www.twilio.com/blog/tag/taskrouter" style="font-size:16px" title="8 topics">Task Router</a> <a class="tag-link-1199 utcw-tag utcw-tag-twilio-client" href="https://www.twilio.com/blog/tag/twilio-client" style="font-size:16px" title="32 topics">Twilio Client</a> <a class="tag-link-3032 utcw-tag utcw-tag-twilio-video" href="https://www.twilio.com/blog/tag/twilio-video" style="font-size:16px" title="9 topics">Twilio Video</a> <a class="tag-link-1277 utcw-tag utcw-tag-voice" href="https://www.twilio.com/blog/tag/voice" style="font-size:16px" title="172 topics">Voice</a></div></aside><aside id="text-5" class="widget widget_text">			<div class="textwidget"><a href="http://www.twilio.com/docs/tutorials" onclick="__gaTracker('send', 'event', 'outbound-widget', 'http://www.twilio.com/docs/tutorials', '');"><img src="https://www.twilio.com/blog/wp-content/uploads/2016/07/tutorials.png" style="width: 255px" /></a></div>
		</aside><aside id="categories-3" class="widget widget_categories"><h1 class="widget-title">Categories</h1>		<ul>
	<li class="cat-item cat-item-13"><a href="https://www.twilio.com/blog/all-things-code" >Code, Tutorials and Hacks</a>
</li>
	<li class="cat-item cat-item-5"><a href="https://www.twilio.com/blog/customer-highlights" >Customer Highlights</a>
</li>
	<li class="cat-item cat-item-7"><a href="https://www.twilio.com/blog/developers-drawing-the-owl" >Developers Drawing The Owl</a>
</li>
	<li class="cat-item cat-item-3"><a href="https://www.twilio.com/blog/news" >News</a>
</li>
	<li class="cat-item cat-item-4"><a href="https://www.twilio.com/blog/stories-from-the-road" >Stories From The Road</a>
</li>
	<li class="cat-item cat-item-8"><a href="https://www.twilio.com/blog/inside-twilio" >The Owl’s Nest: Inside Twilio</a>
</li>
		</ul>
</aside><aside id="text-4" class="widget widget_text">			<div class="textwidget"><div class="tagcloud "><a href="http://www.twilio.com/blog/feed" onclick="__gaTracker('send', 'event', 'outbound-widget', 'http://www.twilio.com/blog/feed', 'RSS Feed');">RSS Feed</a></div></div>
		</aside></div><!-- #secondary -->

		</div><!-- .row -->
	</div><!-- #content.container -->

<div class="" id="footer">
	<div class="container">
		<header>
			<div class="banner"></div>
			<div class="border"></div>
			<div class="stitching"></div>
		</header>
    <div class="row sitemap">
      <div class="row">
        <div class="col-md-2 col-md-offset-1">
          <h4><a href="http://www.twilio.com/company">Company</a></h4>
          <ul>
            <li><a href="http://www.twilio.com/company">About Twilio</a></li>
            <li><a href="http://www.twilio.com/company/nine-values">Our Nine Values</a></li>
            <li><a href="http://www.twilio.com/company/leadership-principles">Our Leadership Principles</a></li>
            <li><a href="http://www.twilio.com/company/management">The Team</a></li>
            <li><a href="http://www.twilio.com/press">Press &amp; Media</a></li>
            <li><a href="http://www.twilio.org/">Twilio.org</a></li>
            <li><a href="http://www.twilio.com/company/jobs">Careers</a></li>
          </ul>
        </div>
        <div class="col-md-2">
          <h4><a href="http://www.twilio.com/products">Products</a></h4>
          <ul>
            <li><a href="http://www.twilio.com/voice">Voice</a></li>
            <li><a href="http://www.twilio.com/video">Video</a></li>
            <li><a href="http://www.twilio.com/sms">SMS (Text Messaging)</a></li>
            <li><a href="http://www.twilio.com/mms">MMS (Picture Messaging)</a></li>
            <li><a href="http://www.twilio.com/sms/toll-free">Toll-Free SMS</a></li>
            <li><a href="http://www.twilio.com/sip-trunking">SIP Trunking</a></li>
            <li><a href="http://www.twilio.com/client/mobile">Client Mobile</a></li>
            <li><a href="http://www.twilio.com/webrtc">Client WebRTC</a></li>
            <li><a href="http://www.twilio.com/stun-turn">Network Traversal Service</a></li>
            <li><a href="http://www.twilio.com/taskrouter">TaskRouter</a></li>
            <li><a href="http://www.twilio.com/sms/phone-numbers">Phone Numbers</a></li>
            <li><a href="http://www.twilio.com/sms/shortcodes">Short Codes</a></li>
            <li><a href="http://www.twilio.com/support-plans">Support Plans</a></li>
            <li><a href="http://www.twilio.com/platform">Platform</a></li>
            <li><a href="http://www.twilio.com/lookup">Lookup</a></li>
            <li><a href="http://www.twilio.com/monitor">Monitor</a></li>
            <li><a href="http://www.twilio.com/copilot">Messaging Copilot</a></li>
            <li><a href="http://www.twilio.com/voice/conference">Global Conference</a></li>
            <li><a href="http://www.twilio.com/authy">Authy</a></li>
          </ul>
      </div>
      <div class="col-md-2">
        <h4><a href="http://www.twilio.com/pricing">Pricing</a></h4>
        <ul>
          <li><a href="http://www.twilio.com/voice/pricing">Voice Pricing</a></li>
          <li><a href="http://www.twilio.com/sms/pricing">Messaging Pricing</a></li>
          <li><a href="http://www.twilio.com/sip-trunking/pricing">SIP Trunking Pricing</a></li>
          <li><a href="http://www.twilio.com/client/pricing">Client Pricing</a></li>
          <li><a href="http://www.twilio.com/stun-turn/pricing">Network Traversal Pricing</a></li>
          <li><a href="http://www.twilio.com/taskrouter/pricing">TaskRouter</a></li>
          <li><a href="http://www.twilio.com/lookup#pricing">Lookup</a></li>
          <li><a href="http://www.twilio.com/international">International Coverage</a></li>
        </ul>
      </div>
      <div class="col-md-2">
          <h4><a href="http://www.twilio.com/use-cases">Use Cases</a></h4>
          <ul>
            <li><a href="http://www.twilio.com/customers">Customer Stories</a></li>
            <li><a href="http://www.twilio.com/showcase">Showcase</a></li>
            <li><a href="http://www.twilio.com/use-cases/two-factor-authentication">Two-Factor Authentication</a></li>
            <li><a href="http://www.twilio.com/use-cases/appointment-reminders">Appointment Reminders</a></li>
            <li><a href="http://www.twilio.com/use-cases/dispatch-notifications">Dispatch Notifications</a></li>
            <li><a href="http://www.twilio.com/use-cases/eta-alerts">ETA Alerts</a></li>
            <li><a href="http://www.twilio.com/use-cases/automated-surveys">Automated Surveys</a></li>
            <li><a href="http://www.twilio.com/use-cases/masked-phone-numbers">Masked Phone Numbers</a></li>
            <li><a href="http://www.twilio.com/use-cases/visual-estimates">Visual Estimates</a></li>
            <li><a href="http://www.twilio.com/doers">Developer Network</a></li>
            <li><a href="http://www.twilio.com/webinars">Webinars</a></li>
            <li><a href="http://www.twilio.com/white-papers">White Papers</a></li>
          </ul>
      </div>
      <div class="col-md-2">
          <h4><a href="http://www.twilio.com/api">Api &amp; Docs</a></h4>
          <ul>
            <li><a href="http://www.twilio.com/docs/api">API Documentation</a></li>
            <li><a href="http://www.twilio.com/docs/quickstart">Quickstarts</a></li>
            <li><a href="http://www.twilio.com/docs/howto">How Tos</a></li>
            <li><a href="http://www.twilio.com/docs/libraries">Helper Libraries</a></li>
            <li><a href="http://www.twilio.com/docs/security">Security</a></li>
          </ul>
      </div>
    </div>
		<div class="row clear">
			<footer><span>&copy; 2017 Twilio. All rights reserved. <aside>|</aside><a href="http://www.twilio.com/legal/tos">Terms of Service</a><aside>|</aside><a href="http://www.twilio.com/legal/privacy">Privacy Policy</a></span>
			</footer>
		</div>
	</div>
</div>


</div><!-- #page -->

<script type='text/javascript' src='https://s0.wp.com/wp-content/js/devicepx-jetpack.js?ver=201702'></script>







<script type="text/javascript" defer src="https://www.twilio.com/blog/wp-content/cache/autoptimize/js/autoptimize_30cf8936a215677503cd64ef48677239.js"></script></body>

<!-- Mirrored from www.twilio.com/blog/2016/06/real-time-rails-4-using-server-sent-events-with-authy-onetouch.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 22:10:06 GMT -->
</html>
