<!DOCTYPE html>
<html lang="en-US">

<!-- Mirrored from www.twilio.com/blog/2015/02/building-your-own-personal-assistant-with-twilio-and-google-calendar.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 22:10:00 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<script type="text/javascript">
(function() {
    var projectId = 3524915770;
    var protocol = ('https:' == document.location.protocol ?
    'https://' : 'http://');
    var scriptTag = document.createElement('script');
    scriptTag.type = 'text/javascript';
    scriptTag.async = true;
    scriptTag.src = protocol + 'cdn.optimizely.com/js/' +
    projectId + '.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(scriptTag, s);
})();
function optimizelyTimeout() {
    window.optimizely = window.optimizely|| [];
    if (!window.optimizely.data) {
    window.optimizely.push("timeout");
    }
}
setTimeout(optimizelyTimeout, 1000);
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="profile" href="http://gmpg.org/xfn/11">
<link rel="pingback" href="https://www.twilio.com/blog/xmlrpc.php">
<script type="text/javascript">
var _elqQ = _elqQ || [];
_elqQ.push(['elqSetSiteId', '815114181']);
_elqQ.push(['elqTrackPageView']);
_elqQ.push(['elqUseFirstPartyCookie', 'www.twilio.com']);
(function () {
  function async_load()
  {
    var s = document.createElement('script'); s.type = 'text/javascript'; s.async = true;
    s.src = 'http://img03.en25.com/i/elqCfg.min.js';
    var x = document.getElementsByTagName('script')[0]; x.parentNode.insertBefore(s, x);
  }
  if (window.addEventListener) window.addEventListener('DOMContentLoaded', async_load, false);
  else if (window.attachEvent) window.attachEvent('onload', async_load);
})();
</script>
<!-- Facebook Pixel Code -->
<script>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
document,'script','http://connect.facebook.net/en_US/fbevents.js');

fbq('init', '467131150158811');
fbq('track', "PageView");</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=467131150158811&amp;ev=PageView&amp;noscript=1"
/></noscript>
<!-- End Facebook Pixel Code -->

<style>
@media screen and (max-width: 600px) {
  #signal-header { display: none; }
}
</style>

<link type="text/css" media="all" href="https://www.twilio.com/blog/wp-content/cache/autoptimize/css/autoptimize_7a2cc50131d932d32297f43c61de37cd.css" rel="stylesheet" /><link type="text/css" media="screen" href="https://www.twilio.com/blog/wp-content/cache/autoptimize/css/autoptimize_97ca666341cd9b69002e26c8f2ca5299.css" rel="stylesheet" /><title>Building your own personal assistant with Twilio and Google Calendar &#8211; Twilio Cloud Communications Blog</title>

<!-- This site is optimized with the Yoast WordPress SEO plugin v1.4.13 - http://yoast.com/wordpress/seo/ -->
<meta name="description" content="Building Your Own Personal Assistant with Twilio and Google Calendar"/>
<link rel="canonical" href="https://www.twilio.com/blog/2015/02/building-your-own-personal-assistant-with-twilio-and-google-calendar.html" />
<link rel="author" href="https://www.twilio.com/blog/2015/02/MarcosPlacona"/>
<!-- / Yoast WordPress SEO plugin. -->

<link rel='dns-prefetch' href='https://www.twilio.com/blog//s0.wp.com' />
<link rel='dns-prefetch' href='https://www.twilio.com/blog//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="Twilio Cloud Communications Blog &raquo; Feed" href="https://www.twilio.com/blog/feed" />
<link rel="alternate" type="application/rss+xml" title="Twilio Cloud Communications Blog &raquo; Comments Feed" href="https://www.twilio.com/blog/comments/feed" />
<link rel="alternate" type="application/rss+xml" title="Twilio Cloud Communications Blog &raquo; Building your own personal assistant with Twilio and Google Calendar Comments Feed" href="https://www.twilio.com/blog/2015/02/building-your-own-personal-assistant-with-twilio-and-google-calendar.html/feed" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/twilioinc.wpengine.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.6.2"}};
			!function(a,b,c){function d(a){var c,d,e,f,g,h=b.createElement("canvas"),i=h.getContext&&h.getContext("2d"),j=String.fromCharCode;if(!i||!i.fillText)return!1;switch(i.textBaseline="top",i.font="600 32px Arial",a){case"flag":return i.fillText(j(55356,56806,55356,56826),0,0),!(h.toDataURL().length<3e3)&&(i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,65039,8205,55356,57096),0,0),c=h.toDataURL(),i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,55356,57096),0,0),d=h.toDataURL(),c!==d);case"diversity":return i.fillText(j(55356,57221),0,0),e=i.getImageData(16,16,1,1).data,f=e[0]+","+e[1]+","+e[2]+","+e[3],i.fillText(j(55356,57221,55356,57343),0,0),e=i.getImageData(16,16,1,1).data,g=e[0]+","+e[1]+","+e[2]+","+e[3],f!==g;case"simple":return i.fillText(j(55357,56835),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode8":return i.fillText(j(55356,57135),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode9":return i.fillText(j(55358,56631),0,0),0!==i.getImageData(16,16,1,1).data[0]}return!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i;for(i=Array("simple","flag","unicode8","diversity","unicode9"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>










<!-- This site uses the Google Analytics by Yoast plugin v5.4.7 - Universal enabled - https://yoast.com/wordpress/plugins/google-analytics/ -->
<script type="text/javascript">
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','http://www.google-analytics.com/analytics.js','__gaTracker');

	__gaTracker('create', 'UA-2900316-1', 'auto');
	__gaTracker('set', 'forceSSL', true);
	 window.optimizely = window.optimizely || [];
 window.optimizely.push("activateUniversalAnalytics");
	__gaTracker('set', 'dimension4', 'Marcos Placona');
	__gaTracker('set', 'dimension5', 'post');
	__gaTracker('set', 'dimension6', 'all-things-code');
	__gaTracker('set', 'dimension7', 'Google Calendar,JavaScript,Node.js,SMS,Twilio automation,Voice');
	__gaTracker('set', 'dimension8', '2015-02-23T13:55:01+00:00');
	__gaTracker('send','pageview');

</script>
<!-- / Google Analytics by Yoast -->


<script type='text/javascript'>
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"2.4.3","is_admin":"0","ajaxurl":"https:\/\/twilioinc.wpengine.com\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>

<script type='text/javascript'>
/* <![CDATA[ */
var swiftypeParams = {"engineKey":"UpGyyJZzgUMXHM65YENj"};
/* ]]> */
</script>

<link rel='https://api.w.org/' href='https://www.twilio.com/blog/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://www.twilio.com/blog/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://www.twilio.com/blog/wp-includes/wlwmanifest.xml" /> 
<link rel='shortlink' href='https://www.twilio.com/blog/?p=14689' />
<link rel="alternate" type="application/json+oembed" href="https://www.twilio.com/blog/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fwww.twilio.com%2Fblog%2F2015%2F02%2Fbuilding-your-own-personal-assistant-with-twilio-and-google-calendar.html" />
<link rel="alternate" type="text/xml+oembed" href="https://www.twilio.com/blog/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fwww.twilio.com%2Fblog%2F2015%2F02%2Fbuilding-your-own-personal-assistant-with-twilio-and-google-calendar.html&amp;format=xml" />
<link rel="icon" href="https://www.twilio.com/blog/wp-content/uploads/2015/09/cropped-favicon_1141-32x32.png" sizes="32x32" />
<link rel="icon" href="https://www.twilio.com/blog/wp-content/uploads/2015/09/cropped-favicon_1141-192x192.png" sizes="192x192" />
<link rel="apple-touch-icon-precomposed" href="https://www.twilio.com/blog/wp-content/uploads/2015/09/cropped-favicon_1141-180x180.png" />
<meta name="msapplication-TileImage" content="https://www.twilio.com/blog/wp-content/uploads/2015/09/cropped-favicon_1141-270x270.png" />
</head>

<body class="single single-post postid-14689 single-format-standard group-blog">
<!-- Google Tag Manager -->
<noscript><iframe src="https://www.twilio.com/blog//www.googletagmanager.com/ns.html?id=GTM-W4RVXH"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'http://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-W4RVXH');</script>
<!-- End Google Tag Manager -->

<div id="fb-root"></div>
<script>(function(d, s, id) {
		var js, fjs = d.getElementsByTagName(s)[0];
		if (d.getElementById(id)) return;
		js = d.createElement(s); js.id = id;
		js.src = "http://connect.facebook.net/en_US/sdk.js#xfbml=1&appId=414254592083321&version=v2.0";
		fjs.parentNode.insertBefore(js, fjs);
	}(document, 'script', 'facebook-jssdk'));
window.fbAsyncInit = function() {
  FB.Event.subscribe('edge.create', function(targetUrl) {
    __gaTracker('send', 'social', 'facebook', 'like', targetUrl);
  });
};
window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));

function trackTwitter(intent_event) {
  if (intent_event) {
    var opt_pagePath;
    if (intent_event.target && intent_event.target.nodeName == 'IFRAME') {
          opt_target = extractParamFromUri(intent_event.target.src, 'url');
    }
    __gaTracker('send', 'social', 'twitter', 'tweet', opt_pagePath);
  }
}

function extractParamFromUri(uri, paramName) {
  if (!uri) {
    return;
  }
  var regex = new RegExp('[\\?&#]' + paramName + '=([^&#]*)');
  var params = regex.exec(uri);
  if (params != null) {
    return unescape(params[1]);
  }
  return;
}

//Wrap event bindings - Wait for async js to load
twttr.ready(function (twttr) {
  //event bindings
  twttr.events.bind('tweet', trackTwitter);
});
</script>
<script type="text/javascript">
  window.heap=window.heap||[],heap.load=function(e,t){window.heap.appid=e,window.heap.config=t=t||{};var n=t.forceSSL||"https:"===document.location.protocol,a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=(n?"https:":"http:")+"//cdn.heapanalytics.com/js/heap-"+e+".js";var o=document.getElementsByTagName("script")[0];o.parentNode.insertBefore(a,o);for(var r=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},p=["clearEventProperties","identify","setEventProperties","track","unsetEventProperty"],c=0;c<p.length;c++)heap[p[c]]=r(p[c])};
  heap.load("1541905715");
</script>
<div id="page" class="hfeed site">
	<a class="skip-link screen-reader-text" href="#content">Skip to content</a>

	<nav class="navbar navbar-default" role="navigation">
		<div class="container">
			<!-- Brand and toggle get grouped for better mobile display -->
			<div class="navbar-header">
				<button type="button" class="navbar-toggle hidden-xs" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="https://www.twilio.com/blog/">
					<img src="https://s3.amazonaws.com/ahoy-assets.twilio.com/global/images/wordmark.svg" width="200"> <span class="logo-blog">blog</span>
				</a>
			</div>

			<div class="hidden-xs"><ul id="menu-site-navigation" class="nav navbar-nav pull-right"><li id="menu-item-12202" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12202"><a href="http://www.twilio.com/" onclick="__gaTracker('send', 'event', 'outbound-widget', 'http://www.twilio.com/', 'Home');" title="Home">Home</a></li>
<li id="menu-item-12205" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12205"><a href="http://www.twilio.com/blog" onclick="__gaTracker('send', 'event', 'outbound-widget', 'http://www.twilio.com/blog', 'Blog');" title="Blog">Blog</a></li>
<li id="menu-item-12204" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12204"><a href="https://www.twilio.com/docs/howto" onclick="__gaTracker('send', 'event', 'outbound-widget', 'https://www.twilio.com/docs/howto', 'Tutorials');" title="Tutorials">Tutorials</a></li>
<li id="menu-item-12206" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12206"><a href="https://www.twilio.com/docs/api" onclick="__gaTracker('send', 'event', 'outbound-widget', 'https://www.twilio.com/docs/api', 'Docs');" title="Docs">Docs</a></li>
<li id="menu-item-12207" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12207"><a href="http://www.twilio.com/help" onclick="__gaTracker('send', 'event', 'outbound-widget', 'http://www.twilio.com/help', 'Help');" title="Help">Help</a></li>
<li id="menu-item-12208" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12208"><a href="https://www.twilio.com/login" onclick="__gaTracker('send', 'event', 'outbound-widget', 'https://www.twilio.com/login', 'Login');" title="Login">Login</a></li>
<li id="menu-item-12209" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12209"><a href="https://www.twilio.com/try-twilio" onclick="__gaTracker('send', 'event', 'outbound-widget', 'https://www.twilio.com/try-twilio', 'Signup');" title="Signup">Signup</a></li>
</ul></div>		</div>
	</nav>

	<div id="content" class="site-content container">
		<div class="row">

	<div id="primary" class="content-area col-md-9">
		<main id="main" class="site-main" role="main">

		
			
<article id="post-14689" class="row post-14689 post type-post status-publish format-standard has-post-thumbnail hentry category-all-things-code tag-google-calendar tag-javascript tag-node-js tag-sms tag-twilio-automation tag-voice">
	<header class="entry-header col-md-12">
		<h2 class="entry-title">Building your own personal assistant with Twilio and Google Calendar</h2>
						<div class="entry-image col-md-12">
        <img width="640" height="449" src="https://www.twilio.com/blog/wp-content/uploads/2015/02/twilio-pa.png" class="img-responsive wp-post-image" alt="Twilio PA" srcset="https://www.twilio.com/blog/wp-content/uploads/2015/02/twilio-pa.png 640w, https://www.twilio.com/blog/wp-content/uploads/2015/02/twilio-pa-300x210.png 300w" sizes="(max-width: 640px) 100vw, 640px" />			</div>
      <div class="clear"></div>
			
		<footer class="entry-footer">
			<div class="entry-meta">
					<div class="row">
	<div class="col-md-6">
	<span class="byline"> by <span class="author vcard"><a class="url fn n" href="https://www.twilio.com/blog/author/marcos">Marcos Placona</a></span></span> on <span class="posted-on"><a href="https://www.twilio.com/blog/2015/02/building-your-own-personal-assistant-with-twilio-and-google-calendar.html" rel="bookmark"><time class="entry-date published" datetime="2015-02-23T13:55:01+00:00">February 23, 2015</time><time class="updated" datetime="2015-09-24T09:25:13+00:00">September 24, 2015</time></a></span>	</div>
	<div class="col-md-6">
		<div class="social-buttons">
			<div class="fb-like" data-href="https://www.twilio.com/blog/2015/02/building-your-own-personal-assistant-with-twilio-and-google-calendar.html" data-layout="button" data-action="like" data-show-faces="false" data-share="false"></div>
			<a href="https://twitter.com/share" class="twitter-share-button" data-via="twilio" data-count="none" data-url="https://www.twilio.com/blog/2015/02/building-your-own-personal-assistant-with-twilio-and-google-calendar.html" data-text="Building your own personal assistant with Twilio and Google Calendar ">Tweet</a>
      <a href="https://twitter.com/twilio" class="twitter-follow-button" data-show-count="false">Follow @twilio</a>
		</div>
	</div>
	</div>
			</div><!-- .entry-meta -->
		</footer><!-- .entry-footer -->
	</header><!-- .entry-header -->

	<div class="entry-content col-md-12">
		<div class="row">
			<div class="col-md-12">
				<p>Being a developer evangelist means I get to work from anywhere. Often times I find myself on the road going to wicked events and having great conversations with developers from all around the world.</p>
<p>The flipside is that most of my colleagues are also remotes and are usually doing the same things around the communities they serve. It can be difficult to have meetings with them, or anyone else that is not physically located in the same city, country or continent as I am.</p>
<p>We usually resolve this situation by holding meetings over the phone, but one of the problems that affects me is the fact that my calendar will pop up 15 minutes before and I will snooze it until 5 minutes before the meeting.</p>
<p>I will also sometimes hit <em>dismiss</em> accidentally only to be reminded via instant messenger of the fact I was meant to be on a meeting that started about eleven minutes ago.</p>
<p>One morning I was thinking about this situation and the fact that there has to be a better way of solving this problem other then adding multiple reminders on my calendar or phone.</p>
<p>My first solution was simple: “<em>I need to get myself a Personal Assistant!</em>”</p>
<p>Now let’s take a step back – Twilio is all about making my life easier, but I don’t think I have enough appointments to justify hiring my own PA.</p>
<p>Being a resourceful developer I thought about the next best thing: build myself my own software PA. What if I could build a script that keeps tabs on my Google Calendar and whenever it found I’m meant to have a call with someone it would connect me with that person automatically by dialing out to both of us?</p>
<p>“<em>That sounds like something I can knock out in an afternoon</em>” – I said!</p>
<p>To build our very own PA, we will need the following:</p>
<ul>
<li>A <a href="https://www.twilio.com/try-twilio" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://www.twilio.com/try-twilio', 'Twilio account');">Twilio account</a> and one <a href="https://www.twilio.com/user/account/phone-numbers/incoming" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://www.twilio.com/user/account/phone-numbers/incoming', 'Twilio phone number');">Twilio phone number</a></li>
<li><a href="http://nodejs.org/download/" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://nodejs.org/download/', 'Node.js and NPM installed');">Node.js and NPM installed</a></li>
<li><a href="http://docs.mongodb.org/manual/installation/" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://docs.mongodb.org/manual/installation/', 'MongoDB installed');">MongoDB installed</a></li>
<li>Your Google Calendar credentials</li>
</ul>
<p>If you don’t want to go through the entire build, feel free to checkout the code repository <a href="https://github.com/mplacona/twilio-pa" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://github.com/mplacona/twilio-pa', 'here');">here</a>.</p>
<h3>Finding your Google Calendar Credentials</h3>
<p>Google Calendar credentials can be tricky to get if you’ve not handled them before. In the steps bellow I will walk you through the process getting those credentials.</p>
<p>Start by heading to<a href="https://console.developers.google.com/" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://console.developers.google.com/', ' Google Developer Console');"> Google Developer Console</a> and click <em>Create Project</em>.</p>
<p><img alt="twilio-pa_0.png" src="https://lh4.googleusercontent.com/GC1NwebARFNVWsZDS8XjJAmZftu4wUFQcMy5jtwNtLeeZWNDJIzj-_d0KIgnydiHiNlWkWa4mSAIaG8ViEHVvTEwMqK6HNFDFj_PltkTfylU51O0MlCK4moheWuefYMz-GA" width="624px;" height="145px;" /></p>
<p>The subsequent screen will ask you to give this project a name. We will call it <em>Twilio PA</em> and leave the <em>Project ID</em> with its default value.</p>
<p>After the project is created click on <em>APIs &amp; Auth</em> on the left-hand side menu then click <em>APIs</em>. You should see a big list with all the APIs available to that project. The one we’re interested in is <em>Google Calendar</em> so let’s turn that on.</p>
<p><img alt="twilio-pa_1.png" src="https://lh5.googleusercontent.com/ff88qQZWs_0RnrjUrAiWeopumrO9HQQYjjXwIcR6NqbkJo7Fv_c70yrQhLXTjEYHDVi_mPlvzhrPa8Gevk7oRkpiNDPdNA8vmisadXk0rhkWbvPeoBQ92kn4ND7uRi-febo" width="624px;" height="140px;" /></p>
<p>On the left-hand side menu click on <em>Credentials</em> under <em>APIs &amp; Auth</em> and click <em>Create new Client ID</em> under <em>OAuth</em>. Because we are creating a <em>Web Application</em>, we will choose this option.</p>
<p>Click on <em>Configure consent screen</em> and you will be redirected to a page that requires your email address and a <em>Product Name</em>. Fill that in with <em>Twilio PA</em> as the product name and click save.</p>
<p><img alt="twilio-pa_8.png" src="https://lh5.googleusercontent.com/twJPUVvmHPlGpAz4SZKf0F2ar2clNYq-cz3H_J89H7RF3hGs1tySqcsKvTZeyfGxoz6gPLd2NQ8qQnglBpvjpEOKs430Q4TtsvddMRCsHeZLiIpgNPJlk5yQ6LAncv3ZDVc" width="624px;" height="385px;" /></p>
<p>You will then be presented with a modal screen that lets you fill in a couple of URLs. For the purposes of this article our project will run on localhost on port 2002. Use the following values before clicking <em>Create Client ID</em>:</p>
<p><img alt="twilio-pa_2.png" src="https://lh4.googleusercontent.com/gIXGQYEdItHa-MPT4BSpjvqWkY116waRIg9tKd43xrgrQGdAL6cdYaN6TwHhjtXPt1d5J-gx2K_VypTLojFpJtnVqFk4xuarvulSj2OPWzMgw6C7jPON97VGdjnPuJYxqpA" width="422px;" height="508px;" /></p>
<p>This page will set up our application and give us the credentials. If you are seeing a screen similar to the one below, you have gone through the process successfully. Take note of the <em>CLIENT ID</em> and <em>CLIENT SECRET</em>.</p>
<p><img alt="twilio-pa_3.png" src="https://lh6.googleusercontent.com/lev5ODpKQYh6j9sbv-88XHImfRGJQZxRMpzl05qGkcKZd-pEx3qEZRSkUHTOJi91t2PkkQJfri3tFPQIGbcBZjxjXemEk8809K9hITNf3JDpuNpHKGvvrfQ0vVp23p_Vhc8" width="624px;" height="187px;" /></p>
<h3>Choosing the calendar you want to monitor</h3>
<p>I have many different calendars on my account. Usually I have personal appointments separated from my work ones to make sure I’m giving work appointments higher priority.</p>
<p>Because I want to make sure I never miss any of my work calls, I will now make a note of the ID for my “work” calendar. The easiest way to find out this ID is by going to your <a href="https://www.google.com/calendar" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://www.google.com/calendar', 'Google Calendar');">Google Calendar</a> and clicking on <em>Settings</em>. Settings is represented by a cog icon on the right-hand side. You should now be on a screen called <em>Calendar Settings</em>. Clicking on the <em>Calendars</em> icon on the top menu will take you to a list with all the calendars you own. Click on your chosen calendar and on the subsequent screen you will see a category called <em>Calendar Address</em>.</p>
<p><img alt="twilio-pa_4.png" src="https://lh4.googleusercontent.com/B3aVoorZMkefOI6jb2ToMbhX_-XtpcAcosoluwflpEe98_HclE90bHjfClpPt24SN7BW8tu5cnd7FZ2E0SyeHzRMQ1gI_evy3ridBK1bOW3GcuSOfDhyLroeqTiAZiFNWv4" width="624px;" height="37px;" /></p>
<p>Make a note of the Calendar ID. This is the identifier of the calendar we want to use.</p>
<h3>Setting up a phone number</h3>
<p>Go to Twilio <a href="https://www.twilio.com/user/account/phone-numbers/incoming" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://www.twilio.com/user/account/phone-numbers/incoming', 'numbers page');">numbers page</a> and click <em>Buy a Number</em> if you don’t already have one available.</p>
<p><img alt="twilio-pa_0_1.png" src="https://lh4.googleusercontent.com/ydCnLAbIfXRVgKq5DpcwJ0uv746yG689Ux8jt33MHCgqmenNS9uaUxYVX1Ad7ML-87MoZCuV6vKjrd_bD197xXuLE-rSHtbOBAnEiSPpZD5I5b6TbuPN8wMUkspUR_G5EdI" width="624px;" height="236px;" /></p>
<p>Pick a number with voice and SMS capabilities and click <em>Buy</em>.</p>
<p><img alt="twilio-pa_0_2.png" src="https://lh6.googleusercontent.com/dW703Pdw9474T6VnGtkExy0sivegjwvGz8aqw7egVdnSD22QhmpvKqQRp8KWBPl3SSc6G-YRKvQ21Hja31va5J2xRBZZd_WkVYjQhIi_G4M4Qwu6dLtbe4f18q6McfjuYrQ" width="624px;" height="297px;" /></p>
<p>Click <em>Buy This Number</em> and you will see a confirmation screen.</p>
<p><img alt="twilio-pa_0_3.png" src="https://lh6.googleusercontent.com/-_zyiKEUKdG7QQ3JuKaWLUfqFEEmjWbMAxNARM4oZvrYqfGOWmDHEzmu_2GNiN3jhdaV8QmJfhrCyW_oUqx-L-L5YPOqbQArLe47KkxIY2R-EUIzp7-zHMpwpZyxuZ4xW8w" width="624px;" height="287px;" /></p>
<h3>How is this going to work?</h3>
<p>We now have successfully collected all the pieces we need in order to build this application. Every time the application runs, it will collect all the meetings scheduled for that day and create scheduled tasks on our MongoDB instance, as the diagram below shows.</p>
<p><img alt="twilio-pa (2) (1).png" src="https://lh5.googleusercontent.com/SW6IYFRFg1jchPVJ4xxUHzf2NdvWhH8X8itSOIpo058opMWQnDaU6RQtGO-ybi9aYONtM8LEVCVr0cNbAny0NnrS1PYBbsYXZn83ld0WgDAxW8OctP-46pW5tEPNgZJVhC8" width="574px;" height="286px;" /></p>
<p>As you can see on the diagram, for every event two scheduled tasks are created. Those tasks consist of one SMS message to be sent to us 5 minutes prior to the meeting and another task is triggered exactly at the start of the meeting and consists of a call to our telephone number which is then chained with another call to the number of the person we are meeting with.</p>
<h3>Setting it all up</h3>
<p>Let’s start by putting together a small Node.js application that uses <a href="http://expressjs.com/" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://expressjs.com/', 'Express');">Express</a> for routing. You can do this anywhere you like, but in my case I’ve created a directory called <em>twilio-pa</em> under <em>~/Projects/JavaScript/</em>.</p>
<p>Create a file under that directory called <em>package.json</em>. This file will contain the definitions of this project and have all the following dependencies:</p>
<ul>
<li><a href="https://www.npmjs.com/package/express" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://www.npmjs.com/package/express', 'Express');">Express</a> as our web application framework and route management.</li>
<li><a href="https://www.npmjs.com/package/googleapis" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://www.npmjs.com/package/googleapis', 'Googleapis');">Googleapis</a> for authentication and interaction with the Calendar API.</li>
<li><a href="https://www.npmjs.com/package/agenda" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://www.npmjs.com/package/agenda', 'Agenda');">Agenda</a> for our scheduled tasks.</li>
<li><a href="https://www.npmjs.com/package/datejs" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://www.npmjs.com/package/datejs', 'DateJS');">DateJS</a> to help us dealing with dates and times.</li>
<li><a href="https://www.npmjs.com/package/twilio" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://www.npmjs.com/package/twilio', 'Twilio');">Twilio</a> for interaction with Twilio’s API.</li>
<li><a href="https://www.npmjs.com/package/mongodb" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://www.npmjs.com/package/mongodb', 'MongoDB');">MongoDB</a> for database interaction</li>
</ul>
<p></p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4bdb6377116615" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title">package.json</span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
{
  "name": "twilio-pa",
  "version": "0.0.1",
  "description": "A Google calendar personal assistant powered by Twilio",
  "author": "Marcos Placona",
  "dependencies": {
    "express": "~4.11.1",
    "googleapis": "~1.1.1",
    "agenda": "~0.6.26",
    "datejs": "~1.0.0-rc3",
    "twilio": "~1.10.0",
    "mongodb": "~1.4.30"
  }
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4bdb6377116615-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bdb6377116615-2">2</div><div class="crayon-num" data-line="crayon-58794dbb4bdb6377116615-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bdb6377116615-4">4</div><div class="crayon-num" data-line="crayon-58794dbb4bdb6377116615-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bdb6377116615-6">6</div><div class="crayon-num" data-line="crayon-58794dbb4bdb6377116615-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bdb6377116615-8">8</div><div class="crayon-num" data-line="crayon-58794dbb4bdb6377116615-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bdb6377116615-10">10</div><div class="crayon-num" data-line="crayon-58794dbb4bdb6377116615-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bdb6377116615-12">12</div><div class="crayon-num" data-line="crayon-58794dbb4bdb6377116615-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bdb6377116615-14">14</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4bdb6377116615-1"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bdb6377116615-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s">"name"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"twilio-pa"</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-58794dbb4bdb6377116615-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s">"version"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"0.0.1"</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bdb6377116615-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s">"description"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"A Google calendar personal assistant powered by Twilio"</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-58794dbb4bdb6377116615-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s">"author"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"Marcos Placona"</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bdb6377116615-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-s">"dependencies"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4bdb6377116615-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"express"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"~4.11.1"</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bdb6377116615-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"googleapis"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"~1.1.1"</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-58794dbb4bdb6377116615-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"agenda"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"~0.6.26"</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bdb6377116615-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"datejs"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"~1.0.0-rc3"</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-58794dbb4bdb6377116615-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"twilio"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"~1.10.0"</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bdb6377116615-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">"mongodb"</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"~1.4.30"</span></div><div class="crayon-line" id="crayon-58794dbb4bdb6377116615-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bdb6377116615-14"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0044 seconds] -->
<p>&nbsp;</p>
<p>If you want to read more about what each of the attributes mean, you can find their definitions<a href="https://npmjs.org/doc/json.html" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://npmjs.org/doc/json.html', ' here');"> here</a>.</p>
<p>We need ensure these dependencies are installed in our project folder. We do so by going into terminal and running:</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4bdca939086215" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
$ npm install</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4bdca939086215-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4bdca939086215-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">npm </span><span class="crayon-i">install</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->
<p>Notice your project folder has a new directory called <em>node_modules</em> and under it a bunch of other directories for each of the dependencies specified on <em>package.json</em>.</p>
<p>The next thing we’ll do is create two new files called <em>config.js</em> and <em>app.js</em> on the root of our project which in our example is <em>~/Projects/JavaScript/twilio-pa</em>. We now have three files in that directory, <em>config.js</em> and <em>app.js</em> which are currently empty, and <em>package.json</em>.</p>
<p>In the <em>config.js</em> file we will add configurations for our application. These are the Google credentials we collected earlier, our Twilio telephone number and credentials. You can grab your Twilio credentials from the <a href="https://www.twilio.com/user/account/voice-messaging" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://www.twilio.com/user/account/voice-messaging', 'dashboard');">dashboard</a>.</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4bdd6632672622" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title">config.js</span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
var config = {};

// HTTP Port to run our web application
config.port = process.env.PORT || 2002;

// My own telephone number for notifications and calls
config.ownNumber = process.env.TELEPHONE_NUMBER;

// Your Twilio account SID and auth token, both found at:
// https://www.twilio.com/user/account
// A good practice is to store these string values as system environment variables, and load them from there as we are doing below. 
// Alternately, you could hard code these values here as strings.
config.twilioConfig = {
    accountSid: process.env.TWILIO_ACCOUNT_SID,
    authToken: process.env.TWILIO_AUTH_TOKEN,
    // A Twilio number you control - choose one from:
    // https://www.twilio.com/user/account/phone-numbers/incoming
    number: process.env.TWILIO_NUMBER
  }
// Google OAuth Configuration
config.googleConfig = {
  clientID: process.env.GOOGLE_CLIENT_ID,
  clientSecret: process.env.GOOGLE_CLIENT_SECRET,
  calendarId: process.env.GOOGLE_CALENDAR_ID,
  // same as configured at the Developer Console
  redirectURL: 'http://localhost:2002/auth'
};
// MongoDB Settings
config.mongoConfig = {
    ip: '127.0.0.1',
    port: 27017,
    name: 'twilio-pa'
  }
// Export configuration object
module.exports = config;</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4bdd6632672622-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bdd6632672622-2">2</div><div class="crayon-num" data-line="crayon-58794dbb4bdd6632672622-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bdd6632672622-4">4</div><div class="crayon-num" data-line="crayon-58794dbb4bdd6632672622-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bdd6632672622-6">6</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom" data-line="crayon-58794dbb4bdd6632672622-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bdd6632672622-8">8</div><div class="crayon-num" data-line="crayon-58794dbb4bdd6632672622-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bdd6632672622-10">10</div><div class="crayon-num" data-line="crayon-58794dbb4bdd6632672622-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bdd6632672622-12">12</div><div class="crayon-num" data-line="crayon-58794dbb4bdd6632672622-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bdd6632672622-14">14</div><div class="crayon-num" data-line="crayon-58794dbb4bdd6632672622-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bdd6632672622-16">16</div><div class="crayon-num" data-line="crayon-58794dbb4bdd6632672622-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bdd6632672622-18">18</div><div class="crayon-num" data-line="crayon-58794dbb4bdd6632672622-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bdd6632672622-20">20</div><div class="crayon-num" data-line="crayon-58794dbb4bdd6632672622-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bdd6632672622-22">22</div><div class="crayon-num" data-line="crayon-58794dbb4bdd6632672622-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bdd6632672622-24">24</div><div class="crayon-num" data-line="crayon-58794dbb4bdd6632672622-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bdd6632672622-26">26</div><div class="crayon-num" data-line="crayon-58794dbb4bdd6632672622-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bdd6632672622-28">28</div><div class="crayon-num crayon-marked-num crayon-top" data-line="crayon-58794dbb4bdd6632672622-29">29</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-58794dbb4bdd6632672622-30">30</div><div class="crayon-num crayon-marked-num" data-line="crayon-58794dbb4bdd6632672622-31">31</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-58794dbb4bdd6632672622-32">32</div><div class="crayon-num crayon-marked-num crayon-bottom" data-line="crayon-58794dbb4bdd6632672622-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bdd6632672622-34">34</div><div class="crayon-num" data-line="crayon-58794dbb4bdd6632672622-35">35</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4bdd6632672622-1"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bdd6632672622-2">&nbsp;</div><div class="crayon-line" id="crayon-58794dbb4bdd6632672622-3"><span class="crayon-c">// HTTP Port to run our web application</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bdd6632672622-4"><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">port</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">process</span><span class="crayon-sy">.</span><span class="crayon-v">env</span><span class="crayon-sy">.</span><span class="crayon-i">PORT</span><span class="crayon-h"> </span><span class="crayon-o">||</span><span class="crayon-h"> </span><span class="crayon-cn">2002</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4bdd6632672622-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bdd6632672622-6"><span class="crayon-c">// My own telephone number for notifications and calls</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom" id="crayon-58794dbb4bdd6632672622-7"><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">ownNumber</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">process</span><span class="crayon-sy">.</span><span class="crayon-v">env</span><span class="crayon-sy">.</span><span class="crayon-i">TELEPHONE_NUMBER</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bdd6632672622-8">&nbsp;</div><div class="crayon-line" id="crayon-58794dbb4bdd6632672622-9"><span class="crayon-c">// Your Twilio account SID and auth token, both found at:</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bdd6632672622-10"><span class="crayon-c">// https://www.twilio.com/user/account</span></div><div class="crayon-line" id="crayon-58794dbb4bdd6632672622-11"><span class="crayon-c">// A good practice is to store these string values as system environment variables, and load them from there as we are doing below. </span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bdd6632672622-12"><span class="crayon-c">// Alternately, you could hard code these values here as strings.</span></div><div class="crayon-line" id="crayon-58794dbb4bdd6632672622-13"><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">twilioConfig</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bdd6632672622-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">accountSid:</span><span class="crayon-h"> </span><span class="crayon-v">process</span><span class="crayon-sy">.</span><span class="crayon-v">env</span><span class="crayon-sy">.</span><span class="crayon-i">TWILIO_ACCOUNT_SID</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-58794dbb4bdd6632672622-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">authToken:</span><span class="crayon-h"> </span><span class="crayon-v">process</span><span class="crayon-sy">.</span><span class="crayon-v">env</span><span class="crayon-sy">.</span><span class="crayon-i">TWILIO_AUTH_TOKEN</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bdd6632672622-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// A Twilio number you control - choose one from:</span></div><div class="crayon-line" id="crayon-58794dbb4bdd6632672622-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// https://www.twilio.com/user/account/phone-numbers/incoming</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bdd6632672622-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">number:</span><span class="crayon-h"> </span><span class="crayon-v">process</span><span class="crayon-sy">.</span><span class="crayon-v">env</span><span class="crayon-sy">.</span><span class="crayon-i">TWILIO_NUMBER</span></div><div class="crayon-line" id="crayon-58794dbb4bdd6632672622-19"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bdd6632672622-20"><span class="crayon-c">// Google OAuth Configuration</span></div><div class="crayon-line" id="crayon-58794dbb4bdd6632672622-21"><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">googleConfig</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bdd6632672622-22"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">clientID:</span><span class="crayon-h"> </span><span class="crayon-v">process</span><span class="crayon-sy">.</span><span class="crayon-v">env</span><span class="crayon-sy">.</span><span class="crayon-i">GOOGLE_CLIENT_ID</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-58794dbb4bdd6632672622-23"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">clientSecret:</span><span class="crayon-h"> </span><span class="crayon-v">process</span><span class="crayon-sy">.</span><span class="crayon-v">env</span><span class="crayon-sy">.</span><span class="crayon-i">GOOGLE_CLIENT_SECRET</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bdd6632672622-24"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">calendarId:</span><span class="crayon-h"> </span><span class="crayon-v">process</span><span class="crayon-sy">.</span><span class="crayon-v">env</span><span class="crayon-sy">.</span><span class="crayon-i">GOOGLE_CALENDAR_ID</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-58794dbb4bdd6632672622-25"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// same as configured at the Developer Console</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bdd6632672622-26"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">redirectURL:</span><span class="crayon-h"> </span><span class="crayon-s">'http://localhost:2002/auth'</span></div><div class="crayon-line" id="crayon-58794dbb4bdd6632672622-27"><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bdd6632672622-28"><span class="crayon-c">// MongoDB Settings</span></div><div class="crayon-line crayon-marked-line crayon-top" id="crayon-58794dbb4bdd6632672622-29"><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">mongoConfig</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-58794dbb4bdd6632672622-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">ip:</span><span class="crayon-h"> </span><span class="crayon-s">'127.0.0.1'</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-marked-line" id="crayon-58794dbb4bdd6632672622-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">port:</span><span class="crayon-h"> </span><span class="crayon-cn">27017</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-58794dbb4bdd6632672622-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">name:</span><span class="crayon-h"> </span><span class="crayon-s">'twilio-pa'</span></div><div class="crayon-line crayon-marked-line crayon-bottom" id="crayon-58794dbb4bdd6632672622-33"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bdd6632672622-34"><span class="crayon-c">// Export configuration object</span></div><div class="crayon-line" id="crayon-58794dbb4bdd6632672622-35"><span class="crayon-v">module</span><span class="crayon-sy">.</span><span class="crayon-v">exports</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-i">config</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0097 seconds] -->
<p>We have configured two variables here we have not talked about yet. One of them is called <em>ownNumber</em>, which is your telephone number. This is the number our application will text and dial every time before the call starts.</p>
<p>The other configuration is <em>mongoConfig</em> with information about the MongoDB instance.</p>
<p>Edit <em>app.js</em> to make sure our setup is correct and all dependencies are properly installed.</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4bde2198858458" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title">app.js</span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
var config = require('./config');

// Dependency setup
var express = require('express'),
  google = require('googleapis'),
  date = require('datejs'),
  twilio = require('twilio');

// Initialization
var app = express();

app.get('/', function(req, res) {
  res.send('Hello World!');
});

var server = app.listen(config.port, function() {
  var host = server.address().address;
  var port = server.address().port;

  console.log('Listening at http://%s:%s', host, port);
});</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4bde2198858458-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bde2198858458-2">2</div><div class="crayon-num" data-line="crayon-58794dbb4bde2198858458-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bde2198858458-4">4</div><div class="crayon-num" data-line="crayon-58794dbb4bde2198858458-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bde2198858458-6">6</div><div class="crayon-num" data-line="crayon-58794dbb4bde2198858458-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bde2198858458-8">8</div><div class="crayon-num" data-line="crayon-58794dbb4bde2198858458-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bde2198858458-10">10</div><div class="crayon-num" data-line="crayon-58794dbb4bde2198858458-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bde2198858458-12">12</div><div class="crayon-num" data-line="crayon-58794dbb4bde2198858458-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bde2198858458-14">14</div><div class="crayon-num" data-line="crayon-58794dbb4bde2198858458-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bde2198858458-16">16</div><div class="crayon-num" data-line="crayon-58794dbb4bde2198858458-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bde2198858458-18">18</div><div class="crayon-num" data-line="crayon-58794dbb4bde2198858458-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bde2198858458-20">20</div><div class="crayon-num" data-line="crayon-58794dbb4bde2198858458-21">21</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4bde2198858458-1"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">require</span><span class="crayon-sy">(</span><span class="crayon-s">'./config'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bde2198858458-2">&nbsp;</div><div class="crayon-line" id="crayon-58794dbb4bde2198858458-3"><span class="crayon-c">// Dependency setup</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bde2198858458-4"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">express</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">require</span><span class="crayon-sy">(</span><span class="crayon-s">'express'</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-58794dbb4bde2198858458-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">google</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">require</span><span class="crayon-sy">(</span><span class="crayon-s">'googleapis'</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bde2198858458-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">date</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">require</span><span class="crayon-sy">(</span><span class="crayon-s">'datejs'</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-58794dbb4bde2198858458-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">twilio</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">require</span><span class="crayon-sy">(</span><span class="crayon-s">'twilio'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bde2198858458-8">&nbsp;</div><div class="crayon-line" id="crayon-58794dbb4bde2198858458-9"><span class="crayon-c">// Initialization</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bde2198858458-10"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">app</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">express</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4bde2198858458-11">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bde2198858458-12"><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-s">'/'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">req</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">res</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4bde2198858458-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">res</span><span class="crayon-sy">.</span><span class="crayon-e">send</span><span class="crayon-sy">(</span><span class="crayon-s">'Hello World!'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bde2198858458-14"><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4bde2198858458-15">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bde2198858458-16"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">server</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-e">listen</span><span class="crayon-sy">(</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-i">port</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4bde2198858458-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">host</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">server</span><span class="crayon-sy">.</span><span class="crayon-e">address</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-i">address</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bde2198858458-18"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">port</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">server</span><span class="crayon-sy">.</span><span class="crayon-e">address</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-i">port</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4bde2198858458-19">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bde2198858458-20"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">'Listening at http://%s:%s'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">host</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">port</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4bde2198858458-21"><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0094 seconds] -->
<p>Save that, and make sure your MongoDB instance is started.</p>
<p>On a terminal window type:</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4bded286091196" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
$ node app.js</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4bded286091196-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4bded286091196-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">node </span><span class="crayon-v">app</span><span class="crayon-e">.js</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->
<p>This will start up your application.</p>
<p>On the browser, you can navigate to <a href="http://127.0.0.1:2002/" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://127.0.0.1:2002/', 'http://127.0.0.1:2002/');">http://127.0.0.1:2002</a>. If you see “<em>hello world</em>” on the screen you’ve done it all right. We’re just about to get serious.</p>
<p><img alt="twilio-pa_5.png" src="https://lh6.googleusercontent.com/hQ5iL9IioZkROPymw3LKn5oQdy9EcMSR8ghXrZTNMWXcBwsqTesAJCoX-awxf-4Zpd3U0RafjFcfGXNPGVCFTYmCjp7vzvMMkacBR9rzV6oRjqpzT0BTtzNB76Vm6pPE0b0" width="624px;" height="225px;" /></p>
<p>As previously mentioned, we will be doing some database interaction in this app to store some of the authentication information to the database. Connecting to MongoDB is straightforward, but opening and closing connections every time is not cool, so we will create a new file called <em>connection.js</em> right on the root of our application.</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4bdf7225286996" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
$ touch ~/Projects/JavaScript/twilio-pa/connection.js</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4bdf7225286996-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4bdf7225286996-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-r">touch</span><span class="crayon-h"> </span><span class="crayon-o">~</span><span class="crayon-o">/</span><span class="crayon-i">Projects</span><span class="crayon-o">/</span><span class="crayon-i">JavaScript</span><span class="crayon-o">/</span><span class="crayon-i">twilio</span><span class="crayon-o">-</span><span class="crayon-i">pa</span><span class="crayon-o">/</span><span class="crayon-v">connection</span><span class="crayon-e">.js</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->
<p>This file will deal with our connection and also make sure we only ever open one of them no matter how many times we access the database.</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4be01604503027" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title">connection.js</span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
var config = require('./config');
var MongoClient = require('mongodb').MongoClient;

var dbSingleton = null;

var getConnection = function getConnection(callback) {
  if (dbSingleton) {
    callback(null, dbSingleton);
  } else {
    var connURL = 'mongodb://' + config.mongoConfig.ip + ':' + config.mongoConfig.port + '/' + config.mongoConfig.name;
    MongoClient.connect(connURL, function(err, db) {

      if (err)
        console.log("Error creating new connection " + err);
      else {
        dbSingleton = db;
        console.log("created new connection");

      }
      callback(err, dbSingleton);
      return;
    });
  }
}

module.exports = getConnection;</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4be01604503027-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be01604503027-2">2</div><div class="crayon-num" data-line="crayon-58794dbb4be01604503027-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be01604503027-4">4</div><div class="crayon-num" data-line="crayon-58794dbb4be01604503027-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be01604503027-6">6</div><div class="crayon-num" data-line="crayon-58794dbb4be01604503027-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be01604503027-8">8</div><div class="crayon-num" data-line="crayon-58794dbb4be01604503027-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be01604503027-10">10</div><div class="crayon-num" data-line="crayon-58794dbb4be01604503027-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be01604503027-12">12</div><div class="crayon-num" data-line="crayon-58794dbb4be01604503027-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be01604503027-14">14</div><div class="crayon-num" data-line="crayon-58794dbb4be01604503027-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be01604503027-16">16</div><div class="crayon-num" data-line="crayon-58794dbb4be01604503027-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be01604503027-18">18</div><div class="crayon-num" data-line="crayon-58794dbb4be01604503027-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be01604503027-20">20</div><div class="crayon-num" data-line="crayon-58794dbb4be01604503027-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be01604503027-22">22</div><div class="crayon-num" data-line="crayon-58794dbb4be01604503027-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be01604503027-24">24</div><div class="crayon-num" data-line="crayon-58794dbb4be01604503027-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be01604503027-26">26</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4be01604503027-1"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">require</span><span class="crayon-sy">(</span><span class="crayon-s">'./config'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be01604503027-2"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">MongoClient</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">require</span><span class="crayon-sy">(</span><span class="crayon-s">'mongodb'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-i">MongoClient</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be01604503027-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be01604503027-4"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">dbSingleton</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">null</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be01604503027-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be01604503027-6"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">getConnection</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">getConnection</span><span class="crayon-sy">(</span><span class="crayon-i">callback</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be01604503027-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-i">dbSingleton</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be01604503027-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">callback</span><span class="crayon-sy">(</span><span class="crayon-t">null</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">dbSingleton</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be01604503027-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be01604503027-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-e ">connURL</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'mongodb://'</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">mongoConfig</span><span class="crayon-sy">.</span><span class="crayon-i">ip</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">':'</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">mongoConfig</span><span class="crayon-sy">.</span><span class="crayon-i">port</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'/'</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">mongoConfig</span><span class="crayon-sy">.</span><span class="crayon-i">name</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be01604503027-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">MongoClient</span><span class="crayon-sy">.</span><span class="crayon-e">connect</span><span class="crayon-sy">(</span><span class="crayon-i">connURL</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">db</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be01604503027-12">&nbsp;</div><div class="crayon-line" id="crayon-58794dbb4be01604503027-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be01604503027-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">"Error creating new connection "</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-i">err</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be01604503027-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be01604503027-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">dbSingleton</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-i">db</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be01604503027-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">"created new connection"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be01604503027-18">&nbsp;</div><div class="crayon-line" id="crayon-58794dbb4be01604503027-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be01604503027-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">callback</span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">dbSingleton</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be01604503027-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be01604503027-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be01604503027-23"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be01604503027-24"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-58794dbb4be01604503027-25">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be01604503027-26"><span class="crayon-v">module</span><span class="crayon-sy">.</span><span class="crayon-v">exports</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-i">getConnection</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0114 seconds] -->
<p>We now have a connection manager, so let’s do a bit of refactoring in <em>app.js</em> around the initialization. We need to authenticate via <a href="http://oauth.net/2/" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://oauth.net/2/', 'OAuth2');">OAuth2</a> in order to get access to our Google Calendar and also add a dependency to our new connection manager. We do so by changing our code as per highlighted section:</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4be0d149317371" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title">app.js</span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
var config = require('./config');
var getConnection = require('./connection');

// Dependency setup
var express = require('express'),
  google = require('googleapis'),
  date = require('datejs'),
  twilio = require('twilio');

// Initialization
var app = express(),
  calendar = google.calendar('v3'),
  oAuthClient = new google.auth.OAuth2(config.googleConfig.clientID, config.googleConfig.clientSecret, config.googleConfig.redirectURL);</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4be0d149317371-1">1</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom crayon-striped-num" data-line="crayon-58794dbb4be0d149317371-2">2</div><div class="crayon-num" data-line="crayon-58794dbb4be0d149317371-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be0d149317371-4">4</div><div class="crayon-num" data-line="crayon-58794dbb4be0d149317371-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be0d149317371-6">6</div><div class="crayon-num" data-line="crayon-58794dbb4be0d149317371-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be0d149317371-8">8</div><div class="crayon-num" data-line="crayon-58794dbb4be0d149317371-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be0d149317371-10">10</div><div class="crayon-num crayon-marked-num crayon-top" data-line="crayon-58794dbb4be0d149317371-11">11</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-58794dbb4be0d149317371-12">12</div><div class="crayon-num crayon-marked-num crayon-bottom" data-line="crayon-58794dbb4be0d149317371-13">13</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4be0d149317371-1"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">require</span><span class="crayon-sy">(</span><span class="crayon-s">'./config'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom crayon-striped-line" id="crayon-58794dbb4be0d149317371-2"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">getConnection</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">require</span><span class="crayon-sy">(</span><span class="crayon-s">'./connection'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be0d149317371-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be0d149317371-4"><span class="crayon-c">// Dependency setup</span></div><div class="crayon-line" id="crayon-58794dbb4be0d149317371-5"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">express</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">require</span><span class="crayon-sy">(</span><span class="crayon-s">'express'</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be0d149317371-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">google</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">require</span><span class="crayon-sy">(</span><span class="crayon-s">'googleapis'</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-58794dbb4be0d149317371-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">date</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">require</span><span class="crayon-sy">(</span><span class="crayon-s">'datejs'</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be0d149317371-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">twilio</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">require</span><span class="crayon-sy">(</span><span class="crayon-s">'twilio'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be0d149317371-9">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be0d149317371-10"><span class="crayon-c">// Initialization</span></div><div class="crayon-line crayon-marked-line crayon-top" id="crayon-58794dbb4be0d149317371-11"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">app</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">express</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-58794dbb4be0d149317371-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">calendar</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">google</span><span class="crayon-sy">.</span><span class="crayon-e">calendar</span><span class="crayon-sy">(</span><span class="crayon-s">'v3'</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-marked-line crayon-bottom" id="crayon-58794dbb4be0d149317371-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">oAuthClient</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">google</span><span class="crayon-sy">.</span><span class="crayon-v">auth</span><span class="crayon-sy">.</span><span class="crayon-e">OAuth2</span><span class="crayon-sy">(</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">googleConfig</span><span class="crayon-sy">.</span><span class="crayon-i">clientID</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">googleConfig</span><span class="crayon-sy">.</span><span class="crayon-i">clientSecret</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">googleConfig</span><span class="crayon-sy">.</span><span class="crayon-i">redirectURL</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0074 seconds] -->
<p>All the information under the <em>config</em> scope is already available to us from the moment we included <em>config.js</em> to our file.</p>
<p>Let’s also create a <em>Calendar Event</em> class under the code above. This class will be helpful for when we need to pass event information around.</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4be17332209326" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
// Event object
var CalendarEvent = function(id, description, location, startTime) {
  this.id = id;
  this.eventName = description;
  this.number = location;
  this.eventTime = Date.parse(startTime);
  this.smsTime = Date.parse(startTime).addMinutes(-5);
};</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4be17332209326-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be17332209326-2">2</div><div class="crayon-num" data-line="crayon-58794dbb4be17332209326-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be17332209326-4">4</div><div class="crayon-num" data-line="crayon-58794dbb4be17332209326-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be17332209326-6">6</div><div class="crayon-num" data-line="crayon-58794dbb4be17332209326-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be17332209326-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4be17332209326-1"><span class="crayon-c">// Event object</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be17332209326-2"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">CalendarEvent</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">description</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">location</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">startTime</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be17332209326-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-r">this</span><span class="crayon-sy">.</span><span class="crayon-v">id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-i">id</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be17332209326-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-r">this</span><span class="crayon-sy">.</span><span class="crayon-v">eventName</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-i">description</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be17332209326-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-r">this</span><span class="crayon-sy">.</span><span class="crayon-v">number</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">location</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be17332209326-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-r">this</span><span class="crayon-sy">.</span><span class="crayon-v">eventTime</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">Date</span><span class="crayon-sy">.</span><span class="crayon-e">parse</span><span class="crayon-sy">(</span><span class="crayon-i">startTime</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be17332209326-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-r">this</span><span class="crayon-sy">.</span><span class="crayon-v">smsTime</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">Date</span><span class="crayon-sy">.</span><span class="crayon-e">parse</span><span class="crayon-sy">(</span><span class="crayon-i">startTime</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">addMinutes</span><span class="crayon-sy">(</span><span class="crayon-o">-</span><span class="crayon-cn">5</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be17332209326-8"><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0053 seconds] -->
<p>Our next task is to modify our existing route so instead of returning “<em>hello world</em>” we get it to do something more meaningful.</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4be22470861648" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title">app.js</span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
app.get('/', function(req, res) {
  getConnection(function(err, db) {
    var collection = db.collection("tokens");
    collection.findOne({}, function(err, tokens) {
      // Check for results
      if (tokens) {
        // If going through here always refresh
        tokenUtils.refreshToken(tokens.refresh_token);
        res.send('authenticated');
      } else {
        tokenUtils.requestToken(res);
      }
    });
  });
});</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4be22470861648-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be22470861648-2">2</div><div class="crayon-num" data-line="crayon-58794dbb4be22470861648-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be22470861648-4">4</div><div class="crayon-num" data-line="crayon-58794dbb4be22470861648-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be22470861648-6">6</div><div class="crayon-num" data-line="crayon-58794dbb4be22470861648-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be22470861648-8">8</div><div class="crayon-num" data-line="crayon-58794dbb4be22470861648-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be22470861648-10">10</div><div class="crayon-num" data-line="crayon-58794dbb4be22470861648-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be22470861648-12">12</div><div class="crayon-num" data-line="crayon-58794dbb4be22470861648-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be22470861648-14">14</div><div class="crayon-num" data-line="crayon-58794dbb4be22470861648-15">15</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4be22470861648-1"><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-s">'/'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">req</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">res</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be22470861648-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">getConnection</span><span class="crayon-sy">(</span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">db</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be22470861648-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">collection</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">db</span><span class="crayon-sy">.</span><span class="crayon-e">collection</span><span class="crayon-sy">(</span><span class="crayon-s">"tokens"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be22470861648-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">collection</span><span class="crayon-sy">.</span><span class="crayon-e">findOne</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">tokens</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be22470861648-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Check for results</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be22470861648-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-i">tokens</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be22470861648-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// If going through here always refresh</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be22470861648-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">tokenUtils</span><span class="crayon-sy">.</span><span class="crayon-e">refreshToken</span><span class="crayon-sy">(</span><span class="crayon-v">tokens</span><span class="crayon-sy">.</span><span class="crayon-i">refresh_token</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be22470861648-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">res</span><span class="crayon-sy">.</span><span class="crayon-e">send</span><span class="crayon-sy">(</span><span class="crayon-s">'authenticated'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be22470861648-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be22470861648-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">tokenUtils</span><span class="crayon-sy">.</span><span class="crayon-e">requestToken</span><span class="crayon-sy">(</span><span class="crayon-i">res</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be22470861648-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-58794dbb4be22470861648-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be22470861648-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be22470861648-15"><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0071 seconds] -->
<p>A few things are going on here. We start off by by checking whether there are already any tokens in the database. They won’t exist the first time we run this script after starting our Node server, so we will always fall into the <em>not authenticated</em> category. This will call a function called <em>requestToken</em>, which we haven’t implemented yet.</p>
<p>The next time we run this same script, the logic at the top of the function will tell us we already have tokens on the database, therefore we only need to refresh them by calling <em>refreshToken</em>, which we also haven’t implemented yet.</p>
<p>We need to refresh the token is because Google only gives us tokens that are valid for 60 minutes for security reasons. If you try to use them after that, your authentication will fail since the token is already invalid. Refreshing it tells Google we need access to that account for a bit longer, and prompts Google to issue us with a new access token valid for another 60 minutes.</p>
<p>Let’s implement some of these utility functions on a new file called <em>~/Projects/JavaScript/twilio-pa/token-utils.js</em>.  Add the following to it.</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4be2d866513922" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title">token-utils.js</span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
var getConnection = require('./connection');

/* 
  Receives a token object and stores it for the first time. 
  This includes the refresh token
*/
var storeToken = function(token) {
    getConnection(function(err, db) {
      // Store our credentials in the database
      var collection = db.collection("tokens");
      var settings = {};
      settings._id = 'token';
      settings.access_token = token.access_token;
      settings.expires_at = new Date(token.expiry_date);
      settings.refresh_token = token.refresh_token;

      collection.save(settings, {
        w: 0
      });
    });
  }
/* 
  Updates an existing token taking care of only updating necessary 
  information. We want to preserve our refresh_token
 */
var updateToken = function(token, db) {
  getConnection(function(err, db) {
    var collection = db.collection("tokens");
    collection.update({
      _id: 'token'
    }, {
      $set: {
        access_token: token.access_token,
        expires_at: new Date(token.expiry_date)
      }
    }, {
      w: 0
    });
  });
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4be2d866513922-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be2d866513922-2">2</div><div class="crayon-num" data-line="crayon-58794dbb4be2d866513922-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be2d866513922-4">4</div><div class="crayon-num" data-line="crayon-58794dbb4be2d866513922-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be2d866513922-6">6</div><div class="crayon-num" data-line="crayon-58794dbb4be2d866513922-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be2d866513922-8">8</div><div class="crayon-num" data-line="crayon-58794dbb4be2d866513922-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be2d866513922-10">10</div><div class="crayon-num" data-line="crayon-58794dbb4be2d866513922-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be2d866513922-12">12</div><div class="crayon-num" data-line="crayon-58794dbb4be2d866513922-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be2d866513922-14">14</div><div class="crayon-num" data-line="crayon-58794dbb4be2d866513922-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be2d866513922-16">16</div><div class="crayon-num" data-line="crayon-58794dbb4be2d866513922-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be2d866513922-18">18</div><div class="crayon-num" data-line="crayon-58794dbb4be2d866513922-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be2d866513922-20">20</div><div class="crayon-num" data-line="crayon-58794dbb4be2d866513922-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be2d866513922-22">22</div><div class="crayon-num" data-line="crayon-58794dbb4be2d866513922-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be2d866513922-24">24</div><div class="crayon-num" data-line="crayon-58794dbb4be2d866513922-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be2d866513922-26">26</div><div class="crayon-num" data-line="crayon-58794dbb4be2d866513922-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be2d866513922-28">28</div><div class="crayon-num" data-line="crayon-58794dbb4be2d866513922-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be2d866513922-30">30</div><div class="crayon-num" data-line="crayon-58794dbb4be2d866513922-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be2d866513922-32">32</div><div class="crayon-num" data-line="crayon-58794dbb4be2d866513922-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be2d866513922-34">34</div><div class="crayon-num" data-line="crayon-58794dbb4be2d866513922-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be2d866513922-36">36</div><div class="crayon-num" data-line="crayon-58794dbb4be2d866513922-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be2d866513922-38">38</div><div class="crayon-num" data-line="crayon-58794dbb4be2d866513922-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be2d866513922-40">40</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4be2d866513922-1"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">getConnection</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">require</span><span class="crayon-sy">(</span><span class="crayon-s">'./connection'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be2d866513922-2">&nbsp;</div><div class="crayon-line" id="crayon-58794dbb4be2d866513922-3"><span class="crayon-c">/* </span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be2d866513922-4"><span class="crayon-c">&nbsp;&nbsp;Receives a token object and stores it for the first time. </span></div><div class="crayon-line" id="crayon-58794dbb4be2d866513922-5"><span class="crayon-c">&nbsp;&nbsp;This includes the refresh token</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be2d866513922-6"><span class="crayon-c">*/</span></div><div class="crayon-line" id="crayon-58794dbb4be2d866513922-7"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">storeToken</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">token</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be2d866513922-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">getConnection</span><span class="crayon-sy">(</span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">db</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be2d866513922-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Store our credentials in the database</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be2d866513922-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">collection</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">db</span><span class="crayon-sy">.</span><span class="crayon-e">collection</span><span class="crayon-sy">(</span><span class="crayon-s">"tokens"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be2d866513922-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">settings</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be2d866513922-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">settings</span><span class="crayon-sy">.</span><span class="crayon-e ">_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'token'</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be2d866513922-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">settings</span><span class="crayon-sy">.</span><span class="crayon-v">access_token</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">token</span><span class="crayon-sy">.</span><span class="crayon-i">access_token</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be2d866513922-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">settings</span><span class="crayon-sy">.</span><span class="crayon-v">expires_at</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-r">Date</span><span class="crayon-sy">(</span><span class="crayon-v">token</span><span class="crayon-sy">.</span><span class="crayon-i">expiry_date</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be2d866513922-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">settings</span><span class="crayon-sy">.</span><span class="crayon-v">refresh_token</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">token</span><span class="crayon-sy">.</span><span class="crayon-i">refresh_token</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be2d866513922-16">&nbsp;</div><div class="crayon-line" id="crayon-58794dbb4be2d866513922-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">collection</span><span class="crayon-sy">.</span><span class="crayon-e">save</span><span class="crayon-sy">(</span><span class="crayon-i">settings</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be2d866513922-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">w:</span><span class="crayon-h"> </span><span class="crayon-cn">0</span></div><div class="crayon-line" id="crayon-58794dbb4be2d866513922-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be2d866513922-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be2d866513922-21"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be2d866513922-22"><span class="crayon-c">/* </span></div><div class="crayon-line" id="crayon-58794dbb4be2d866513922-23"><span class="crayon-c">&nbsp;&nbsp;Updates an existing token taking care of only updating necessary </span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be2d866513922-24"><span class="crayon-c">&nbsp;&nbsp;information. We want to preserve our refresh_token</span></div><div class="crayon-line" id="crayon-58794dbb4be2d866513922-25"><span class="crayon-c"> */</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be2d866513922-26"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">updateToken</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">token</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">db</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be2d866513922-27"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">getConnection</span><span class="crayon-sy">(</span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">db</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be2d866513922-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">collection</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">db</span><span class="crayon-sy">.</span><span class="crayon-e">collection</span><span class="crayon-sy">(</span><span class="crayon-s">"tokens"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be2d866513922-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">collection</span><span class="crayon-sy">.</span><span class="crayon-e">update</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be2d866513922-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">_id:</span><span class="crayon-h"> </span><span class="crayon-s">'token'</span></div><div class="crayon-line" id="crayon-58794dbb4be2d866513922-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be2d866513922-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">$</span><span class="crayon-v">set:</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be2d866513922-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">access_token:</span><span class="crayon-h"> </span><span class="crayon-v">token</span><span class="crayon-sy">.</span><span class="crayon-i">access_token</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be2d866513922-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">expires_at:</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-r">Date</span><span class="crayon-sy">(</span><span class="crayon-v">token</span><span class="crayon-sy">.</span><span class="crayon-i">expiry_date</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-58794dbb4be2d866513922-35"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be2d866513922-36"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be2d866513922-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">w:</span><span class="crayon-h"> </span><span class="crayon-cn">0</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be2d866513922-38"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be2d866513922-39"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be2d866513922-40"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0137 seconds] -->
<p>The above are a couple of utility functions that we use to store and update our tokens. There will always be one single entry in our database after the first authentication and it should always contain a refresh token.</p>
<p>The <em>updateToken</em> function has one caveat: it only updates the data we want it to update instead of updating the entire document. This guarantees our refresh token is always present and never gets overwritten.</p>
<p>Google only returns a refresh token to us the first time we authenticate, so we have to make sure we store it at that time. If you fail to store it for some reason, you can always head to <a href="https://security.google.com/settings/security/permissions" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://security.google.com/settings/security/permissions', 'Google Account Permissions');">Google Account Permissions</a> and revoke the access to Twilio PA. Next time you authenticate again, you will be given a new refresh token.</p>
<p><img alt="twilio-pa_9.png" src="https://lh4.googleusercontent.com/i2MaFWU4BQdIoz-H85O9p5MLWsnb1krVn4l7UOHqTmr-x1QRqQvRMNYrchMVRASePsQBTZ9Hd1i6KoqJMF5ytdT7i6bZ78pOzADU5W88lFQxgFQoVOdP0uaeSKnqa5OgrXY" width="624px;" height="144px;" /></p>
<p>Moving on we will now create two authentication functions that will deal with Google’s authentication servers. These functions can both be used in a situation where we still haven’t authenticated and will need a full set of tokens, or when we have already authenticated and just need retrieve the tokens from the database.</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4be4a962813114" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title">token-utils.js</span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
/* 
  When authenticating for the first time this will generate 
  a token including the refresh token using the code returned by
  Google's authentication page
*/
var authenticateWithCode = function(code, callback, oAuthClient) {
  oAuthClient.getToken(code, function(err, tokens) {
    if (err) {
      console.log('Error authenticating');
      console.log(err);
      return callback(err);
    } else {
      console.log('Successfully authenticated!');
      // Save that token
      storeToken(tokens);

      setCredentials(tokens.access_token, tokens.refresh_token, oAuthClient);
      return callback(null, tokens);
    }
  });
}

/* 
  When authenticating at any other time this will try to 
  authenticate the user with the tokens stored on the DB.
  Failing that (i.e. the token has expired), it will
  refresh that token and store a new one.
*/
var authenticateWithDB = function(oAuthClient) {
  getConnection(function(err, db) {
    var collection = db.collection("tokens");
    collection.findOne({}, function(err, tokens) {
      // if current time &lt; what's saved
      if (Date.compare(Date.today().setTimeToNow(), Date.parse(tokens.expires_at)) == -1) {
        console.log('using existing tokens');
        setCredentials(tokens.access_token, tokens.refresh_token, oAuthClient);
      } else {
        // Token is expired, so needs a refresh
        console.log('getting new tokens');
        setCredentials(tokens.access_token, tokens.refresh_token, oAuthClient);
        refreshToken(tokens.refresh_token, oAuthClient);
      }
    });
  });
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4be4a962813114-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be4a962813114-2">2</div><div class="crayon-num" data-line="crayon-58794dbb4be4a962813114-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be4a962813114-4">4</div><div class="crayon-num" data-line="crayon-58794dbb4be4a962813114-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be4a962813114-6">6</div><div class="crayon-num" data-line="crayon-58794dbb4be4a962813114-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be4a962813114-8">8</div><div class="crayon-num" data-line="crayon-58794dbb4be4a962813114-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be4a962813114-10">10</div><div class="crayon-num" data-line="crayon-58794dbb4be4a962813114-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be4a962813114-12">12</div><div class="crayon-num" data-line="crayon-58794dbb4be4a962813114-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be4a962813114-14">14</div><div class="crayon-num" data-line="crayon-58794dbb4be4a962813114-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be4a962813114-16">16</div><div class="crayon-num" data-line="crayon-58794dbb4be4a962813114-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be4a962813114-18">18</div><div class="crayon-num" data-line="crayon-58794dbb4be4a962813114-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be4a962813114-20">20</div><div class="crayon-num" data-line="crayon-58794dbb4be4a962813114-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be4a962813114-22">22</div><div class="crayon-num" data-line="crayon-58794dbb4be4a962813114-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be4a962813114-24">24</div><div class="crayon-num" data-line="crayon-58794dbb4be4a962813114-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be4a962813114-26">26</div><div class="crayon-num" data-line="crayon-58794dbb4be4a962813114-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be4a962813114-28">28</div><div class="crayon-num" data-line="crayon-58794dbb4be4a962813114-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be4a962813114-30">30</div><div class="crayon-num" data-line="crayon-58794dbb4be4a962813114-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be4a962813114-32">32</div><div class="crayon-num" data-line="crayon-58794dbb4be4a962813114-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be4a962813114-34">34</div><div class="crayon-num" data-line="crayon-58794dbb4be4a962813114-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be4a962813114-36">36</div><div class="crayon-num" data-line="crayon-58794dbb4be4a962813114-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be4a962813114-38">38</div><div class="crayon-num" data-line="crayon-58794dbb4be4a962813114-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be4a962813114-40">40</div><div class="crayon-num" data-line="crayon-58794dbb4be4a962813114-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be4a962813114-42">42</div><div class="crayon-num" data-line="crayon-58794dbb4be4a962813114-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be4a962813114-44">44</div><div class="crayon-num" data-line="crayon-58794dbb4be4a962813114-45">45</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4be4a962813114-1"><span class="crayon-c">/* </span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be4a962813114-2"><span class="crayon-c">&nbsp;&nbsp;When authenticating for the first time this will generate </span></div><div class="crayon-line" id="crayon-58794dbb4be4a962813114-3"><span class="crayon-c">&nbsp;&nbsp;a token including the refresh token using the code returned by</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be4a962813114-4"><span class="crayon-c">&nbsp;&nbsp;Google's authentication page</span></div><div class="crayon-line" id="crayon-58794dbb4be4a962813114-5"><span class="crayon-c">*/</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be4a962813114-6"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">authenticateWithCode</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">code</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">callback</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">oAuthClient</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be4a962813114-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">oAuthClient</span><span class="crayon-sy">.</span><span class="crayon-e">getToken</span><span class="crayon-sy">(</span><span class="crayon-i">code</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">tokens</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be4a962813114-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be4a962813114-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">'Error authenticating'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be4a962813114-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be4a962813114-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">callback</span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be4a962813114-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be4a962813114-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">'Successfully authenticated!'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be4a962813114-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Save that token</span></div><div class="crayon-line" id="crayon-58794dbb4be4a962813114-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">storeToken</span><span class="crayon-sy">(</span><span class="crayon-i">tokens</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be4a962813114-16">&nbsp;</div><div class="crayon-line" id="crayon-58794dbb4be4a962813114-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">setCredentials</span><span class="crayon-sy">(</span><span class="crayon-v">tokens</span><span class="crayon-sy">.</span><span class="crayon-i">access_token</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">.</span><span class="crayon-i">refresh_token</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">oAuthClient</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be4a962813114-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">callback</span><span class="crayon-sy">(</span><span class="crayon-t">null</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">tokens</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be4a962813114-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be4a962813114-20"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be4a962813114-21"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be4a962813114-22">&nbsp;</div><div class="crayon-line" id="crayon-58794dbb4be4a962813114-23"><span class="crayon-c">/* </span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be4a962813114-24"><span class="crayon-c">&nbsp;&nbsp;When authenticating at any other time this will try to </span></div><div class="crayon-line" id="crayon-58794dbb4be4a962813114-25"><span class="crayon-c">&nbsp;&nbsp;authenticate the user with the tokens stored on the DB.</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be4a962813114-26"><span class="crayon-c">&nbsp;&nbsp;Failing that (i.e. the token has expired), it will</span></div><div class="crayon-line" id="crayon-58794dbb4be4a962813114-27"><span class="crayon-c">&nbsp;&nbsp;refresh that token and store a new one.</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be4a962813114-28"><span class="crayon-c">*/</span></div><div class="crayon-line" id="crayon-58794dbb4be4a962813114-29"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">authenticateWithDB</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">oAuthClient</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be4a962813114-30"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">getConnection</span><span class="crayon-sy">(</span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">db</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be4a962813114-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">collection</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">db</span><span class="crayon-sy">.</span><span class="crayon-e">collection</span><span class="crayon-sy">(</span><span class="crayon-s">"tokens"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be4a962813114-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">collection</span><span class="crayon-sy">.</span><span class="crayon-e">findOne</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">tokens</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be4a962813114-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// if current time &lt; what's saved</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be4a962813114-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">Date</span><span class="crayon-sy">.</span><span class="crayon-e">compare</span><span class="crayon-sy">(</span><span class="crayon-v">Date</span><span class="crayon-sy">.</span><span class="crayon-e">today</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">setTimeToNow</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">Date</span><span class="crayon-sy">.</span><span class="crayon-e">parse</span><span class="crayon-sy">(</span><span class="crayon-v">tokens</span><span class="crayon-sy">.</span><span class="crayon-i">expires_at</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be4a962813114-35"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">'using existing tokens'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be4a962813114-36"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">setCredentials</span><span class="crayon-sy">(</span><span class="crayon-v">tokens</span><span class="crayon-sy">.</span><span class="crayon-i">access_token</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">.</span><span class="crayon-i">refresh_token</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">oAuthClient</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be4a962813114-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be4a962813114-38"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Token is expired, so needs a refresh</span></div><div class="crayon-line" id="crayon-58794dbb4be4a962813114-39"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">'getting new tokens'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be4a962813114-40"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">setCredentials</span><span class="crayon-sy">(</span><span class="crayon-v">tokens</span><span class="crayon-sy">.</span><span class="crayon-i">access_token</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">.</span><span class="crayon-i">refresh_token</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">oAuthClient</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be4a962813114-41"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">refreshToken</span><span class="crayon-sy">(</span><span class="crayon-v">tokens</span><span class="crayon-sy">.</span><span class="crayon-i">refresh_token</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">oAuthClient</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be4a962813114-42"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-58794dbb4be4a962813114-43"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be4a962813114-44"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be4a962813114-45"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0177 seconds] -->
<p>The function <em>authenticateWithCode</em> is only used when we’re authenticating for the first time. It will take a code we received back from Google authentication servers and generate a set of tokens, which we store on the database. This function will also tell any calling functions when it’s completed via a callback. This callback is especially useful for when we call this function the first time in <em>app.js</em> and need to make sure the authentication has occurred before we redirect the user.</p>
<p>When we authenticate from the database using <em>authenticateWithDB</em>, we have to check whether the access token is still valid so we can use it. In case it has already expired, we use the function <em>refreshToken</em> as you can see below:</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4be56313454586" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title">token-utils.js</span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
// Refreshes the tokens and gives a new access token
var refreshToken = function(refresh_token, oAuthClient) {
  oAuthClient.refreshAccessToken(function(err, tokens) {
    updateToken(tokens);

    setCredentials(tokens.access_token, refresh_token, oAuthClient);
  });
  console.log('access token refreshed');
}

var setCredentials = function(access_token, refresh_token, oAuthClient) {
  oAuthClient.setCredentials({
    access_token: access_token,
    refresh_token: refresh_token
  });
}

var requestToken = function(res, oAuthClient) {
  // Generate an OAuth URL and redirect there
  var url = oAuthClient.generateAuthUrl({
    access_type: 'offline',
    scope: 'https://www.googleapis.com/auth/calendar.readonly'
  });
  res.redirect(url);
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4be56313454586-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be56313454586-2">2</div><div class="crayon-num" data-line="crayon-58794dbb4be56313454586-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be56313454586-4">4</div><div class="crayon-num" data-line="crayon-58794dbb4be56313454586-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be56313454586-6">6</div><div class="crayon-num" data-line="crayon-58794dbb4be56313454586-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be56313454586-8">8</div><div class="crayon-num" data-line="crayon-58794dbb4be56313454586-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be56313454586-10">10</div><div class="crayon-num" data-line="crayon-58794dbb4be56313454586-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be56313454586-12">12</div><div class="crayon-num" data-line="crayon-58794dbb4be56313454586-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be56313454586-14">14</div><div class="crayon-num" data-line="crayon-58794dbb4be56313454586-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be56313454586-16">16</div><div class="crayon-num" data-line="crayon-58794dbb4be56313454586-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be56313454586-18">18</div><div class="crayon-num" data-line="crayon-58794dbb4be56313454586-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be56313454586-20">20</div><div class="crayon-num" data-line="crayon-58794dbb4be56313454586-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be56313454586-22">22</div><div class="crayon-num" data-line="crayon-58794dbb4be56313454586-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be56313454586-24">24</div><div class="crayon-num" data-line="crayon-58794dbb4be56313454586-25">25</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4be56313454586-1"><span class="crayon-c">// Refreshes the tokens and gives a new access token</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be56313454586-2"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">refreshToken</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">refresh_token</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">oAuthClient</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be56313454586-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">oAuthClient</span><span class="crayon-sy">.</span><span class="crayon-e">refreshAccessToken</span><span class="crayon-sy">(</span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">tokens</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be56313454586-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">updateToken</span><span class="crayon-sy">(</span><span class="crayon-i">tokens</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be56313454586-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be56313454586-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">setCredentials</span><span class="crayon-sy">(</span><span class="crayon-v">tokens</span><span class="crayon-sy">.</span><span class="crayon-i">access_token</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">refresh_token</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">oAuthClient</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be56313454586-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be56313454586-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">'access token refreshed'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be56313454586-9"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be56313454586-10">&nbsp;</div><div class="crayon-line" id="crayon-58794dbb4be56313454586-11"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">setCredentials</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">access_token</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">refresh_token</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">oAuthClient</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be56313454586-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">oAuthClient</span><span class="crayon-sy">.</span><span class="crayon-e">setCredentials</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be56313454586-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">access_token:</span><span class="crayon-h"> </span><span class="crayon-i">access_token</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be56313454586-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">refresh_token:</span><span class="crayon-h"> </span><span class="crayon-i">refresh_token</span></div><div class="crayon-line" id="crayon-58794dbb4be56313454586-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be56313454586-16"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-58794dbb4be56313454586-17">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be56313454586-18"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">requestToken</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">res</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">oAuthClient</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be56313454586-19"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// Generate an OAuth URL and redirect there</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be56313454586-20"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">url</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">oAuthClient</span><span class="crayon-sy">.</span><span class="crayon-e">generateAuthUrl</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be56313454586-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">access_type:</span><span class="crayon-h"> </span><span class="crayon-s">'offline'</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be56313454586-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">scope:</span><span class="crayon-h"> </span><span class="crayon-s">'https://www.googleapis.com/auth/calendar.readonly'</span></div><div class="crayon-line" id="crayon-58794dbb4be56313454586-23"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be56313454586-24"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">res</span><span class="crayon-sy">.</span><span class="crayon-e">redirect</span><span class="crayon-sy">(</span><span class="crayon-i">url</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be56313454586-25"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0094 seconds] -->
<p>The <em>refreshToken</em> and <em>requestToken</em> functions will take care of requesting a new token from Google, or refreshing it should it already be expired. These functions are the only two that actually communicate with google’s authentication servers in order to retrieve or refresh a token.</p>
<p>Finally, we need to make sure some of these functions are available outside of the scope of this file, we do so by exporting them as follows:</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4be62764943673" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title">token-utils.js</span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
module.exports = function(oAuthClient){
  var module = {};

  module.refreshToken = function(refresh_token){
    refreshToken(refresh_token, oAuthClient);
  };

  module.requestToken = function(res){
    requestToken(res, oAuthClient);
  };

  module.authenticateWithCode = function(code, callback){
    authenticateWithCode(code, function(err, data){
      if(err){
        return callback(err)
      }
      callback(null, data);
    }, oAuthClient);
  };

  module.authenticateWithDB = function(){
    authenticateWithDB(oAuthClient);
  };

  return module;
};</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4be62764943673-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be62764943673-2">2</div><div class="crayon-num" data-line="crayon-58794dbb4be62764943673-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be62764943673-4">4</div><div class="crayon-num" data-line="crayon-58794dbb4be62764943673-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be62764943673-6">6</div><div class="crayon-num" data-line="crayon-58794dbb4be62764943673-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be62764943673-8">8</div><div class="crayon-num" data-line="crayon-58794dbb4be62764943673-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be62764943673-10">10</div><div class="crayon-num" data-line="crayon-58794dbb4be62764943673-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be62764943673-12">12</div><div class="crayon-num" data-line="crayon-58794dbb4be62764943673-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be62764943673-14">14</div><div class="crayon-num" data-line="crayon-58794dbb4be62764943673-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be62764943673-16">16</div><div class="crayon-num" data-line="crayon-58794dbb4be62764943673-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be62764943673-18">18</div><div class="crayon-num" data-line="crayon-58794dbb4be62764943673-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be62764943673-20">20</div><div class="crayon-num" data-line="crayon-58794dbb4be62764943673-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be62764943673-22">22</div><div class="crayon-num" data-line="crayon-58794dbb4be62764943673-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be62764943673-24">24</div><div class="crayon-num" data-line="crayon-58794dbb4be62764943673-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be62764943673-26">26</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4be62764943673-1"><span class="crayon-v">module</span><span class="crayon-sy">.</span><span class="crayon-v">exports</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">oAuthClient</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be62764943673-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">module</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be62764943673-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be62764943673-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">module</span><span class="crayon-sy">.</span><span class="crayon-v">refreshToken</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">refresh_token</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be62764943673-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">refreshToken</span><span class="crayon-sy">(</span><span class="crayon-i">refresh_token</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">oAuthClient</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be62764943673-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be62764943673-7">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be62764943673-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">module</span><span class="crayon-sy">.</span><span class="crayon-v">requestToken</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">res</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be62764943673-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">requestToken</span><span class="crayon-sy">(</span><span class="crayon-i">res</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">oAuthClient</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be62764943673-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be62764943673-11">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be62764943673-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">module</span><span class="crayon-sy">.</span><span class="crayon-v">authenticateWithCode</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">code</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">callback</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be62764943673-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">authenticateWithCode</span><span class="crayon-sy">(</span><span class="crayon-i">code</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">data</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be62764943673-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be62764943673-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">callback</span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be62764943673-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-58794dbb4be62764943673-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">callback</span><span class="crayon-sy">(</span><span class="crayon-t">null</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">data</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be62764943673-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">oAuthClient</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be62764943673-19"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be62764943673-20">&nbsp;</div><div class="crayon-line" id="crayon-58794dbb4be62764943673-21"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">module</span><span class="crayon-sy">.</span><span class="crayon-v">authenticateWithDB</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be62764943673-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">authenticateWithDB</span><span class="crayon-sy">(</span><span class="crayon-i">oAuthClient</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be62764943673-23"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be62764943673-24">&nbsp;</div><div class="crayon-line" id="crayon-58794dbb4be62764943673-25"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-i">module</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be62764943673-26"><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0098 seconds] -->
<p>Open up <em>app.js</em> and add the dependency to our new file right after we initialise <em>oAuthClient</em>. We need to do it at this stage since we will pass a reference to <em>oAuthClient</em> into our new file so it can reuse it.</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4be6d357632458" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title">app.js</span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
// Initialization
var app = express(),
  calendar = google.calendar('v3'),
  oAuthClient = new google.auth.OAuth2(config.googleConfig.clientID, config.googleConfig.clientSecret, config.googleConfig.redirectURL),
  tokenUtils = require('./token-utils')(oAuthClient);</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4be6d357632458-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be6d357632458-2">2</div><div class="crayon-num" data-line="crayon-58794dbb4be6d357632458-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be6d357632458-4">4</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom" data-line="crayon-58794dbb4be6d357632458-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4be6d357632458-1"><span class="crayon-c">// Initialization</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be6d357632458-2"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">app</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">express</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-58794dbb4be6d357632458-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">calendar</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">google</span><span class="crayon-sy">.</span><span class="crayon-e">calendar</span><span class="crayon-sy">(</span><span class="crayon-s">'v3'</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be6d357632458-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">oAuthClient</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">google</span><span class="crayon-sy">.</span><span class="crayon-v">auth</span><span class="crayon-sy">.</span><span class="crayon-e">OAuth2</span><span class="crayon-sy">(</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">googleConfig</span><span class="crayon-sy">.</span><span class="crayon-i">clientID</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">googleConfig</span><span class="crayon-sy">.</span><span class="crayon-i">clientSecret</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">googleConfig</span><span class="crayon-sy">.</span><span class="crayon-i">redirectURL</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom" id="crayon-58794dbb4be6d357632458-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">tokenUtils</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">require</span><span class="crayon-sy">(</span><span class="crayon-s">'./token-utils'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-i">oAuthClient</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0044 seconds] -->
<p>Google’s authentication server needs to know where to redirect us to once it has validated that we are authenticated. We already told the authentication servers where to redirect to by setting <em>Authorize Redirect URIs</em> in the developer console to <a href="http://localhost:2002/auth" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://localhost:2002/auth', 'http://localhost:2002/auth');">http://localhost:2002/auth</a> so all we need to do now is create the <em>auth</em> route in <em>app.js</em> underneath the “/” route.</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4be78919637094" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title">app.js</span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
// Return point for oAuth flow
app.get('/auth', function(req, res) {

  var code = req.query.code;

  if (code) {
    tokenUtils.authenticateWithCode(code, function(err, data) {
      if (err) {
        console.log(err);
      } else {
        res.redirect('/');
      }
    });
  }
});</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4be78919637094-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be78919637094-2">2</div><div class="crayon-num" data-line="crayon-58794dbb4be78919637094-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be78919637094-4">4</div><div class="crayon-num" data-line="crayon-58794dbb4be78919637094-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be78919637094-6">6</div><div class="crayon-num" data-line="crayon-58794dbb4be78919637094-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be78919637094-8">8</div><div class="crayon-num" data-line="crayon-58794dbb4be78919637094-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be78919637094-10">10</div><div class="crayon-num" data-line="crayon-58794dbb4be78919637094-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be78919637094-12">12</div><div class="crayon-num" data-line="crayon-58794dbb4be78919637094-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be78919637094-14">14</div><div class="crayon-num" data-line="crayon-58794dbb4be78919637094-15">15</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4be78919637094-1"><span class="crayon-c">// Return point for oAuth flow</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be78919637094-2"><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-s">'/auth'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">req</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">res</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be78919637094-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be78919637094-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">code</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">req</span><span class="crayon-sy">.</span><span class="crayon-v">query</span><span class="crayon-sy">.</span><span class="crayon-i">code</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be78919637094-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be78919637094-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-i">code</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be78919637094-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">tokenUtils</span><span class="crayon-sy">.</span><span class="crayon-e">authenticateWithCode</span><span class="crayon-sy">(</span><span class="crayon-i">code</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">data</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be78919637094-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be78919637094-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be78919637094-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be78919637094-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">res</span><span class="crayon-sy">.</span><span class="crayon-e">redirect</span><span class="crayon-sy">(</span><span class="crayon-s">'/'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be78919637094-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-58794dbb4be78919637094-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be78919637094-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-58794dbb4be78919637094-15"><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0058 seconds] -->
<p>We receive a code back from the request and then get an authentication token generated by passing it to the <em>authenticateWithCode</em> function. We are calling the <em>authenticateWithCode</em> function with a callback as this allows us to know when the authentication cycle has completed.</p>
<p>If the authentication is successful the user is redirected to our entry route “/”.</p>
<p>In case we find the authentication failed, we show an error on the console describing why the authentication failed. This failure could be because you typed your password wrong, or failed to give the correct permissions to view that calendar. Google has <a href="https://developers.google.com/accounts/docs/OAuth2" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://developers.google.com/accounts/docs/OAuth2', 'extensive documentation');">extensive documentation</a> about their OAuth flow in case you want to learn more.</p>
<p>There is one last thing we need to do here, which is change our server initialisation so it tries to authenticate the user upon start-up. This initialisation flow will guarantee we always have a fresh access tokens immediately after we finish loading the database.</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4be83866493625" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title">app.js</span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
var server = app.listen(config.port, function() {
  var host = server.address().address;
  var port = server.address().port;

  // make sure user is authenticated but check for existing tokens first
  getConnection(function(err, db) {
    var collection = db.collection("tokens");
    collection.findOne({}, function(err, tokens) {
      if (tokens) {
        tokenUtils.authenticateWithDB();
      }
    });
  });

  console.log('Listening at http://%s:%s', host, port);
});</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4be83866493625-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be83866493625-2">2</div><div class="crayon-num" data-line="crayon-58794dbb4be83866493625-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be83866493625-4">4</div><div class="crayon-num crayon-marked-num crayon-top" data-line="crayon-58794dbb4be83866493625-5">5</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-58794dbb4be83866493625-6">6</div><div class="crayon-num crayon-marked-num" data-line="crayon-58794dbb4be83866493625-7">7</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-58794dbb4be83866493625-8">8</div><div class="crayon-num crayon-marked-num" data-line="crayon-58794dbb4be83866493625-9">9</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-58794dbb4be83866493625-10">10</div><div class="crayon-num crayon-marked-num" data-line="crayon-58794dbb4be83866493625-11">11</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-58794dbb4be83866493625-12">12</div><div class="crayon-num crayon-marked-num crayon-bottom" data-line="crayon-58794dbb4be83866493625-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be83866493625-14">14</div><div class="crayon-num" data-line="crayon-58794dbb4be83866493625-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be83866493625-16">16</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4be83866493625-1"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">server</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-e">listen</span><span class="crayon-sy">(</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-i">port</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be83866493625-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">host</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">server</span><span class="crayon-sy">.</span><span class="crayon-e">address</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-i">address</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be83866493625-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">port</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">server</span><span class="crayon-sy">.</span><span class="crayon-e">address</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-i">port</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be83866493625-4">&nbsp;</div><div class="crayon-line crayon-marked-line crayon-top" id="crayon-58794dbb4be83866493625-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// make sure user is authenticated but check for existing tokens first</span></div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-58794dbb4be83866493625-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">getConnection</span><span class="crayon-sy">(</span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">db</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-marked-line" id="crayon-58794dbb4be83866493625-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">collection</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">db</span><span class="crayon-sy">.</span><span class="crayon-e">collection</span><span class="crayon-sy">(</span><span class="crayon-s">"tokens"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-58794dbb4be83866493625-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">collection</span><span class="crayon-sy">.</span><span class="crayon-e">findOne</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">tokens</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-marked-line" id="crayon-58794dbb4be83866493625-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-i">tokens</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-58794dbb4be83866493625-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">tokenUtils</span><span class="crayon-sy">.</span><span class="crayon-e">authenticateWithDB</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-marked-line" id="crayon-58794dbb4be83866493625-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-58794dbb4be83866493625-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-marked-line crayon-bottom" id="crayon-58794dbb4be83866493625-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be83866493625-14">&nbsp;</div><div class="crayon-line" id="crayon-58794dbb4be83866493625-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">'Listening at http://%s:%s'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">host</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">port</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be83866493625-16"><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0079 seconds] -->
<p>Start your Node server again and try to hit the application on <a href="http://127.0.0.1:2002/" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://127.0.0.1:2002/', 'http://127.0.0.1:2002/');">http://127.0.0.1:2002</a> you should see the following screen:</p>
<p><img alt="twilio-pa_6.png" src="https://lh4.googleusercontent.com/l-u8TPuMLTWNBSJYAdwp4FUqCB6LgLG9GS4eRrGHaE4zdz7BdVGJXakhiZSjJH16k7u_HnPIhJO4MPXXm7-fUndZfdTN1ZR_D2qfBF8BKLrMnnZ3u1IzU5AjOLg-r65jwxo" width="331px;" height="374px;" /></p>
<p>If you see a screen that asks you to select which account you would like to use, chances are you are already logged in. Clicking on the user that owns the calendar you chose would redirect you to a screen that says “authenticated”.</p>
<p>Congratulations! We have gone through the most excruciating part of this post and everything after here will be a lot more fun.</p>
<h3>Schedules</h3>
<p>Our scheduled tasks will be created using the<a href="https://www.npmjs.com/package/agenda" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://www.npmjs.com/package/agenda', ' Agenda');"> Agenda</a> module. Agenda is a great module for task management as it persists your tasks to a database, so even if you restart your application your tasks will still be runnable when the application starts again.</p>
<p>On your terminal, create a new file called<em> job-schedule.js</em> in the root directory of the application. In my case it is <em>~/Projects/JavaScript/twilio-pa</em>.</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4be8e559246252" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
$ mkdir ~/Projects/JavaScript/twilio-pa/job-schedule.js</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4be8e559246252-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4be8e559246252-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-r">mkdir</span><span class="crayon-h"> </span><span class="crayon-o">~</span><span class="crayon-o">/</span><span class="crayon-i">Projects</span><span class="crayon-o">/</span><span class="crayon-i">JavaScript</span><span class="crayon-o">/</span><span class="crayon-i">twilio</span><span class="crayon-o">-</span><span class="crayon-i">pa</span><span class="crayon-o">/</span><span class="crayon-i">job</span><span class="crayon-o">-</span><span class="crayon-v">schedule</span><span class="crayon-e">.js</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0014 seconds] -->
<p>Open this file up and add the following code to it.</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4be98413578614" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title">job-schedule.js</span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
var Agenda = require("Agenda");
var config = require('./config');
agenda = new Agenda({
  db: {
	address: config.mongoConfig.ip + ':' + config.mongoConfig.port + '/' + config.mongoConfig.name
  }
});
exports.agenda = agenda;</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4be98413578614-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be98413578614-2">2</div><div class="crayon-num" data-line="crayon-58794dbb4be98413578614-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be98413578614-4">4</div><div class="crayon-num" data-line="crayon-58794dbb4be98413578614-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be98413578614-6">6</div><div class="crayon-num" data-line="crayon-58794dbb4be98413578614-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4be98413578614-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4be98413578614-1"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">Agenda</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">require</span><span class="crayon-sy">(</span><span class="crayon-s">"Agenda"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be98413578614-2"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">require</span><span class="crayon-sy">(</span><span class="crayon-s">'./config'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4be98413578614-3"><span class="crayon-v">agenda</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">Agenda</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be98413578614-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">db:</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4be98413578614-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">address:</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">mongoConfig</span><span class="crayon-sy">.</span><span class="crayon-i">ip</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">':'</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">mongoConfig</span><span class="crayon-sy">.</span><span class="crayon-i">port</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'/'</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">mongoConfig</span><span class="crayon-sy">.</span><span class="crayon-i">name</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be98413578614-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-58794dbb4be98413578614-7"><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4be98413578614-8"><span class="crayon-v">exports</span><span class="crayon-sy">.</span><span class="crayon-v">agenda</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-i">agenda</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0049 seconds] -->
<p>All the information to initialize the module is being read from our configuration file. If later on we decided to change one of the settings like which port MongoDB runs, all we would have to do is change the configuration file.</p>
<p>Create a new directory in the root of our application called <em>jobs</em>. This directory contains the definitions for the two scheduled tasks we want to create – Send SMS and Start Call.</p>
<p>On your terminal you can create the directory as such:</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4bea3851736919" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
$ mkdir ~/Projects/JavaScript/twilio-pa/jobs</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4bea3851736919-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4bea3851736919-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-r">mkdir</span><span class="crayon-h"> </span><span class="crayon-o">~</span><span class="crayon-o">/</span><span class="crayon-i">Projects</span><span class="crayon-o">/</span><span class="crayon-i">JavaScript</span><span class="crayon-o">/</span><span class="crayon-i">twilio</span><span class="crayon-o">-</span><span class="crayon-i">pa</span><span class="crayon-o">/</span><span class="crayon-r">jobs</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->
<p>In this directory create a file called <em>send-sms.js</em>. This file is one of our scheduled tasks definitions and contains all the logic to send outbound SMS.</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4bead758928568" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title">send-sms.js</span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
var config = require('../config');
var twilio = require('twilio');
// Create a new REST API client to make authenticated requests against the
// twilio back end
var client = new twilio.RestClient(config.twilioConfig.accountSid, config.twilioConfig.authToken);

exports.send = function(agenda, event, task, number) {
  agenda.define(task, function(job, done) {
    client.sendSms({
      to: number,
      from: config.twilioConfig.number,
      body: 'Your call ('+ event.eventName +') will start in 5 minutes. Make sure you\'re in a quiet place'
    }, function(error, message) {
      if (!error) {
        console.log('Success! The SID for this SMS message is:');
        console.log(message.sid);
        console.log('Message sent on:');
        console.log(message.dateCreated);
        console.log(message.to);
      } else {
        console.log(error);
        console.log('Oops! There was an error.');
      }
    });
    done();
  });
  agenda.create(task).schedule(event.smsTime).unique({'id': event.id}).save();
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4bead758928568-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bead758928568-2">2</div><div class="crayon-num" data-line="crayon-58794dbb4bead758928568-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bead758928568-4">4</div><div class="crayon-num" data-line="crayon-58794dbb4bead758928568-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bead758928568-6">6</div><div class="crayon-num" data-line="crayon-58794dbb4bead758928568-7">7</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom crayon-striped-num" data-line="crayon-58794dbb4bead758928568-8">8</div><div class="crayon-num" data-line="crayon-58794dbb4bead758928568-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bead758928568-10">10</div><div class="crayon-num" data-line="crayon-58794dbb4bead758928568-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bead758928568-12">12</div><div class="crayon-num" data-line="crayon-58794dbb4bead758928568-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bead758928568-14">14</div><div class="crayon-num" data-line="crayon-58794dbb4bead758928568-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bead758928568-16">16</div><div class="crayon-num" data-line="crayon-58794dbb4bead758928568-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bead758928568-18">18</div><div class="crayon-num" data-line="crayon-58794dbb4bead758928568-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bead758928568-20">20</div><div class="crayon-num" data-line="crayon-58794dbb4bead758928568-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bead758928568-22">22</div><div class="crayon-num" data-line="crayon-58794dbb4bead758928568-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bead758928568-24">24</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom" data-line="crayon-58794dbb4bead758928568-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bead758928568-26">26</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom" data-line="crayon-58794dbb4bead758928568-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bead758928568-28">28</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4bead758928568-1"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">require</span><span class="crayon-sy">(</span><span class="crayon-s">'../config'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bead758928568-2"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">twilio</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">require</span><span class="crayon-sy">(</span><span class="crayon-s">'twilio'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4bead758928568-3"><span class="crayon-c">// Create a new REST API client to make authenticated requests against the</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bead758928568-4"><span class="crayon-c">// twilio back end</span></div><div class="crayon-line" id="crayon-58794dbb4bead758928568-5"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">client</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">twilio</span><span class="crayon-sy">.</span><span class="crayon-e">RestClient</span><span class="crayon-sy">(</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">twilioConfig</span><span class="crayon-sy">.</span><span class="crayon-i">accountSid</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">twilioConfig</span><span class="crayon-sy">.</span><span class="crayon-i">authToken</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bead758928568-6">&nbsp;</div><div class="crayon-line" id="crayon-58794dbb4bead758928568-7"><span class="crayon-v">exports</span><span class="crayon-sy">.</span><span class="crayon-v">send</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">agenda</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">event</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">task</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">number</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom crayon-striped-line" id="crayon-58794dbb4bead758928568-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">agenda</span><span class="crayon-sy">.</span><span class="crayon-e">define</span><span class="crayon-sy">(</span><span class="crayon-i">task</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">job</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">done</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4bead758928568-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">sendSms</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bead758928568-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">to</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-i">number</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-58794dbb4bead758928568-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">from:</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">twilioConfig</span><span class="crayon-sy">.</span><span class="crayon-i">number</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bead758928568-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">body:</span><span class="crayon-h"> </span><span class="crayon-s">'Your call ('</span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">event</span><span class="crayon-sy">.</span><span class="crayon-i">eventName</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-s">') will start in 5 minutes. Make sure you\'re in a quiet place'</span></div><div class="crayon-line" id="crayon-58794dbb4bead758928568-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">error</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">message</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bead758928568-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">!</span><span class="crayon-i">error</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4bead758928568-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">'Success! The SID for this SMS message is:'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bead758928568-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-v">message</span><span class="crayon-sy">.</span><span class="crayon-i">sid</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4bead758928568-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">'Message sent on:'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bead758928568-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-v">message</span><span class="crayon-sy">.</span><span class="crayon-i">dateCreated</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4bead758928568-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-v">message</span><span class="crayon-sy">.</span><span class="crayon-st">to</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bead758928568-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4bead758928568-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-i">error</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bead758928568-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">'Oops! There was an error.'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4bead758928568-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bead758928568-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom" id="crayon-58794dbb4bead758928568-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">done</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bead758928568-26"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom" id="crayon-58794dbb4bead758928568-27"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">agenda</span><span class="crayon-sy">.</span><span class="crayon-e">create</span><span class="crayon-sy">(</span><span class="crayon-i">task</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">schedule</span><span class="crayon-sy">(</span><span class="crayon-v">event</span><span class="crayon-sy">.</span><span class="crayon-i">smsTime</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">unique</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span><span class="crayon-s">'id'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">event</span><span class="crayon-sy">.</span><span class="crayon-i">id</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">save</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bead758928568-28"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0152 seconds] -->
<p>We are again using our configuration file but also now importing the Twilio library which will make it much easier for us to interact with the Twilio API.</p>
<p>All the code surrounded by the highlighted bit of code is what we want to have executed on our scheduled task.</p>
<p>The <em>send</em> method takes four arguments, the <em>Agenda</em> object initialized by <em>job-schedule.js</em>, a <em>CalendarEvent</em> object, a task name and a telephone number.</p>
<p>In the last highlighted bit, we make sure our tasks are scheduled at the time we want them to run as defined in the <em>CalendarEvent</em> object and are also making sure our tasks are created uniquely. This step is very important as it will guarantee the tasks aren’t created over and over again every time the script runs. It will also take care of any updates to that event such as a different telephone number or time changes.</p>
<p>Create another job called <em>start-call.js</em>. The job is similar to the one we just created above but as the name says it is responsible for starting telephone calls. This is the job that is going to run at the time of the meeting and connect us with the person we are meant to be with on a call.</p>
<p>For this step Twilio will need to be able to connect to our local application. We could handle the connection in two ways, by either deploying to it a public web server, or using <a href="https://ngrok.com/" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://ngrok.com/', 'ngrok');">ngrok</a> to expose our local environment via tunneling. We will go with option two here to make things easier. My colleague <a href="http://twitter.com/kevinwhinnery" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://twitter.com/kevinwhinnery', 'Kevin Whinery');">Kevin Whinery</a> wrote a great blog post on <a href="https://www.twilio.com/blog/2013/10/test-your-webhooks-locally-with-ngrok.html" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://www.twilio.com/blog/2013/10/test-your-webhooks-locally-with-ngrok.html', 'getting up and running with ngrok');">getting up and running with ngrok</a>.</p>
<p>Once you have Ngrok installed get it connected to your app by opening up another terminal screen and running:</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4beb9413753915" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
$ ngrok 2002</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4beb9413753915-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4beb9413753915-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-i">ngrok</span><span class="crayon-h"> </span><span class="crayon-cn">2002</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->
<p>Once it is running, it will acquire a unique URL for our application, and this is what we will use as the URL attribute for the <em>makeCall</em> method.</p>
<p><img alt="twilio-pa_7.png" src="https://lh5.googleusercontent.com/tUq9mKfv4GkXNarqhl8D-xbji5foI8BQ7LkXRONyDZ8oaup-vCAqWn5sQt1XYDl-UBWF5L3RwjfnQYlVHIBuDI9Mta5wt80VFPhh5AbTfGkAQGJ18JrVaD_tVrKSNLrRa9Q" width="624px;" height="136px;" /></p>
<p>Make a note of this Forwarding URL as you will need to use it on the code below.</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4bec4678282645" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title">start-call.js</span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
var config = require('../config');
var twilio = require('twilio');
// Create a new REST API client to make authenticated requests against the
// twilio back end
var client = new twilio.RestClient(config.twilioConfig.accountSid, config.twilioConfig.authToken);

exports.call = function(agenda, event, task, number) {
  agenda.define(task, function(job, done) {
    // Place a phone call, and respond with TwiML instructions from the given URL
    client.makeCall({

      to: number, // Any number Twilio can call
      from: config.twilioConfig.number, // A number you bought from Twilio and can use for outbound communication
      url: 'http://300dcd5b.ngrok.com/call/?number=' + event.number + '&amp;eventName=' + encodeURIComponent(event.eventName) // A URL that produces an XML document (TwiML) which contains instructions for the call

    }, function(err, responseData) {
      if (err) {
        console.log(err);
      } else {
        // executed when the call has been initiated.
        console.log(responseData.from);
      }
    });
    done();
  });
  agenda.create(task).schedule(event.eventTime).unique({
    'id': event.id
  }).save();
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4bec4678282645-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bec4678282645-2">2</div><div class="crayon-num" data-line="crayon-58794dbb4bec4678282645-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bec4678282645-4">4</div><div class="crayon-num" data-line="crayon-58794dbb4bec4678282645-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bec4678282645-6">6</div><div class="crayon-num" data-line="crayon-58794dbb4bec4678282645-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bec4678282645-8">8</div><div class="crayon-num" data-line="crayon-58794dbb4bec4678282645-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bec4678282645-10">10</div><div class="crayon-num" data-line="crayon-58794dbb4bec4678282645-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bec4678282645-12">12</div><div class="crayon-num" data-line="crayon-58794dbb4bec4678282645-13">13</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom crayon-striped-num" data-line="crayon-58794dbb4bec4678282645-14">14</div><div class="crayon-num" data-line="crayon-58794dbb4bec4678282645-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bec4678282645-16">16</div><div class="crayon-num" data-line="crayon-58794dbb4bec4678282645-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bec4678282645-18">18</div><div class="crayon-num" data-line="crayon-58794dbb4bec4678282645-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bec4678282645-20">20</div><div class="crayon-num" data-line="crayon-58794dbb4bec4678282645-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bec4678282645-22">22</div><div class="crayon-num" data-line="crayon-58794dbb4bec4678282645-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bec4678282645-24">24</div><div class="crayon-num" data-line="crayon-58794dbb4bec4678282645-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bec4678282645-26">26</div><div class="crayon-num" data-line="crayon-58794dbb4bec4678282645-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bec4678282645-28">28</div><div class="crayon-num" data-line="crayon-58794dbb4bec4678282645-29">29</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4bec4678282645-1"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">require</span><span class="crayon-sy">(</span><span class="crayon-s">'../config'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bec4678282645-2"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">twilio</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">require</span><span class="crayon-sy">(</span><span class="crayon-s">'twilio'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4bec4678282645-3"><span class="crayon-c">// Create a new REST API client to make authenticated requests against the</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bec4678282645-4"><span class="crayon-c">// twilio back end</span></div><div class="crayon-line" id="crayon-58794dbb4bec4678282645-5"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">client</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">twilio</span><span class="crayon-sy">.</span><span class="crayon-e">RestClient</span><span class="crayon-sy">(</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">twilioConfig</span><span class="crayon-sy">.</span><span class="crayon-i">accountSid</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">twilioConfig</span><span class="crayon-sy">.</span><span class="crayon-i">authToken</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bec4678282645-6">&nbsp;</div><div class="crayon-line" id="crayon-58794dbb4bec4678282645-7"><span class="crayon-v">exports</span><span class="crayon-sy">.</span><span class="crayon-v">call</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">agenda</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">event</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">task</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">number</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bec4678282645-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">agenda</span><span class="crayon-sy">.</span><span class="crayon-e">define</span><span class="crayon-sy">(</span><span class="crayon-i">task</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">job</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">done</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4bec4678282645-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Place a phone call, and respond with TwiML instructions from the given URL</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bec4678282645-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">makeCall</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4bec4678282645-11">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bec4678282645-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">to</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-i">number</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// Any number Twilio can call</span></div><div class="crayon-line" id="crayon-58794dbb4bec4678282645-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">from:</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">twilioConfig</span><span class="crayon-sy">.</span><span class="crayon-i">number</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// A number you bought from Twilio and can use for outbound communication</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom crayon-striped-line" id="crayon-58794dbb4bec4678282645-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">url:</span><span class="crayon-h"> </span><span class="crayon-s">'http://300dcd5b.ngrok.com/call/?number='</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">event</span><span class="crayon-sy">.</span><span class="crayon-i">number</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'&amp;eventName='</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">encodeURIComponent</span><span class="crayon-sy">(</span><span class="crayon-v">event</span><span class="crayon-sy">.</span><span class="crayon-i">eventName</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-c">// A URL that produces an XML document (TwiML) which contains instructions for the call</span></div><div class="crayon-line" id="crayon-58794dbb4bec4678282645-15">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bec4678282645-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">responseData</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4bec4678282645-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bec4678282645-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4bec4678282645-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bec4678282645-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// executed when the call has been initiated.</span></div><div class="crayon-line" id="crayon-58794dbb4bec4678282645-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-v">responseData</span><span class="crayon-sy">.</span><span class="crayon-i">from</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bec4678282645-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-58794dbb4bec4678282645-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bec4678282645-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">done</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4bec4678282645-25"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bec4678282645-26"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">agenda</span><span class="crayon-sy">.</span><span class="crayon-e">create</span><span class="crayon-sy">(</span><span class="crayon-i">task</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">schedule</span><span class="crayon-sy">(</span><span class="crayon-v">event</span><span class="crayon-sy">.</span><span class="crayon-i">eventTime</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">unique</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4bec4678282645-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">'id'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">event</span><span class="crayon-sy">.</span><span class="crayon-i">id</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bec4678282645-28"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">save</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4bec4678282645-29"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0146 seconds] -->
<p>Open up <em>app.js</em> on the project root again and include the schedule task definitions we’ve just created. These should go between our <em>initialization</em> and <em>Event Object</em>:</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4becf638429423" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title">app.js</span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
// Initialization
var app = express(),
  calendar = google.calendar('v3'),
  oAuthClient = new google.auth.OAuth2(config.googleConfig.clientID, config.googleConfig.clientSecret, config.googleConfig.redirectURL),
  tokenUtils = require('./token-utils')(oAuthClient);

// Schedule setup
var jobSchedule = require('./job-schedule.js'),
  smsJob = require('./jobs/send-sms.js'),
  callJob = require('./jobs/start-call.js');
// Event object
var CalendarEvent = function(id, description, location, startTime) {
  this.id = id;
  this.eventName = description;
  this.number = location;
  this.eventTime = Date.parse(startTime);
  this.smsTime = Date.parse(startTime).addMinutes(-5);
};</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4becf638429423-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4becf638429423-2">2</div><div class="crayon-num" data-line="crayon-58794dbb4becf638429423-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4becf638429423-4">4</div><div class="crayon-num" data-line="crayon-58794dbb4becf638429423-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4becf638429423-6">6</div><div class="crayon-num crayon-marked-num crayon-top" data-line="crayon-58794dbb4becf638429423-7">7</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-58794dbb4becf638429423-8">8</div><div class="crayon-num crayon-marked-num" data-line="crayon-58794dbb4becf638429423-9">9</div><div class="crayon-num crayon-marked-num crayon-bottom crayon-striped-num" data-line="crayon-58794dbb4becf638429423-10">10</div><div class="crayon-num" data-line="crayon-58794dbb4becf638429423-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4becf638429423-12">12</div><div class="crayon-num" data-line="crayon-58794dbb4becf638429423-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4becf638429423-14">14</div><div class="crayon-num" data-line="crayon-58794dbb4becf638429423-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4becf638429423-16">16</div><div class="crayon-num" data-line="crayon-58794dbb4becf638429423-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4becf638429423-18">18</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4becf638429423-1"><span class="crayon-c">// Initialization</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4becf638429423-2"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">app</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">express</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-58794dbb4becf638429423-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">calendar</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">google</span><span class="crayon-sy">.</span><span class="crayon-e">calendar</span><span class="crayon-sy">(</span><span class="crayon-s">'v3'</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4becf638429423-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">oAuthClient</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">google</span><span class="crayon-sy">.</span><span class="crayon-v">auth</span><span class="crayon-sy">.</span><span class="crayon-e">OAuth2</span><span class="crayon-sy">(</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">googleConfig</span><span class="crayon-sy">.</span><span class="crayon-i">clientID</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">googleConfig</span><span class="crayon-sy">.</span><span class="crayon-i">clientSecret</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">googleConfig</span><span class="crayon-sy">.</span><span class="crayon-i">redirectURL</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-58794dbb4becf638429423-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">tokenUtils</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">require</span><span class="crayon-sy">(</span><span class="crayon-s">'./token-utils'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-i">oAuthClient</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4becf638429423-6">&nbsp;</div><div class="crayon-line crayon-marked-line crayon-top" id="crayon-58794dbb4becf638429423-7"><span class="crayon-c">// Schedule setup</span></div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-58794dbb4becf638429423-8"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">jobSchedule</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">require</span><span class="crayon-sy">(</span><span class="crayon-s">'./job-schedule.js'</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-marked-line" id="crayon-58794dbb4becf638429423-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">smsJob</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">require</span><span class="crayon-sy">(</span><span class="crayon-s">'./jobs/send-sms.js'</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-marked-line crayon-bottom crayon-striped-line" id="crayon-58794dbb4becf638429423-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">callJob</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">require</span><span class="crayon-sy">(</span><span class="crayon-s">'./jobs/start-call.js'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4becf638429423-11"><span class="crayon-c">// Event object</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4becf638429423-12"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">CalendarEvent</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">description</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">location</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">startTime</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4becf638429423-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-r">this</span><span class="crayon-sy">.</span><span class="crayon-v">id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-i">id</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4becf638429423-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-r">this</span><span class="crayon-sy">.</span><span class="crayon-v">eventName</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-i">description</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4becf638429423-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-r">this</span><span class="crayon-sy">.</span><span class="crayon-v">number</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">location</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4becf638429423-16"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-r">this</span><span class="crayon-sy">.</span><span class="crayon-v">eventTime</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">Date</span><span class="crayon-sy">.</span><span class="crayon-e">parse</span><span class="crayon-sy">(</span><span class="crayon-i">startTime</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4becf638429423-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-r">this</span><span class="crayon-sy">.</span><span class="crayon-v">smsTime</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">Date</span><span class="crayon-sy">.</span><span class="crayon-e">parse</span><span class="crayon-sy">(</span><span class="crayon-i">startTime</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">addMinutes</span><span class="crayon-sy">(</span><span class="crayon-o">-</span><span class="crayon-cn">5</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4becf638429423-18"><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0112 seconds] -->
<p>On our server initialization, we will now add another recurring scheduled task that will fetch any calendar events for us every 10 minutes. That way, you don’t need to manually run the script every time</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4bed9441948623" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title">app.js</span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
var server = app.listen(config.port, function() {
  var host = server.address().address;
  var port = server.address().port;

  // make sure user is authenticated but check for existing tokens first
  getConnection(function(err, db) {
    var collection = db.collection("tokens");
    collection.findOne({}, function(err, tokens) {
      if (tokens) {
        tokenUtils.authenticateWithDB(db);
      }
    });
  });

  jobSchedule.agenda.define('fetch events', function(job, done) {
    fetchAndSchedule();
    done();
  });

  jobSchedule.agenda.every('10 minutes', 'fetch events');

  // Initialize the task scheduler
  jobSchedule.agenda.start();

  console.log('Listening at http://%s:%s', host, port);
});</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4bed9441948623-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bed9441948623-2">2</div><div class="crayon-num" data-line="crayon-58794dbb4bed9441948623-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bed9441948623-4">4</div><div class="crayon-num" data-line="crayon-58794dbb4bed9441948623-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bed9441948623-6">6</div><div class="crayon-num" data-line="crayon-58794dbb4bed9441948623-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bed9441948623-8">8</div><div class="crayon-num" data-line="crayon-58794dbb4bed9441948623-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bed9441948623-10">10</div><div class="crayon-num" data-line="crayon-58794dbb4bed9441948623-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bed9441948623-12">12</div><div class="crayon-num" data-line="crayon-58794dbb4bed9441948623-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bed9441948623-14">14</div><div class="crayon-num crayon-marked-num crayon-top" data-line="crayon-58794dbb4bed9441948623-15">15</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-58794dbb4bed9441948623-16">16</div><div class="crayon-num crayon-marked-num" data-line="crayon-58794dbb4bed9441948623-17">17</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-58794dbb4bed9441948623-18">18</div><div class="crayon-num crayon-marked-num" data-line="crayon-58794dbb4bed9441948623-19">19</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-58794dbb4bed9441948623-20">20</div><div class="crayon-num crayon-marked-num" data-line="crayon-58794dbb4bed9441948623-21">21</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-58794dbb4bed9441948623-22">22</div><div class="crayon-num crayon-marked-num crayon-bottom" data-line="crayon-58794dbb4bed9441948623-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bed9441948623-24">24</div><div class="crayon-num" data-line="crayon-58794dbb4bed9441948623-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bed9441948623-26">26</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4bed9441948623-1"><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">server</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-e">listen</span><span class="crayon-sy">(</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-i">port</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bed9441948623-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">host</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">server</span><span class="crayon-sy">.</span><span class="crayon-e">address</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-i">address</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4bed9441948623-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">port</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">server</span><span class="crayon-sy">.</span><span class="crayon-e">address</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-i">port</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bed9441948623-4">&nbsp;</div><div class="crayon-line" id="crayon-58794dbb4bed9441948623-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// make sure user is authenticated but check for existing tokens first</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bed9441948623-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">getConnection</span><span class="crayon-sy">(</span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">db</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4bed9441948623-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">collection</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">db</span><span class="crayon-sy">.</span><span class="crayon-e">collection</span><span class="crayon-sy">(</span><span class="crayon-s">"tokens"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bed9441948623-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">collection</span><span class="crayon-sy">.</span><span class="crayon-e">findOne</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">tokens</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4bed9441948623-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-i">tokens</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bed9441948623-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">tokenUtils</span><span class="crayon-sy">.</span><span class="crayon-e">authenticateWithDB</span><span class="crayon-sy">(</span><span class="crayon-i">db</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4bed9441948623-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bed9441948623-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4bed9441948623-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bed9441948623-14">&nbsp;</div><div class="crayon-line crayon-marked-line crayon-top" id="crayon-58794dbb4bed9441948623-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">jobSchedule</span><span class="crayon-sy">.</span><span class="crayon-v">agenda</span><span class="crayon-sy">.</span><span class="crayon-e">define</span><span class="crayon-sy">(</span><span class="crayon-s">'fetch events'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">job</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">done</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-58794dbb4bed9441948623-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">fetchAndSchedule</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-marked-line" id="crayon-58794dbb4bed9441948623-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">done</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-58794dbb4bed9441948623-18"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-marked-line" id="crayon-58794dbb4bed9441948623-19">&nbsp;</div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-58794dbb4bed9441948623-20"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">jobSchedule</span><span class="crayon-sy">.</span><span class="crayon-v">agenda</span><span class="crayon-sy">.</span><span class="crayon-e">every</span><span class="crayon-sy">(</span><span class="crayon-s">'10 minutes'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'fetch events'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-marked-line" id="crayon-58794dbb4bed9441948623-21">&nbsp;</div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-58794dbb4bed9441948623-22"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// Initialize the task scheduler</span></div><div class="crayon-line crayon-marked-line crayon-bottom" id="crayon-58794dbb4bed9441948623-23"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">jobSchedule</span><span class="crayon-sy">.</span><span class="crayon-v">agenda</span><span class="crayon-sy">.</span><span class="crayon-e">start</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bed9441948623-24">&nbsp;</div><div class="crayon-line" id="crayon-58794dbb4bed9441948623-25"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">'Listening at http://%s:%s'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">host</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">port</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bed9441948623-26"><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0119 seconds] -->
<p>The highlighted parts are the ones we have just added for the recurring task.</p>
<p>You will notice we are making a call to a function called fetchAndSchedule. This function is responsible for fetching all our calendar events every time it’s called by the scheduled task. Under the CalendarEvent function place the following code:</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4bee4009080653" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title">app.js</span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
function fetchAndSchedule() {
  // Set obj variables
  var id, eventName, number, start;

  // Call google to fetch events for today on our calendar
  calendar.events.list({
    calendarId: config.googleConfig.calendarId,
    maxResults: 20,
    timeMax: Date.parse('tomorrow').addSeconds(-1).toISOString(), // any entries until the end of today
    updatedMin: new Date().clearTime().toISOString(), // that have been created today
    auth: oAuthClient
  }, function(err, events) {
    if (err) {
      console.log('Error fetching events');
      console.log(err);
    } else {
      // Send our JSON response back to the browser
      console.log('Successfully fetched events');

      for (var i = 0; i &lt; events.items.length; i++) {
        // populate CalendarEvent object with the event info
        event = new CalendarEvent(events.items[i].id, events.items[i].summary, events.items[i].location, events.items[i].start.dateTime);

        // Filter results 
        // ones with telephone numbers in them 
        // that are happening in the future (current time &lt; event time)
        if (event.number.match(/\+[0-9 ]+/) &amp;&amp; (Date.compare(Date.today().setTimeToNow(), Date.parse(event.eventTime)) == -1)) {

          // SMS Job
          smsJob.send(jobSchedule.agenda, event, 'sms#1', config.ownNumber);

          // Call Job
          callJob.call(jobSchedule.agenda, event, "call#1", config.ownNumber);
        }
      }

    }
  });
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4bee4009080653-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bee4009080653-2">2</div><div class="crayon-num" data-line="crayon-58794dbb4bee4009080653-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bee4009080653-4">4</div><div class="crayon-num" data-line="crayon-58794dbb4bee4009080653-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bee4009080653-6">6</div><div class="crayon-num" data-line="crayon-58794dbb4bee4009080653-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bee4009080653-8">8</div><div class="crayon-num" data-line="crayon-58794dbb4bee4009080653-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bee4009080653-10">10</div><div class="crayon-num" data-line="crayon-58794dbb4bee4009080653-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bee4009080653-12">12</div><div class="crayon-num" data-line="crayon-58794dbb4bee4009080653-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bee4009080653-14">14</div><div class="crayon-num" data-line="crayon-58794dbb4bee4009080653-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bee4009080653-16">16</div><div class="crayon-num" data-line="crayon-58794dbb4bee4009080653-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bee4009080653-18">18</div><div class="crayon-num" data-line="crayon-58794dbb4bee4009080653-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bee4009080653-20">20</div><div class="crayon-num" data-line="crayon-58794dbb4bee4009080653-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bee4009080653-22">22</div><div class="crayon-num" data-line="crayon-58794dbb4bee4009080653-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bee4009080653-24">24</div><div class="crayon-num" data-line="crayon-58794dbb4bee4009080653-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bee4009080653-26">26</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom" data-line="crayon-58794dbb4bee4009080653-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bee4009080653-28">28</div><div class="crayon-num" data-line="crayon-58794dbb4bee4009080653-29">29</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom crayon-striped-num" data-line="crayon-58794dbb4bee4009080653-30">30</div><div class="crayon-num" data-line="crayon-58794dbb4bee4009080653-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bee4009080653-32">32</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom" data-line="crayon-58794dbb4bee4009080653-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bee4009080653-34">34</div><div class="crayon-num" data-line="crayon-58794dbb4bee4009080653-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bee4009080653-36">36</div><div class="crayon-num" data-line="crayon-58794dbb4bee4009080653-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bee4009080653-38">38</div><div class="crayon-num" data-line="crayon-58794dbb4bee4009080653-39">39</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4bee4009080653-1"><span class="crayon-t">function</span><span class="crayon-h"> </span><span class="crayon-e">fetchAndSchedule</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bee4009080653-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// Set obj variables</span></div><div class="crayon-line" id="crayon-58794dbb4bee4009080653-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-i">id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">eventName</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">number</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">start</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bee4009080653-4">&nbsp;</div><div class="crayon-line" id="crayon-58794dbb4bee4009080653-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// Call google to fetch events for today on our calendar</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bee4009080653-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">calendar</span><span class="crayon-sy">.</span><span class="crayon-v">events</span><span class="crayon-sy">.</span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4bee4009080653-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">calendarId:</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">googleConfig</span><span class="crayon-sy">.</span><span class="crayon-i">calendarId</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bee4009080653-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">maxResults:</span><span class="crayon-h"> </span><span class="crayon-cn">20</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-58794dbb4bee4009080653-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">timeMax:</span><span class="crayon-h"> </span><span class="crayon-v">Date</span><span class="crayon-sy">.</span><span class="crayon-e">parse</span><span class="crayon-sy">(</span><span class="crayon-s">'tomorrow'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">addSeconds</span><span class="crayon-sy">(</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">toISOString</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// any entries until the end of today</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bee4009080653-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">updatedMin:</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-r">Date</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">clearTime</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">toISOString</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-c">// that have been created today</span></div><div class="crayon-line" id="crayon-58794dbb4bee4009080653-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">auth:</span><span class="crayon-h"> </span><span class="crayon-i">oAuthClient</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bee4009080653-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">events</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4bee4009080653-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bee4009080653-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">'Error fetching events'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4bee4009080653-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-i">err</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bee4009080653-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4bee4009080653-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Send our JSON response back to the browser</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bee4009080653-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-s">'Successfully fetched events'</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4bee4009080653-19">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bee4009080653-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">events</span><span class="crayon-sy">.</span><span class="crayon-v">items</span><span class="crayon-sy">.</span><span class="crayon-i">length</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4bee4009080653-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// populate CalendarEvent object with the event info</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bee4009080653-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">event</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">CalendarEvent</span><span class="crayon-sy">(</span><span class="crayon-v">events</span><span class="crayon-sy">.</span><span class="crayon-v">items</span><span class="crayon-sy">[</span><span class="crayon-i">i</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-i">id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">events</span><span class="crayon-sy">.</span><span class="crayon-v">items</span><span class="crayon-sy">[</span><span class="crayon-i">i</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-i">summary</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">events</span><span class="crayon-sy">.</span><span class="crayon-v">items</span><span class="crayon-sy">[</span><span class="crayon-i">i</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-i">location</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">events</span><span class="crayon-sy">.</span><span class="crayon-v">items</span><span class="crayon-sy">[</span><span class="crayon-i">i</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">start</span><span class="crayon-sy">.</span><span class="crayon-i">dateTime</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4bee4009080653-23">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bee4009080653-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Filter results </span></div><div class="crayon-line" id="crayon-58794dbb4bee4009080653-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// ones with telephone numbers in them </span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bee4009080653-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// that are happening in the future (current time &lt; event time)</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom" id="crayon-58794dbb4bee4009080653-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">event</span><span class="crayon-sy">.</span><span class="crayon-v">number</span><span class="crayon-sy">.</span><span class="crayon-e">match</span><span class="crayon-sy">(</span><span class="crayon-o">/</span><span class="crayon-sy">\</span><span class="crayon-o">+</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-o">-</span><span class="crayon-cn">9</span><span class="crayon-h"> </span><span class="crayon-sy">]</span><span class="crayon-o">+</span><span class="crayon-o">/</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;&amp;</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">Date</span><span class="crayon-sy">.</span><span class="crayon-e">compare</span><span class="crayon-sy">(</span><span class="crayon-v">Date</span><span class="crayon-sy">.</span><span class="crayon-e">today</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">setTimeToNow</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">Date</span><span class="crayon-sy">.</span><span class="crayon-e">parse</span><span class="crayon-sy">(</span><span class="crayon-v">event</span><span class="crayon-sy">.</span><span class="crayon-i">eventTime</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bee4009080653-28">&nbsp;</div><div class="crayon-line" id="crayon-58794dbb4bee4009080653-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// SMS Job</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom crayon-striped-line" id="crayon-58794dbb4bee4009080653-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">smsJob</span><span class="crayon-sy">.</span><span class="crayon-e">send</span><span class="crayon-sy">(</span><span class="crayon-v">jobSchedule</span><span class="crayon-sy">.</span><span class="crayon-i">agenda</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">event</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'sms#1'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-i">ownNumber</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4bee4009080653-31">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bee4009080653-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Call Job</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom" id="crayon-58794dbb4bee4009080653-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">callJob</span><span class="crayon-sy">.</span><span class="crayon-e">call</span><span class="crayon-sy">(</span><span class="crayon-v">jobSchedule</span><span class="crayon-sy">.</span><span class="crayon-i">agenda</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">event</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"call#1"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-i">ownNumber</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bee4009080653-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-58794dbb4bee4009080653-35"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bee4009080653-36">&nbsp;</div><div class="crayon-line" id="crayon-58794dbb4bee4009080653-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bee4009080653-38"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4bee4009080653-39"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0209 seconds] -->
<p>Once today’s events return we loop through them to get their information.</p>
<p>We then filter these events with a regular expression to only get the ones that have a telephone number in the location field, and also check for events happening after the current time. Each match then populates a new <em>CalendarEvent</em> object with the information from the event.</p>
<p>Lastly, we set up the scheduled tasks by passing event information through to each of our task definitions. We do that once for SMS and once for a call.</p>
<h3>Making the call</h3>
<p>It is a good time for us to create our <em>/call</em> route. Still on <em>app.js</em> add the following just below the <em>fetchAndSchedule</em> function.</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4bef1579491164" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title">app.js</span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
app.post('/call', function(req, res) {
  var number = req.query.number;
  var eventName = req.query.eventName;
  var resp = new twilio.TwimlResponse();
  resp.say('Your meeting ' + eventName + ' is starting.', {
    voice: 'alice',
    language: 'en-gb'
  }).dial(number);

  res.writeHead(200, {
    'Content-Type': 'text/xml'
  });
  res.end(resp.toString());
});</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4bef1579491164-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bef1579491164-2">2</div><div class="crayon-num" data-line="crayon-58794dbb4bef1579491164-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bef1579491164-4">4</div><div class="crayon-num" data-line="crayon-58794dbb4bef1579491164-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bef1579491164-6">6</div><div class="crayon-num" data-line="crayon-58794dbb4bef1579491164-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bef1579491164-8">8</div><div class="crayon-num" data-line="crayon-58794dbb4bef1579491164-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bef1579491164-10">10</div><div class="crayon-num" data-line="crayon-58794dbb4bef1579491164-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bef1579491164-12">12</div><div class="crayon-num" data-line="crayon-58794dbb4bef1579491164-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bef1579491164-14">14</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4bef1579491164-1"><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-e">post</span><span class="crayon-sy">(</span><span class="crayon-s">'/call'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-i">req</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">res</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bef1579491164-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">number</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">req</span><span class="crayon-sy">.</span><span class="crayon-v">query</span><span class="crayon-sy">.</span><span class="crayon-i">number</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4bef1579491164-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">eventName</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">req</span><span class="crayon-sy">.</span><span class="crayon-v">query</span><span class="crayon-sy">.</span><span class="crayon-i">eventName</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bef1579491164-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-t">var</span><span class="crayon-h"> </span><span class="crayon-v">resp</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-v">twilio</span><span class="crayon-sy">.</span><span class="crayon-e">TwimlResponse</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4bef1579491164-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">resp</span><span class="crayon-sy">.</span><span class="crayon-e">say</span><span class="crayon-sy">(</span><span class="crayon-s">'Your meeting '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-i">eventName</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' is starting.'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bef1579491164-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">voice:</span><span class="crayon-h"> </span><span class="crayon-s">'alice'</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-58794dbb4bef1579491164-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">language:</span><span class="crayon-h"> </span><span class="crayon-s">'en-gb'</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bef1579491164-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">dial</span><span class="crayon-sy">(</span><span class="crayon-i">number</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4bef1579491164-9">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bef1579491164-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">res</span><span class="crayon-sy">.</span><span class="crayon-e">writeHead</span><span class="crayon-sy">(</span><span class="crayon-cn">200</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-58794dbb4bef1579491164-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-s">'Content-Type'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">'text/xml'</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bef1579491164-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-58794dbb4bef1579491164-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">res</span><span class="crayon-sy">.</span><span class="crayon-st">end</span><span class="crayon-sy">(</span><span class="crayon-v">resp</span><span class="crayon-sy">.</span><span class="crayon-e">toString</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bef1579491164-14"><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0077 seconds] -->
<p>What the above code does is play a message and dial out to the person you’re supposed to have a call with.</p>
<h3>Running our app</h3>
<p>At this point our application is ready, and we should be able to run it and authenticate.</p>
<p>Make sure you have a calendar entry for today and that the entry has a telephone number on the location field.</p>
<p>Start your Node server again.</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4befc294510247" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
$ node app.js</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4befc294510247-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4befc294510247-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">node </span><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-i">js</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->
<p>Fire up your browser to<a href="http://127.0.0.1:2002/" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://127.0.0.1:2002/', ' http://127.0.0.1:2002');"> http://127.0.0.1:2002</a> and you should the the word “Authenticated” show up on the screen. If you have calendar entries for today, the script will pick them up and add them to the database.</p>
<p>If you would like to confirm whether any new entries have been added as scheduled tasks, you can query MongoDB via terminal on a new terminal screen:</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4bf06092781556" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
$ mongo twilio-pa
$ db.agendaJobs.find()</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4bf06092781556-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-58794dbb4bf06092781556-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4bf06092781556-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">mongo </span><span class="crayon-i">twilio</span><span class="crayon-o">-</span><span class="crayon-i">pa</span></div><div class="crayon-line crayon-striped-line" id="crayon-58794dbb4bf06092781556-2"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-v">db</span><span class="crayon-e">.agendaJobs</span><span class="crayon-e">.find</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->
<p>All the entries you have with names and timestamps will now be listed. Sure enough you will notice an SMS message coming in 5 minutes prior to the meeting starting and then a call from your Twilio number at the time of the meeting.</p>
<p>You can do the same to query your token information by running:</p><!-- Crayon Syntax Highlighter v2.4.3 -->

		<div id="crayon-58794dbb4bf10169806843" class="crayon-syntax crayon-theme-github crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover expand" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 16px !important; line-height: 24px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 16px !important;height: 24px !important; line-height: 24px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 22.4px !important; line-height: 22.4px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="off" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:2; -o-tab-size:2; -webkit-tab-size:2; tab-size:2; font-size: 16px !important; line-height: 24px !important;">
$ db.tokens.find()</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-num" data-line="crayon-58794dbb4bf10169806843-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 16px !important; line-height: 24px !important;"><div class="crayon-line" id="crayon-58794dbb4bf10169806843-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-v">db</span><span class="crayon-sy">.</span><span class="crayon-v">tokens</span><span class="crayon-sy">.</span><span class="crayon-e">find</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0009 seconds] -->
<p></p>
<h3>Your Twilio PA is alive!</h3>
<p>And there you go, within only a few steps we have built our own Twilio PA, which will handle our outgoing calls for us and guarantee we will never again be 11 minutes late to that call.</p>
<p>Ideally, I’d like my meeting reminders to be more forceful and also trigger a siren at the time it sends me an SMS. That would for sure get me out of the room and ready for that call. How about adding an interface that lets you see all future scheduled tasks? Well, maybe that’s an idea for Twilio PA v2.0.</p>
<p>I would love to hear about the wonderful ways you can make your Twilio PA do more work for you and let you focus on other work that can’t be easily automated.</p>
<p>I look forward to seeing your hacks. Reach me out on Twitter <a href="https://twitter.com/marcos_placona" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://twitter.com/marcos_placona', '@marcos_placona');">@marcos_placona</a>, by email on marcos@twilio.com or <a href="https://plus.google.com/+MarcosPlacona" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://plus.google.com/+MarcosPlacona', 'MarcosPlacona');">MarcosPlacona</a> on G+ to tell me more about it.</p>
			</div>
					</div>
	</div><!-- .entry-content -->

	<footer class="entry-footer col-md-12">
		<div class="entry-meta">
					<div class="social-buttons">
			<div class="fb-like" data-href="https://www.twilio.com/blog/2015/02/building-your-own-personal-assistant-with-twilio-and-google-calendar.html" data-layout="button" data-action="like" data-show-faces="false" data-share="false"></div>
			<a href="https://twitter.com/share" class="twitter-share-button" data-via="twilio" data-count="none" data-url="https://www.twilio.com/blog/2015/02/building-your-own-personal-assistant-with-twilio-and-google-calendar.html" data-text="Building your own personal assistant with Twilio and Google Calendar ">Tweet</a>
      <a href="https://twitter.com/twilio" class="twitter-follow-button" data-show-count="false">Follow @twilio</a>
		</div>
<span class="author-avatar"><img alt='' src='https://secure.gravatar.com/avatar/7dd1a57a4498988a0573a5f43efef18e?s=20&amp;d=mm&amp;r=g' srcset='https://secure.gravatar.com/avatar/7dd1a57a4498988a0573a5f43efef18e?s=40&amp;d=mm&amp;r=g 2x' class='avatar avatar-20 photo' height='20' width='20' /></span><span class="byline"> by <span class="author vcard"><a class="url fn n" href="https://www.twilio.com/blog/author/marcos">Marcos Placona</a></span></span> <span class="author-meta author-email"><a href="mailto:mplacona@twilio.com">mplacona@twilio.com</a></span><span class="author-meta author-twitter"><a href="http://twitter.com/marcos_placona">@marcos_placona<a/></span>		</div>
	</footer><!-- .entry-footer -->

   <div class="build-more"><h3>Build More With JavaScript</h3>        <a href="https://www.twilio.com/docs/tutorials/walkthrough/server-notifications/node/express" onclick="__gaTracker('send', 'event', 'buildmore-widget', 'https://www.twilio.com/docs/tutorials/walkthrough/server-notifications/node/express', '');">
          <h5>SMS and MMS Notifications with Node.js</h5>
        </a>
              <a href="https://www.twilio.com/blog/2015/01/twilio-on-rails-part-3-adding-contextual-voip-using-webrtc-to-your-rails-4-app.html" rel="bookmark" title="Permanent Link to Twilio on Rails Part 3 &#8211; Adding Contextual VOIP Using WebRTC to Your Rails 4 App" onclick="__gaTracker('send', 'event', 'buildmore-widget', 'https://www.twilio.com/blog/2015/01/twilio-on-rails-part-3-adding-contextual-voip-using-webrtc-to-your-rails-4-app.html', '');">
          <h5>Twilio on Rails Part 3 &#8211; Adding Contextual VOIP Using WebRTC to Your Rails 4 App<h4>
        </a>
                <a href="https://www.twilio.com/blog/2015/02/answering-health-questions-via-sms-with-ibm-watson-and-twilio.html" rel="bookmark" title="Permanent Link to Answering Health Questions via SMS with IBM Watson and Twilio" onclick="__gaTracker('send', 'event', 'buildmore-widget', 'https://www.twilio.com/blog/2015/02/answering-health-questions-via-sms-with-ibm-watson-and-twilio.html', '');">
          <h5>Answering Health Questions via SMS with IBM Watson and Twilio<h4>
        </a>
                <a href="https://www.twilio.com/blog/2015/03/create-a-browser-based-photobooth-with-javascript-php-and-twilio.html" rel="bookmark" title="Permanent Link to Create a Browser-Based Photobooth with JavaScript, PHP and Twilio" onclick="__gaTracker('send', 'event', 'buildmore-widget', 'https://www.twilio.com/blog/2015/03/create-a-browser-based-photobooth-with-javascript-php-and-twilio.html', '');">
          <h5>Create a Browser-Based Photobooth with JavaScript, PHP and Twilio<h4>
        </a>
        </div>
</article><!-- #post-## -->

			
<div id="disqus_thread">
                    <div id="dsq-content">


            <ul id="dsq-comments">
                    <li class="comment even thread-even depth-1" id="dsq-comment-3389">
        <div id="dsq-comment-header-3389" class="dsq-comment-header">
            <cite id="dsq-cite-3389">
                <span id="dsq-author-user-3389">Paul</span>
            </cite>
        </div>
        <div id="dsq-comment-body-3389" class="dsq-comment-body">
            <div id="dsq-comment-message-3389" class="dsq-comment-message"><p>Great article Marcos.<br />
I&#8217;m going to tweak this to dial me into a conference call if that exists. The problem is that I will probably have to &#8216;standardize&#8217; the way those types of meetings get put into my Google Calendar.</p>
<p>Also, thanks for introducing me to the agenda module.  :)</p>
</div>
        </div>

    <ul class="children">
    <li class="comment odd alt depth-2" id="dsq-comment-3390">
        <div id="dsq-comment-header-3390" class="dsq-comment-header">
            <cite id="dsq-cite-3390">
                <span id="dsq-author-user-3390">Marcos Placona</span>
            </cite>
        </div>
        <div id="dsq-comment-body-3390" class="dsq-comment-body">
            <div id="dsq-comment-message-3390" class="dsq-comment-message"><p>Thanks Paul,</p>
<p>You&#8217;re right, I thought about doing something like this as well. Maybe having specific characters in the location field that would &#8220;tell&#8221; my PA what kind of call this was. It&#8217;s highly configurable, so you can do anything you fancy :-)</p>
<p>Let me know what you come up with.</p>
</div>
        </div>

    </li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
    <li class="comment even thread-odd thread-alt depth-1" id="dsq-comment-3411">
        <div id="dsq-comment-header-3411" class="dsq-comment-header">
            <cite id="dsq-cite-3411">
                <span id="dsq-author-user-3411">Mike Endale</span>
            </cite>
        </div>
        <div id="dsq-comment-body-3411" class="dsq-comment-body">
            <div id="dsq-comment-message-3411" class="dsq-comment-message"><p>Marcos Placona, cool article.</p>
<p>My startup actually solved this annoying pain point with an elegant solution. We&#8217;re calling it Callr and it makes it so you never have to remember<br />
      a conference number/passcode again. It understands context and figures out the correct number so you do not have to. It syncs with Google/Outlook/iOS/Android calendars and either calls (or texts) you when you have a<br />
      conference call and automatically patches you in. It also works<br />
      for regular calls. No more searching your calendar/email for phone<br />
      numbers.</p>
<p>It was also featured on TechCrunch last week; check it out: <a href="http://techcrunch.com/2015/03/11/callr-ios-app/" onclick="__gaTracker('send', 'event', 'outbound-comment', 'http://techcrunch.com/2015/03/11/callr-ios-app/', 'http://techcrunch.com/2015/03/11/callr-ios-app/');" rel="nofollow">http://techcrunch.com/2015/03/11/callr-ios-app/</a> &#8212; would love to have you try it.</p>
</div>
        </div>

    </li><!-- #comment-## -->
    <li class="comment odd alt thread-even depth-1" id="dsq-comment-4332">
        <div id="dsq-comment-header-4332" class="dsq-comment-header">
            <cite id="dsq-cite-4332">
                <span id="dsq-author-user-4332">jaider luis anillo garcia</span>
            </cite>
        </div>
        <div id="dsq-comment-body-4332" class="dsq-comment-body">
            <div id="dsq-comment-message-4332" class="dsq-comment-message"><p>Hi Marcos!  An excellente post, but i need write in the google calendar&#8230;&#8230;. how i do this?.</p>
<p>Thanks!</p>
</div>
        </div>

    <ul class="children">
    <li class="comment even depth-2" id="dsq-comment-4333">
        <div id="dsq-comment-header-4333" class="dsq-comment-header">
            <cite id="dsq-cite-4333">
                <span id="dsq-author-user-4333">Marcos Placona</span>
            </cite>
        </div>
        <div id="dsq-comment-body-4333" class="dsq-comment-body">
            <div id="dsq-comment-message-4333" class="dsq-comment-message"><p>Hi Jaider, thanks for coming by. The Events API has an Insert method which will do exactly that. Have a look here: <a href="https://developers.google.com/google-apps/calendar/v3/reference/events/insert" onclick="__gaTracker('send', 'event', 'outbound-comment', 'https://developers.google.com/google-apps/calendar/v3/reference/events/insert', 'https://developers.google.com/google-apps/calendar/v3/reference/events/insert');" rel="nofollow">https://developers.google.com/google-apps/calendar/v3/reference/events/insert</a></p>
</div>
        </div>

    <ul class="children">
    <li class="comment odd alt depth-3" id="dsq-comment-4334">
        <div id="dsq-comment-header-4334" class="dsq-comment-header">
            <cite id="dsq-cite-4334">
                <span id="dsq-author-user-4334">jaider luis anillo garcia</span>
            </cite>
        </div>
        <div id="dsq-comment-body-4334" class="dsq-comment-body">
            <div id="dsq-comment-message-4334" class="dsq-comment-message"><p>Thanks for your quick response. Yes i did it, and the response a server is:  &#8220;There was an error contacting the Calendar service: Error: Insufficient Permission&#8221;. i am using the example of the site. Any suggestions</p>
</div>
        </div>

    <ul class="children">
    <li class="comment even depth-4" id="dsq-comment-4337">
        <div id="dsq-comment-header-4337" class="dsq-comment-header">
            <cite id="dsq-cite-4337">
                <span id="dsq-author-user-4337">jaider luis anillo garcia</span>
            </cite>
        </div>
        <div id="dsq-comment-body-4337" class="dsq-comment-body">
            <div id="dsq-comment-message-4337" class="dsq-comment-message"><p>The solution is revoke access&#8230;..and change scope in token-utils&#8230;</p>
</div>
        </div>

    </li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
            </ul>


        </div>

    </div>

<script type="text/javascript">
/* <![CDATA[ */
    var disqus_url = 'https://www.twilio.com/blog/2015/02/building-your-own-personal-assistant-with-twilio-and-google-calendar.html';
    var disqus_identifier = 'https://www.twilio.com/blog/2015/02/14689 http://twilioinc.wpengine.com/?p=14689';
    var disqus_container_id = 'disqus_thread';
    var disqus_domain = 'disqus.com';
    var disqus_shortname = 'twilioblog';
    var disqus_title = "Building your own personal assistant with Twilio and Google Calendar";
        var disqus_config = function () {
        var config = this; // Access to the config object
        config.language = '';

        /*
           All currently supported events:
            * preData — fires just before we request for initial data
            * preInit - fires after we get initial data but before we load any dependencies
            * onInit  - fires when all dependencies are resolved but before dtpl template is rendered
            * afterRender - fires when template is rendered but before we show it
            * onReady - everything is done
         */

        config.callbacks.preData.push(function() {
            // clear out the container (its filled for SEO/legacy purposes)
            document.getElementById(disqus_container_id).innerHTML = '';
        });
                config.callbacks.onReady.push(function() {
            // sync comments in the background so we don't block the page
            var script = document.createElement('script');
            script.async = true;
            script.src = 'https://www.twilio.com/blog/2015/02/building-your-own-personal-assistant-with-twilio-and-google-calendar.html?cf_action=sync_comments&amp;post_id=14689';

            var firstScript = document.getElementsByTagName( "script" )[0];
            firstScript.parentNode.insertBefore(script, firstScript);
        });
                    };
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
    var DsqLocal = {
        'trackbacks': [
        ],
        'trackback_url': "https:\/\/www.twilio.com\/blog\/2015\/02\/building-your-own-personal-assistant-with-twilio-and-google-calendar.html\/trackback"    };
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.' + 'disqus.com' + '/embed.js?pname=wordpress&pver=2.74';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
/* ]]> */
</script>

		
		</main><!-- #main -->
	</div><!-- #primary -->


<div id="secondary" class="widget-area col-md-3 hide-xs" role="complementary">
	<aside id="search-2" class="widget widget_search"><form role="search" method="get" class="search-form" action="https://www.twilio.com/blog/">
				<label>
					<span class="screen-reader-text">Search for:</span>
					<input type="search" class="search-field" placeholder="Search &hellip;" value="" name="s" />
				</label>
				<input type="submit" class="search-submit" value="Search" />
			</form></aside><aside id="text-2" class="widget widget_text">			<div class="textwidget"><p>Power modern communications. Build the next generation of voice and SMS applications.</p>

 <a href="http://twilio.com/try-twilio" onclick="__gaTracker('send', 'event', 'outbound-widget', 'http://twilio.com/try-twilio', 'Start Building For Free');" class="btn">Start Building For Free</a></div>
		</aside><style scoped type="text/css">.utcw-8ngloje {word-wrap:break-word}.utcw-8ngloje span,.utcw-8ngloje a{border-style:solid;border-width:1px}.utcw-8ngloje span:hover,.utcw-8ngloje a:hover{border-style:solid;border-width:1px}</style><aside id="utcw-2" class="widget widget_utcw widget_tag_cloud"><h1 class="widget-title">Posts By Stack</h1><div class="utcw-8ngloje tagcloud"><a class="tag-link-22 utcw-tag utcw-tag-net" href="https://www.twilio.com/blog/tag/net" style="font-size:16px" title="40 topics">.NET</a> <a class="tag-link-98 utcw-tag utcw-tag-arduino" href="https://www.twilio.com/blog/tag/arduino" style="font-size:16px" title="21 topics">Arduino</a> <a class="tag-link-598 utcw-tag utcw-tag-java" href="https://www.twilio.com/blog/tag/java" style="font-size:16px" title="14 topics">Java</a> <a class="tag-link-600 utcw-tag utcw-tag-javascript" href="https://www.twilio.com/blog/tag/javascript" style="font-size:16px" title="86 topics">JavaScript</a> <a class="tag-link-847 utcw-tag utcw-tag-php" href="https://www.twilio.com/blog/tag/php" style="font-size:16px" title="57 topics">PHP</a> <a class="tag-link-891 utcw-tag utcw-tag-python" href="https://www.twilio.com/blog/tag/python" style="font-size:16px" title="72 topics">Python</a> <a class="tag-link-969 utcw-tag utcw-tag-ruby" href="https://www.twilio.com/blog/tag/ruby" style="font-size:16px" title="69 topics">Ruby</a> <a class="tag-link-2856 utcw-tag utcw-tag-swift" href="https://www.twilio.com/blog/tag/swift" style="font-size:16px" title="22 topics">Swift</a></div></aside><style scoped type="text/css">.utcw-5dkhj5o {word-wrap:break-word}.utcw-5dkhj5o span,.utcw-5dkhj5o a{border-style:solid;border-width:1px}.utcw-5dkhj5o span:hover,.utcw-5dkhj5o a:hover{border-style:solid;border-width:1px}</style><aside id="utcw-3" class="widget widget_utcw widget_tag_cloud"><h1 class="widget-title">Posts By Product</h1><div class="utcw-5dkhj5o tagcloud"><a class="tag-link-2043 utcw-tag utcw-tag-mms" href="https://www.twilio.com/blog/tag/mms" style="font-size:16px" title="50 topics">MMS</a> <a class="tag-link-3513 utcw-tag utcw-tag-programmable-chat" href="https://www.twilio.com/blog/tag/programmable-chat" style="font-size:16px" title="9 topics">Programmable Chat</a> <a class="tag-link-1537 utcw-tag utcw-tag-sip" href="https://www.twilio.com/blog/tag/sip" style="font-size:16px" title="15 topics">SIP</a> <a class="tag-link-1031 utcw-tag utcw-tag-sms" href="https://www.twilio.com/blog/tag/sms" style="font-size:16px" title="372 topics">SMS</a> <a class="tag-link-2871 utcw-tag utcw-tag-taskrouter" href="https://www.twilio.com/blog/tag/taskrouter" style="font-size:16px" title="8 topics">Task Router</a> <a class="tag-link-1199 utcw-tag utcw-tag-twilio-client" href="https://www.twilio.com/blog/tag/twilio-client" style="font-size:16px" title="32 topics">Twilio Client</a> <a class="tag-link-3032 utcw-tag utcw-tag-twilio-video" href="https://www.twilio.com/blog/tag/twilio-video" style="font-size:16px" title="9 topics">Twilio Video</a> <a class="tag-link-1277 utcw-tag utcw-tag-voice" href="https://www.twilio.com/blog/tag/voice" style="font-size:16px" title="172 topics">Voice</a></div></aside><aside id="text-5" class="widget widget_text">			<div class="textwidget"><a href="http://www.twilio.com/docs/tutorials" onclick="__gaTracker('send', 'event', 'outbound-widget', 'http://www.twilio.com/docs/tutorials', '');"><img src="https://www.twilio.com/blog/wp-content/uploads/2016/07/tutorials.png" style="width: 255px" /></a></div>
		</aside><aside id="categories-3" class="widget widget_categories"><h1 class="widget-title">Categories</h1>		<ul>
	<li class="cat-item cat-item-13"><a href="https://www.twilio.com/blog/all-things-code" >Code, Tutorials and Hacks</a>
</li>
	<li class="cat-item cat-item-5"><a href="https://www.twilio.com/blog/customer-highlights" >Customer Highlights</a>
</li>
	<li class="cat-item cat-item-7"><a href="https://www.twilio.com/blog/developers-drawing-the-owl" >Developers Drawing The Owl</a>
</li>
	<li class="cat-item cat-item-3"><a href="https://www.twilio.com/blog/news" >News</a>
</li>
	<li class="cat-item cat-item-4"><a href="https://www.twilio.com/blog/stories-from-the-road" >Stories From The Road</a>
</li>
	<li class="cat-item cat-item-8"><a href="https://www.twilio.com/blog/inside-twilio" >The Owl’s Nest: Inside Twilio</a>
</li>
		</ul>
</aside><aside id="text-4" class="widget widget_text">			<div class="textwidget"><div class="tagcloud "><a href="http://www.twilio.com/blog/feed" onclick="__gaTracker('send', 'event', 'outbound-widget', 'http://www.twilio.com/blog/feed', 'RSS Feed');">RSS Feed</a></div></div>
		</aside></div><!-- #secondary -->

		</div><!-- .row -->
	</div><!-- #content.container -->

<div class="" id="footer">
	<div class="container">
		<header>
			<div class="banner"></div>
			<div class="border"></div>
			<div class="stitching"></div>
		</header>
    <div class="row sitemap">
      <div class="row">
        <div class="col-md-2 col-md-offset-1">
          <h4><a href="http://www.twilio.com/company">Company</a></h4>
          <ul>
            <li><a href="http://www.twilio.com/company">About Twilio</a></li>
            <li><a href="http://www.twilio.com/company/nine-values">Our Nine Values</a></li>
            <li><a href="http://www.twilio.com/company/leadership-principles">Our Leadership Principles</a></li>
            <li><a href="http://www.twilio.com/company/management">The Team</a></li>
            <li><a href="http://www.twilio.com/press">Press &amp; Media</a></li>
            <li><a href="http://www.twilio.org/">Twilio.org</a></li>
            <li><a href="http://www.twilio.com/company/jobs">Careers</a></li>
          </ul>
        </div>
        <div class="col-md-2">
          <h4><a href="http://www.twilio.com/products">Products</a></h4>
          <ul>
            <li><a href="http://www.twilio.com/voice">Voice</a></li>
            <li><a href="http://www.twilio.com/video">Video</a></li>
            <li><a href="http://www.twilio.com/sms">SMS (Text Messaging)</a></li>
            <li><a href="http://www.twilio.com/mms">MMS (Picture Messaging)</a></li>
            <li><a href="http://www.twilio.com/sms/toll-free">Toll-Free SMS</a></li>
            <li><a href="http://www.twilio.com/sip-trunking">SIP Trunking</a></li>
            <li><a href="http://www.twilio.com/client/mobile">Client Mobile</a></li>
            <li><a href="http://www.twilio.com/webrtc">Client WebRTC</a></li>
            <li><a href="http://www.twilio.com/stun-turn">Network Traversal Service</a></li>
            <li><a href="http://www.twilio.com/taskrouter">TaskRouter</a></li>
            <li><a href="http://www.twilio.com/sms/phone-numbers">Phone Numbers</a></li>
            <li><a href="http://www.twilio.com/sms/shortcodes">Short Codes</a></li>
            <li><a href="http://www.twilio.com/support-plans">Support Plans</a></li>
            <li><a href="http://www.twilio.com/platform">Platform</a></li>
            <li><a href="http://www.twilio.com/lookup">Lookup</a></li>
            <li><a href="http://www.twilio.com/monitor">Monitor</a></li>
            <li><a href="http://www.twilio.com/copilot">Messaging Copilot</a></li>
            <li><a href="http://www.twilio.com/voice/conference">Global Conference</a></li>
            <li><a href="http://www.twilio.com/authy">Authy</a></li>
          </ul>
      </div>
      <div class="col-md-2">
        <h4><a href="http://www.twilio.com/pricing">Pricing</a></h4>
        <ul>
          <li><a href="http://www.twilio.com/voice/pricing">Voice Pricing</a></li>
          <li><a href="http://www.twilio.com/sms/pricing">Messaging Pricing</a></li>
          <li><a href="http://www.twilio.com/sip-trunking/pricing">SIP Trunking Pricing</a></li>
          <li><a href="http://www.twilio.com/client/pricing">Client Pricing</a></li>
          <li><a href="http://www.twilio.com/stun-turn/pricing">Network Traversal Pricing</a></li>
          <li><a href="http://www.twilio.com/taskrouter/pricing">TaskRouter</a></li>
          <li><a href="http://www.twilio.com/lookup#pricing">Lookup</a></li>
          <li><a href="http://www.twilio.com/international">International Coverage</a></li>
        </ul>
      </div>
      <div class="col-md-2">
          <h4><a href="http://www.twilio.com/use-cases">Use Cases</a></h4>
          <ul>
            <li><a href="http://www.twilio.com/customers">Customer Stories</a></li>
            <li><a href="http://www.twilio.com/showcase">Showcase</a></li>
            <li><a href="http://www.twilio.com/use-cases/two-factor-authentication">Two-Factor Authentication</a></li>
            <li><a href="http://www.twilio.com/use-cases/appointment-reminders">Appointment Reminders</a></li>
            <li><a href="http://www.twilio.com/use-cases/dispatch-notifications">Dispatch Notifications</a></li>
            <li><a href="http://www.twilio.com/use-cases/eta-alerts">ETA Alerts</a></li>
            <li><a href="http://www.twilio.com/use-cases/automated-surveys">Automated Surveys</a></li>
            <li><a href="http://www.twilio.com/use-cases/masked-phone-numbers">Masked Phone Numbers</a></li>
            <li><a href="http://www.twilio.com/use-cases/visual-estimates">Visual Estimates</a></li>
            <li><a href="http://www.twilio.com/doers">Developer Network</a></li>
            <li><a href="http://www.twilio.com/webinars">Webinars</a></li>
            <li><a href="http://www.twilio.com/white-papers">White Papers</a></li>
          </ul>
      </div>
      <div class="col-md-2">
          <h4><a href="http://www.twilio.com/api">Api &amp; Docs</a></h4>
          <ul>
            <li><a href="http://www.twilio.com/docs/api">API Documentation</a></li>
            <li><a href="http://www.twilio.com/docs/quickstart">Quickstarts</a></li>
            <li><a href="http://www.twilio.com/docs/howto">How Tos</a></li>
            <li><a href="http://www.twilio.com/docs/libraries">Helper Libraries</a></li>
            <li><a href="http://www.twilio.com/docs/security">Security</a></li>
          </ul>
      </div>
    </div>
		<div class="row clear">
			<footer><span>&copy; 2017 Twilio. All rights reserved. <aside>|</aside><a href="http://www.twilio.com/legal/tos">Terms of Service</a><aside>|</aside><a href="http://www.twilio.com/legal/privacy">Privacy Policy</a></span>
			</footer>
		</div>
	</div>
</div>


</div><!-- #page -->

<script type='text/javascript' src='https://s0.wp.com/wp-content/js/devicepx-jetpack.js?ver=201702'></script>







<script type="text/javascript" defer src="https://www.twilio.com/blog/wp-content/cache/autoptimize/js/autoptimize_30cf8936a215677503cd64ef48677239.js"></script></body>

<!-- Mirrored from www.twilio.com/blog/2015/02/building-your-own-personal-assistant-with-twilio-and-google-calendar.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 22:10:00 GMT -->
</html>
