<!DOCTYPE html>
<html lang="en">
  
<!-- Mirrored from stripe.com/docs/recipes/variable-amount-checkout by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 23:48:31 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    
    <meta charset="utf-8">
    <meta name="google-site-verification" content="f0LCrdI6z4Fo8zld4sHCgo5SiUE4EYYRUa6KVeX3Mw8" />
    <meta name="csrf-token" content="S2Juo9URCg60nUr5OQsOywBEeXsT78GTVK7istM2ZFrS-Hre09TOS3nZbub1AzuwKTr3_E9DADMVG-iaduGuKw==">
        <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Supporting a Variable Amount in Checkout</title>

    <meta name="description" content="Stripe is a suite of APIs that powers commerce for businesses of all sizes.">


    <link rel="shortcut icon" href="../../favicon.ico">

    <link rel="apple-touch-icon-precomposed" href="../../img/apple-touch-icon/180x180.png">
    <link rel="icon" href="../../img/apple-touch-icon/180x180.png">


    <link rel="image_src" type="image/png" href="../../img/v3/home/social.png">

    <meta property="og:title" content="Supporting a Variable Amount in Checkout">
    <meta property="og:url" content="variable-amount-checkout.html">
    <meta property="og:description" content="Stripe is a suite of APIs that powers commerce for businesses of all sizes.">
    <meta property="og:image" content="../../img/v3/home/social.png">

      <meta name="twitter:card" content="summary">
      <meta name="twitter:image" content="../../img/v3/home/twitter.png">
    <meta name="twitter:site" content="@stripe">
    <meta name="twitter:title" content="Supporting a Variable Amount in Checkout">
    <meta name="twitter:description" content="Stripe is a suite of APIs that powers commerce for businesses of all sizes.">


    <script type="application/json" id="strut_files">{&quot;v3/shared/navigation_ie10.css&quot;:&quot;/assets/v3/shared/navigation_ie10-ec238f46e7cb9867e3c1b529e2cfa37b.css&quot;}</script>

    

    

    <link rel="stylesheet" href="../../assets/v3/default-ef2bff54073622b9e08cf24466b5668f.css">
    <link rel="stylesheet" href="../../assets/v3/shared/common-d0fb03fa2d48fcf29010779ca9a12b2c.css">
    <link rel="stylesheet" href="../../assets/v3/documentation/base-47c1fd7d3d670e4e08df8f5a67b20dea.css">
    <link rel="stylesheet" href="../../assets/v3/shared/prism_light-6d08c6ec0d72453693d775c3b96629c0.css">
    
    
    <meta name="viewport" content="width=1060">
    <meta name="robots" content="noarchive">
  </head>
  <body class="">
    
    <div id="docs">
      <div id="sidebar">
        <div class="logo">
          <a class="site" href="../../index.html" title="Stripe"></a>
          <a class="extension" href="../../docs.html">docs</a>
        </div>
        <div class="nav-border"></div>
        <nav>
          <h1 class="home"><a href="../../docs.html">Home</a></h1>
          <h1 class="payments"><a class="toggle-content">Payments</a></h1>
<ul class='hidden' data-hidden=true>
    <li>
      <a href="../quickstart.html">Quickstart</a>
    </li>
    <li class="category">Collecting payment details
    </li>
    <li>
      <a href="../checkout/tutorial.html">Checkout</a>
      <ul class='hidden' data-hidden=true>
    <li>
      <a href="../checkout.html">Reference</a>
    </li>
</ul>

    </li>
    <li>
      <a href="../custom-form.html">Stripe.js</a>
      <ul class='hidden' data-hidden=true>
    <li>
      <a href="../stripe.html">Reference</a>
    </li>
</ul>

    </li>
    <li>
      <a href="../mobile/ios.html">iOS</a>
    </li>
    <li>
      <a href="../mobile/android.html">Android</a>
    </li>
    <li class="category">Charges
    </li>
    <li>
      <a href="../charges.html">Creating Charges</a>
    </li>
    <li>
      <a href="../declines.html">Declines &amp; Failed Payments</a>
    </li>
    <li>
      <a href="../disputes.html">Disputes</a>
      <ul class='hidden' data-hidden=true>
    <li>
      <a href="../disputes/evidence.html">Submitting Evidence</a>
    </li>
    <li>
      <a href="../disputes/types.html">Types</a>
    </li>
    <li>
      <a href="../disputes/faq.html">FAQ</a>
    </li>
</ul>

    </li>
    <li class="category">Products &amp; Orders
    </li>
    <li>
      <a href="../orders.html">Orders</a>
      <ul class='hidden' data-hidden=true>
    <li>
      <a href="../orders/guide.html">Guide</a>
    </li>
</ul>

    </li>
    <li>
      <a href="../orders/tax-integration.html">Tax Integrations</a>
    </li>
    <li>
      <a href="../orders/shipping-integration.html">Shipping Integrations</a>
    </li>
    <li>
      <a href="../sources.html">Getting Started</a>
    </li>
    <li>
      <a href="../sources/payment-methods.html">Payment Methods</a>
      <ul class='hidden' data-hidden=true>
    <li>
      <a href="../sources/cards.html">Cards</a>
    </li>
    <li>
      <a href="../sources/3d-secure.html">3D Secure</a>
    </li>
    <li>
      <a href="../sources/bancontact.html">Bancontact</a>
    </li>
    <li>
      <a href="../sources/giropay.html">Giropay</a>
    </li>
    <li>
      <a href="../sources/ideal.html">iDEAL</a>
    </li>
    <li>
      <a href="../sources/sepa-direct-debit.html">SEPA Direct Debit</a>
    </li>
    <li>
      <a href="../sources/sofort.html">Sofort</a>
    </li>
</ul>

    </li>
    <li class="category">Other Payment Methods
    </li>
    <li>
      <a href="../ach.html">ACH</a>
    </li>
    <li>
      <a href="../apple-pay.html">Apple Pay</a>
      <ul class='hidden' data-hidden=true>
    <li>
      <a href="../apple-pay/apps.html">Apple Pay in Apps</a>
    </li>
    <li>
      <a href="../apple-pay/web.html">Apple Pay on the Web</a>
    </li>
</ul>

    </li>
    <li>
      <a href="../alipay.html">Alipay</a>
    </li>
    <li>
      <a href="../bitcoin.html">Bitcoin</a>
    </li>
    <li class='separator'>
      <a href="../testing.html">Testing</a>
    </li>
</ul>

          <h1 class="subscriptions"><a class="toggle-content">Subscriptions</a></h1>
<ul class='hidden' data-hidden=true>
    <li>
      <a href="../subscriptions/quickstart.html">Quickstart</a>
    </li>
    <li>
      <a href="../subscriptions/creating.html">Creating Subscriptions</a>
      <ul data-collapsable=false>
    <li>
      <a href="../subscriptions/discounts.html">Applying Discounts</a>
    </li>
    <li>
      <a href="../subscriptions/trials.html">Using Trial Periods</a>
    </li>
    <li>
      <a href="../subscriptions/quantities.html">Setting Quantities</a>
    </li>
    <li>
      <a href="../subscriptions/taxes.html">Adding Taxes</a>
    </li>
    <li>
      <a href="../subscriptions/multiple.html">Multiple Subscriptions</a>
    </li>
</ul>

    </li>
    <li>
      <a href="../subscriptions/lifecycle.html">Lifecycle &amp; Events</a>
    </li>
    <li>
      <a href="../subscriptions/webhooks.html">Using Webhooks</a>
    </li>
    <li>
      <a href="../subscriptions/changing.html">Changing Subscriptions</a>
      <ul data-collapsable=false>
    <li>
      <a href="../subscriptions/upgrading-downgrading.html">Upgrading &amp; Downgrading</a>
    </li>
    <li>
      <a href="../subscriptions/billing-cycle.html">Billing Cycle</a>
    </li>
    <li>
      <a href="../subscriptions/canceling-pausing.html">Canceling &amp; Pausing</a>
    </li>
</ul>

    </li>
    <li>
      <a href="../subscriptions/invoices.html">Working with Invoices</a>
      <ul data-collapsable=false>
</ul>

    </li>
    <li>
      <a href="../subscriptions/plans.html">Managing Plans</a>
    </li>
    <li>
      <a href="../subscriptions/testing.html">Testing</a>
    </li>
</ul>

          <h1 class="connect"><a class="toggle-content">Connect</a></h1>
<ul class='hidden' data-hidden=true>
    <li>
      <a href="../connect.html">Overview</a>
    </li>
    <li>
      <a href="../connect/connecting-to-accounts.html">Connecting to Accounts</a>
      <ul data-collapsable=false>
    <li>
      <a href="../connect/authentication.html">Authentication</a>
    </li>
</ul>

    </li>
    <li>
      <a href="../connect/standalone-accounts.html">Standalone Accounts</a>
      <ul data-collapsable=false>
    <li>
      <a href="../connect/reference.html">OAuth Reference</a>
    </li>
</ul>

    </li>
    <li>
      <a href="../connect/managed-accounts.html">Managed Accounts</a>
      <ul data-collapsable=false>
    <li>
      <a href="../connect/updating-accounts.html">Updating Accounts</a>
    </li>
    <li>
      <a href="../connect/identity-verification.html">Identity Verification</a>
    </li>
    <li>
      <a href="../connect/required-verification-information.html">Verification Fields</a>
    </li>
    <li>
      <a href="../connect/testing-verification.html">Testing Verification</a>
    </li>
    <li>
      <a href="../connect/bank-transfers.html">Bank Transfers</a>
    </li>
    <li>
      <a href="../connect/migrating.html">Migrating Recipients</a>
    </li>
    <li>
      <a href="../connect/best-practices.html">Best Practices</a>
    </li>
</ul>

    </li>
    <li>
      <a href="../connect/payments-fees.html">Payments and Fees</a>
    </li>
    <li>
      <a href="../connect/special-case-transfers.html">Special-case Transfers</a>
    </li>
    <li class='separator'>
      <a href="../connect/testing.html">Testing</a>
    </li>
</ul>

          <h1 class="relay"><a class="toggle-content">Relay</a></h1>
<ul class='hidden' data-hidden=true>
    <li>
      <a href="../relay.html">Selling in Other Apps</a>
    </li>
    <li>
      <a href="../relay/apps-guide.html">Accepting Orders in Your App</a>
      <ul data-collapsable=false>
    <li>
      <a href="../relay/apps-error-guide.html">Error Handling</a>
    </li>
</ul>

    </li>
</ul>

          <h1 class="radar"><a class="toggle-content">Radar</a></h1>
<ul class='hidden' data-hidden=true>
    <li>
      <a href="../radar.html">Overview</a>
    </li>
    <li>
      <a href="../radar/risk-evaluation.html">Risk Evaluation</a>
    </li>
    <li>
      <a href="../radar/review.html">Review</a>
      <ul data-collapsable=false>
    <li>
      <a href="../radar/review/auth-and-capture.html">Uncaptured Payments</a>
    </li>
</ul>

    </li>
    <li>
      <a href="../radar/rules.html">Rules</a>
      <ul data-collapsable=false>
    <li>
      <a href="../radar/rules/reference.html">Reference</a>
    </li>
</ul>

    </li>
    <li class='separator'>
      <a href="../radar/testing.html">Testing</a>
    </li>
</ul>

          <h1 class="account"><a class="toggle-content">Account</a></h1>
<ul class='hidden' data-hidden=true>
    <li>
      <a href="../dashboard.html">Your Account</a>
    </li>
    <li>
      <a href="../checklist.html">Going Live Checklist</a>
    </li>
    <li>
      <a href="../transfers.html">Getting Paid</a>
    </li>
    <li>
      <a href="../reporting.html">Reporting</a>
    </li>
</ul>

          <h1 class="api"><a class="toggle-content">Development</a></h1>
<ul class='hidden' data-hidden=true>
    <li>
      <a href="../libraries.html">API Libraries</a>
    </li>
    <li>
      <a href="../upgrades.html">API Upgrades</a>
    </li>
    <li>
      <a href="../webhooks.html">Webhooks</a>
    </li>
    <li>
      <a href="../building-integrations.html">Integrations</a>
    </li>
    <li>
      <a href="../recipes.html">Recipes</a>
    </li>
    <li>
      <a href="../security.html">Security</a>
    </li>
</ul>


          <h1 class="references"><a href="../api.html" class="external" target="_blank">API Reference</a></h1>
        </nav>
      </div>
      <div id="content-wrapper" tabindex="0">
        <div class="overlay"></div>
        <header id="main-header">
          <nav>
            <ul class="external">
              <li><a href="https://support.stripe.com/">Support</a></li>

              <li class="button">
                <a data-adroll-segment='submit_two' href="https://dashboard.stripe.com/login">Sign in</a>
              </li>
            </ul>
          </nav>
        </header>
        <article id="content">
          <header>
  <h1>Supporting a Variable Amount in Checkout</h1>
  <p>Add a field to your payments page that enables users to specify the amount to be charged. If you need help after reading this, check out our answers to <a href="https://support.stripe.com/search?q=checkout">common questions</a> or chat live with other developers in <a href="irc://irc.freenode.net/stripe">#stripe</a> on freenode.
</p>
</header>

<section>
  <aside class="note">
    <h3>More recipes</h3>
    <p>Check out our <a href="../recipes.html">other recipes</a> and discover more ways to integrate Stripe.</p>
  </aside>

<p>Stripe <a href="../../checkout.html">Checkout</a> takes care of building an HTML form for securely collecting your customers’ card data. When loading the Checkout modal, you can specify the payment amount presented to the user. In many applications, this amount has already been determined when the page is rendered and is simply included as an attribute on Checkout’s <code>script</code> tag:</p>
<div class="code">
  <pre class="language-html numbered" ><code>&lt;!-- Checkout with $20 amount --&gt;
&lt;script
  src=&quot;https://checkout.stripe.com/checkout.js&quot;
  class=&quot;stripe-button&quot;
  data-amount=&quot;2000&quot;&gt;
&lt;/script&gt;</code></pre>
</div>

<p>However, some applications prefer to let their users specify a specific amount of money to be charged. This is most commonly seen in businesses that  accept donations or empower the user to pay what they think an item is worth. Checkout supports this approach, too, and this recipe walks through a sample implementation:</p>

<ol>
  <li><a href="#form">Create a form</a> with a text field for the donation amount, along with a “Donate” button.</li>
  <li><a href="#javascript">Define a JavaScript handler</a> that validates the user input and launches  Checkout with the user-specified amount.</li>
  <li><a href="#controller">Write a controller</a> on the server that processes the amount and makes the charge.</li>
</ol>

<p>It’s important to note that the JavaScript modifies the amount displayed in Checkout purely for usability purposes. The server-side request to Stripe dictates the actual amount being charged.</p>

<p>This implementation uses <a href="http://rubyonrails.org/">Rails</a>, but the concepts can be easily ported to other languages and frameworks. The JavaScript in this example uses <a href="https://jquery.com/">jQuery</a>.</p></section>

<section>
<h2 id="setup-the-application">Setup the application</h2>

<p>The steps below prepare the scaffolding for a basic payments page. If you already have a payments page, there’s no need to change anything according to these instructions. You can easily adapt the rest of this recipe to your existing implementation.</p>

<p>First, ensure the Stripe gem is in your application’s <code>Gemfile</code>, and then run <code>bundle install</code>. Next, add an initializer that configures the Stripe client library:</p>
<div class="code">
  <nav class="nav-filename icon-file">
    config/initializers/stripe.rb
  </nav>
  <pre class="language-ruby numbered" ><code>Rails.configuration.stripe = {
  :publishable_key =&gt; ENV[&#39;PUBLISHABLE_KEY&#39;],
  :secret_key      =&gt; ENV[&#39;SECRET_KEY&#39;]
}
Stripe.api_key = Rails.configuration.stripe[:secret_key]</code></pre>
</div>

<p>Note that this example uses environment variables for the Stripe API keys. By doing so, sensitive credentials cannot be accidentally submitted to your version control repository. The end of this recipe demonstrates launching the server with values provided for these environment variables.</p>

<p>Then, generate a new <code>Charges</code> controller:</p>
<div class="code">
  <nav class="nav-filename icon-terminal">
    Terminal
  </nav>
  <pre class="language-bash numbered" ><code>rails g controller charges new create</code></pre>
</div>

<p>This creates a few files, depending on your setup. For this recipe, the files you’ll be working with are:</p>

<ul>
  <li><code>app/controllers/charges_controller.rb</code></li>
  <li><code>app/views/charges/new.html.erb</code></li>
  <li><code>app/views/charges/create.html.erb</code></li>
</ul>

<p>Last, edit <code>routes.rb</code>, replacing any Rails-generated routes for <code>charges</code> with:</p>
<div class="code">
  <nav class="nav-filename icon-terminal">
    Terminal
  </nav>
  <pre class="language-ruby numbered" ><code>resources :charges</code></pre>
</div>
</section>

<section>
<h2 id="form">Create the payment form and the confirmation page</h2>

<p>The application requires two view files. The first is the payments page, containing the form in which the user specifies the donation amount and a button that ultimately launches Checkout. The second view is a basic confirmation page the user is redirected to after completing the payment. Once the views are in place, you’ll proceed to adding the JavaScript to properly communicate the donation amount to Checkout.</p>

<p>As a point of reference, for applications with a fixed payment amount, a basic Checkout page might be:</p>
<div class="code">
  <pre class="language-erb numbered" ><code>&lt;!-- Example Checkout page that *does not* support a variable amount! --&gt;
&lt;%= form_tag charges_path do %&gt;
  &lt;div id=&quot;error_explanation&quot;&gt;
    &lt;% if flash[:error].present? %&gt;
      &lt;p&gt;&lt;%= flash[:error] %&gt;&lt;/p&gt;
    &lt;% end %&gt;
  &lt;/div&gt;
  &lt;article&gt;
    &lt;label class=&quot;amount&quot;&gt;
      &lt;span&gt;Amount: &lt;%= number_to_currency(@amount * 100) %&gt;&lt;/span&gt;
    &lt;/label&gt;
  &lt;/article&gt;
  &lt;script src=&quot;https://checkout.stripe.com/checkout.js&quot; class=&quot;stripe-button&quot;
  data-key=&quot;&lt;%= Rails.configuration.stripe[:publishable_key] %&gt;&quot;
  data-description=&quot;One-time donation&quot;
  data-amount=&quot;&lt;%= @amount %&gt;&quot;
  data-locale=&quot;auto&quot;&gt;&lt;/script&gt;
&lt;% end %&gt;</code></pre>
</div>

<p>Note that the page is rendered with a known amount, <code>@amount</code>, that is also the provided value for the <code>data-amount</code> attribute in the Checkout <code>script</code> tag. This enables the Checkout modal to display the amount to the user as they’re entering their card details. Note also that the Checkout script is responsible for rendering a button on the form.</p>

<p>For this donation example, two immediate changes are required:</p>

<ul>
  <li>You want a text field where the user can specify an amount to donate.</li>
  <li>You don’t want Checkout to render a button on the page. Instead, you’ll have your own “Donate” button. This way, when the user clicks the “Donate” button, you can run some JavaScript that verifies the user’s input and then launches the Checkout modal.</li>
</ul>

<p>With those changes in mind, begin your form in <code>new.html.erb</code>:</p>
<div class="code">
  <nav class="nav-filename icon-file">
    app/views/charges/new.html.erb
  </nav>
  <pre class="language-erb numbered" ><code>&lt;%= form_tag charges_path do %&gt;
  &lt;div id=&quot;error_explanation&quot;&gt;
    &lt;% if flash[:error].present? %&gt;
      &lt;p&gt;&lt;%= flash[:error] %&gt;&lt;/p&gt;
    &lt;% end %&gt;
  &lt;/div&gt;
  &lt;article&gt;
    &lt;%= label_tag(:amount, &#39;Donation Amount:&#39;) %&gt;
    &lt;%= text_field_tag(:amount) %&gt;
  &lt;/article&gt;
  &lt;article&gt;
    &lt;%= hidden_field_tag(:stripeToken) %&gt;
  &lt;/article&gt;
  &lt;button id=&#39;donateButton&#39;&gt;Donate&lt;/button&gt;
&lt;% end %&gt;</code></pre>
</div>

<p>Along with the two changes already mentioned, there’s a new hidden field called <code>stripeToken</code>. The hidden field is how the <code>stripeToken</code> generated by Checkout is submitted to your server. Your JavaScript will set this field after Checkout has collected the user’s payment information and received the token from Stripe.</p>

<p>Now add the code for the other view, <code>create.html.erb</code>: the donation confirmation page. You can use the handy Rails helper <code>number_to_currency()</code> to format the amount, converting it from Stripe-compatible cents into human-friendly dollars:</p>
<div class="code">
  <nav class="nav-filename icon-file">
    app/views/charges/create.html.erb
  </nav>
  <pre class="language-erb numbered" ><code>&lt;h2&gt;Thank you!&lt;/h2&gt;
&lt;p&gt;Your donation of &lt;strong&gt;&lt;%= number_to_currency(@amount * 0.01) %&gt;&lt;/strong&gt;
 has been received.&lt;/p&gt;</code></pre>
</div>
</section>

<section>
<h2 id="javascript">Define the JavaScript</h2>

<p>The first bit of JavaScript to add to the payment view configures basic Checkout functionality. You can give Checkout a function to call after the user has entered their payment information. This callback sets the <code>stripeToken</code> field on the form and submits the form to the server.</p>

<p>Add a <code>script</code> tag to include the Checkout library as well as your custom JavaScript to the bottom of <code>new.html.erb</code>. This should go after the <code>end</code> tag for the form. Write the <code>StripeCheckout</code> handler first:</p>
<div class="code">
  <nav class="nav-filename icon-file">
    app/views/charges/new.html.erb
  </nav>
  <pre class="language-erb numbered" ><code>&lt;script src=&quot;https://checkout.stripe.com/checkout.js&quot;&gt;&lt;/script&gt;

&lt;script&gt;
var handler = StripeCheckout.configure({
  key: &#39;&lt;%= Rails.configuration.stripe[:publishable_key] %&gt;&#39;,
  locale: &#39;auto&#39;,
  name: &#39;Sand Castles United&#39;,
  description: &#39;One-time donation&#39;,
  token: function(token) {
    $(&#39;input#stripeToken&#39;).val(token.id);
    $(&#39;form&#39;).submit();
  }
});
&lt;/script&gt;</code></pre>
</div>

<p>The <code>handler</code> object is configured with a few options, including your public API key and a callback for the token. See the <a href="../checkout.html#integration-custom-options">Checkout docs</a> for a comprehensive list of all available configuration options.</p>

<p>Next, clicking the “Donate” button needs to call a JavaScript function that verifies the user-specified amount. If the amount is valid, the function launches Checkout, passing in the amount. Still within the <code>script</code> tags, add the following click handler (explained below):</p>
<div class="code">
  <nav class="nav-filename icon-file">
    app/views/charges/new.html.erb
  </nav>
  <pre class="language-javascript numbered" ><code>$(&#39;#donateButton&#39;).on(&#39;click&#39;, function(e) {
  e.preventDefault();

  $(&#39;#error_explanation&#39;).html(&#39;&#39;);

  var amount = $(&#39;input#amount&#39;).val();
  amount = amount.replace(/\$/g, &#39;&#39;).replace(/\,/g, &#39;&#39;)

  amount = parseFloat(amount);

  if (isNaN(amount)) {
    $(&#39;#error_explanation&#39;).html(&#39;&lt;p&gt;Please enter a valid amount in USD ($).&lt;/p&gt;&#39;);
  }
  else if (amount &lt; 5.00) {
    $(&#39;#error_explanation&#39;).html(&#39;&lt;p&gt;Donation amount must be at least $5.&lt;/p&gt;&#39;);
  }
  else {
    amount = amount * 100; // Needs to be an integer!
    handler.open({
      amount: Math.round(amount)
    })
  }
});</code></pre>
</div>

<p>First, an event handler is added to <code>#donateButton</code>. When that button is clicked, the function calls <code>preventDefault()</code> on the event to halt the form’s submission. Remember, you want Checkout to collect the user’s payment information and set the <code>stripeToken</code> <em>before</em> the form is submitted.</p>

<p>The user’s input is then verified:</p>

<ul>
  <li>Any dollar signs or commas are removed</li>
  <li><code>parseFloat()</code> then attempts to convert the string into a float</li>
  <li>If conversion to a float fails (by returning <code>NaN</code>), <code>#error_explanation</code> is set to inform the user</li>
</ul>

<p>Note that this verification has some flexibility: <strong>7</strong>, <strong>07</strong> and <strong>7.00</strong> are all treated as $7.</p>

<p>This example also enforces a minimum donation amount of $5.00. This is not required, but as a minimum of $0.50 is needed for a Stripe charge, you will want to enforce a minimum of at least that amount in your implementation.</p>

<p>Note that this code assumes a user-specified amount in US dollars. Applications in other countries or with international audiences will want to consider other strategies, discussed at the end of this recipe.</p>

<p>The Checkout modal is opened with <code>handler.open()</code>. It’s now dynamically provided with an amount, converted to integer cents, as required by Checkout.</p>

<p>Finally, still within the <code>script</code> tag and right below the click handler, add an event handler for <code>popstate</code>. This ensures the Checkout modal is closed should the user attempt to navigate away from the page:</p>
<div class="code">
  <nav class="nav-filename icon-file">
    app/views/new.html.erb
  </nav>
  <pre class="language-javascript numbered" ><code>// Close Checkout on page navigation
$(window).on(&#39;popstate&#39;, function() {
  handler.close();
});</code></pre>
</div>

<p>With the views and client-side code prepared, you can now turn your attention to setting up the server.</p></section>

<section>
<h2 id="controller">Write the controller</h2>

<p>After the user has completed Checkout, the form will be submitted to the server with the parameters <code>amount</code> and <code>stripeToken</code>. At this point, you want to process and verify the user-specified <code>amount</code> once more server-side, using the same logic as in the JavaScript.</p>

<p>Add the following methods to <strong>charges_controller.rb</strong>:</p>
<div class="code">
  <nav class="nav-filename icon-file">
    app/controllers/charges_controller.rb
  </nav>
  <pre class="language-ruby numbered" ><code>def new
end

def create
  @amount = params[:amount]

  @amount = @amount.gsub(&#39;$&#39;, &#39;&#39;).gsub(&#39;,&#39;, &#39;&#39;)

  begin
    @amount = Float(@amount).round(2)
  rescue
    flash[:error] = &#39;Charge not completed. Please enter a valid amount in USD ($).&#39;
    redirect_to new_charge_path
    return
  end

  @amount = (@amount * 100).to_i # Must be an integer!

  if @amount &lt; 500
    flash[:error] = &#39;Charge not completed. Donation amount must be at least $5.&#39;
    redirect_to new_charge_path
    return
  end

  Stripe::Charge.create(
    :amount =&gt; @amount,
    :currency =&gt; &#39;usd&#39;,
    :source =&gt; params[:stripeToken],
    :description =&gt; &#39;Custom donation&#39;
  )

  rescue Stripe::CardError =&gt; e
    flash[:error] = e.message
    redirect_to new_charge_path
  end
end</code></pre>
</div>

<p>Here the amount submitted to the server is processed in the same manner as in the JavaScript. Parsing the string using <code>Float()</code> raises errors if the string has any non-numeric characters. Again, the minimum donation amount of $5.00 or 500 cents is enforced. If the amount fails any of these checks, the charge is not made and the user is alerted to the problem. Otherwise, the charge is completed.</p>

<p>It’s important that these validations are repeated on the server in case the user has manipulated or bypassed your JavaScript validations. It is also necessary to ensure your parsing and validation logic are robust. You want your client logic to come to the same conclusion as your server logic as to what the user should be charged. JavaScript’s <code>parseFloat()</code> function is fairly lenient, but Ruby’s <code>Float()</code> function is strict. Having this strictness on the server ensures input with ambiguity (like <strong>‘5 5’</strong>) is rejected before a charge is made.</p>

<p>With everything in place, you’re ready to test your solution. Remember to boot your app with your Stripe credentials:</p>
<div class="code">
  <nav class="nav-filename icon-terminal">
    Terminal
  </nav>
  <pre class="language-bash numbered" ><code>PUBLISHABLE_KEY=pk_test_6pRNASCoBOKtIshFeQd4XMUh \\
SECRET_KEY=sk_test_BQokikJOvBiI2HlWgH4olfQ2 bundle exec rails s</code></pre>
</div>

<p>We’ve placed random API keys in the code. Replace these with your <a href="https://dashboard.stripe.com/account/apikeys">actual API keys</a> to test this code for yourself.</p>

<p>Then you can find your payments page in your web browser at <strong>http://localhost:3000/charges/new</strong>.</p></section>

<section>
<h2 id="advanced-features">Advanced features</h2>

<p>The recipe to this point explains all the basic functionality needed to accept user-defined payments through Checkout. As always, there are ways you can improve upon this approach.</p>

<h3 id="supporting-multiple-currencies">Supporting multiple currencies</h3>

<p>The validation and parsing logic above assumes the payment being made is in US dollars. It ignores the dollar symbol ($) and the digit group separator used in the US (the comma). Should your payment form accept a different currency, you may need to modify this logic.</p>

<p>If you’d like to support multiple currencies, one solution is to add a drop-down currency selector next to the amount input field. The currency selected in this drop-down would then be considered both by JavaScript and the server, perhaps using a switch statement to determine what parsing and validation logic to use. When launching Checkout, you would then pass in the parameter <code>currency</code>. This is the 3-letter ISO code for the currency. For more information about this parameter and other configuration options for Checkout, see the <a href="../checkout.html#integration-custom-options">Checkout documentation</a>.</p>

<h3 id="supporting-coupons">Supporting coupons</h3>

<p>Another situation wherein you might dynamically change the amount displayed in Checkout is if you have your own coupon system. We have a <a href="coupons-for-charges.html">detailed recipe</a> on supporting coupons for standalone charges. However, the solution in that recipe modifies only the server’s charge request and not the amount displayed in Checkout to the user.</p>

<p>Using the concepts from this recipe, you could use JavaScript to validate a user-submitted coupon code by making an Ajax request to an endpoint on the server, such as <strong>/coupons</strong>. The endpoint would return a discount percentage, and the JavaScript would then launch Checkout with the appropriate, discounted amount.</p>

<h3 id="localizing-error-messages">Localizing error messages</h3>

<p>Checkout supports <a href="https://support.stripe.com/questions/what-languages-does-stripe-checkout-support">localization in multiple languages</a> whereas the error messages generated by this application are only in English. If your site has a multilingual audience, you’ll want to localize the application’s error messages, too, for a better user experience.</p></section>


          <footer>
  <h2>Questions?</h2>
  <p>We're always happy to help with code or other questions you might have! <a href="https://support.stripe.com/">Search</a> our site for more information, <a href="https://support.stripe.com/email">send us an email</a>, or <a href="../../contact/sales.html">get in touch</a> with our sales team!</p>
</footer>

        </article>
      </div>
    </div>

    <div id="loading-bar"></div>

    <script src="../../assets/external/jquery.min-94df374d2ad5d02ae136584dc008fb1c.js"></script>
    <script src="../../assets/prism-aa9f4cb7aff3f31b5394455bcbea0d8b.js"></script>
    <script src="../../assets/external/dynamics.min-14579f80273a61e6d0f4f45484e20dc7.js"></script>
    <script src="../../assets/jquery.cookie-d7482a1bbfda18d981eda4398666acdd.js"></script>
    <script src="../../assets/documentation-84c208e01668170139f2f511cfc37644.js"></script>
    <script>
      parseKey("sk_test_BQokikJOvBiI2HlWgH4olfQ2", "secret-key", null);
      parseKey("pk_test_6pRNASCoBOKtIshFeQd4XMUh", "publishable-key", null);
    </script>
      <script type="text/javascript" src="https://js.stripe.com/v2/"></script>

    
    <script src="../../assets/config-aead70c07cdca45cec67e4141bf18edc.js"></script>
    
<script type="application/json" id="analytics_config">{&quot;mixpanel&quot;:{&quot;identifier&quot;:&quot;eb71b6171a4f7ed97de9b7a0395b7ca5&quot;},&quot;ga&quot;:{},&quot;trackpage&quot;:true}</script>

<script src="https://js.stripe.com/internal/v2/analytics.min.js"></script>
<script src="../../assets/analytics-e800ab0ba76de2b697ea3f61c673695b.js"></script>
<script src="https://js.stripe.com/v2/m.js"></script>
<script src="../../assets/mirador_ping-6bba7d3d9fbb1e991b7f0f8fab43b2b1.js"></script>

    <script type="text/javascript">
    if ('Analytics' in window) {
      Analytics.viewed("docs", {
        docs_version: "2",
      });
    }
    </script>
  </body>

<!-- Mirrored from stripe.com/docs/recipes/variable-amount-checkout by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 23:48:31 GMT -->
</html>
